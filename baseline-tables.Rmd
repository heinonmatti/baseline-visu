---
title: "Tables and estimators"
---

# Introduction

This section describes how confidence intervals were estimated, as well as presenting numeric tables of characteristics of all variables involved.

```{r setup, verbose = FALSE, warning = FALSE, message = FALSE}
source("baseline-datasetup.R")

# summarytools::view(summarytools::dfSummary(df), file = "./codebook_concise.html")

```

# Means with CIs taking clustering into account 

The code chunks create linear models for all variables. The results are used to estimate confidence intervals and intra-class correlations (ICC).

The CIs are calculated with a multilevel model, accounting for school and classroom membership.

```{r multilevel-clusters}
# Create a vector with all names of the variables we want. Exclude T3 variables.
names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
m_p <- NA
ci_low <- NA
ci_high <- NA
ICC_group <- NA
ICC_School <- NA
nonmissings <- NA

## # Use this to test a single variable:
## dftest <- df #%>% na.omit()
## m <- lme4::lmer(mvpaAccelerometer_T1 ~ (1|school) + (1|group), data=dftest)
## mean <- lme4::fixef(m)
## m_p <- profile(m, which = "beta_")
## ci_low <- confint(m_p)[, 1]
## ci_high <- confint(m_p)[, 2]
## ICC_group <- sjstats::icc(m)[1]
## ICC_School <- sjstats::icc(m)[2]
## nonmissings <- length(m@resp$y)


# # UNCOMMENT below and run code

# for (i in names){ # Loop over each variable name for all participants, extract statistics
# m <- lme4::lmer(paste0(i," ~ (1|school) + (1|group)"), data=df)
# mean[i] <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low[i] <- confint(m_p)[, 1]
# ci_high[i] <- confint(m_p)[, 2]
# ICC_group[i] <- sjstats::icc(m)[1]
# ICC_School[i] <- sjstats::icc(m)[2]
# nonmissings[i] <- length(m@resp$y)
# }
#
# vardatatable <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1) %>% format(., nsmall = 1),
#   "CI95" = paste(round(ci_low, 1) %>% format(., nsmall = 1), " - ", round(ci_high, 1) %>% format(., nsmall = 1)),
#   "ICC class" =ifelse(round(ICC_group, 3) == 0, "< 0.001", round(ICC_group, 3) %>% format(., nsmall = 3)),
#   "ICC school" = ifelse(round(ICC_School, 3) == 0, "< 0.001", round(ICC_School, 3) %>% format(., nsmall = 3)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") %>% #remove first row, which is empty
#   as.data.frame()
#
# ci_total <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
#
# # To improve readability, change the variables which are expressed in minutes, to the form "Xh Ymin"
# timeVariables <- c("mvpaAccelerometer", "mpaAccelerometer", "vpaAccelerometer", "lpaAccelerometer", "weartimeAccelerometer", "sitLieAccelerometer", "standingAccelerometer", "mvpaAccelerometer_noCutOff", "mpaAccelerometer_noCutOff", "vpaAccelerometer_noCutOff", "lpaAccelerometer_noCutOff", "weartimeAccelerometer_noCutOff", "sitLieAccelerometer_noCutOff", "standingAccelerometer_noCutOff")
#
# for (variableToChange in timeVariables) {
# originalMean <- vardatatable[vardatatable$Variable == variableToChange, "Mean"] %>% as.numeric()
# newMean <- paste0(floor(originalMean/60), "h ", round(originalMean, 0) %% 60, "min")
# vardatatable[vardatatable$Variable == variableToChange, "Mean"] <- newMean
# originalCI <- vardatatable[vardatatable$Variable == variableToChange, "CI95"]
# originalCIL <- stringi::stri_extract_first_words(originalCI) %>% as.numeric()
# originalCIH <- stringi::stri_extract_last_words(originalCI) %>% as.numeric()
# newCI <- paste0(floor(originalCIL/60), "h ", round(originalCIL, 0) %% 60, "min - ",
#                 floor(originalCIH/60), "h ", round(originalCIH, 0) %% 60, "min")
# vardatatable[vardatatable$Variable == variableToChange, "CI95"] <- newCI
# }
#
# save(vardatatable, file = "./Rdata_files/vardatatable.Rdata")
# save(ci_total, file = "./Rdata_files/ci_total.Rdata")
load("./Rdata_files/vardatatable.Rdata")
load("./Rdata_files/ci_total.Rdata")

```

```{r primary-outcome-vars-table-total, results = 'asis'}

vardatatable2 <- vardatatable
vardatatable2$Variable <- gsub("mvpaAccelerometer", "Daily moderate-to-vigorous PA time (accelerometer)*", vardatatable2$Variable)
vardatatable2$Variable <- gsub("padaysLastweek", "Number of days with >30 MVPA min previous week (self-report)*", vardatatable2$Variable)
vardatatable2$Variable <- gsub("sitLieAccelerometer", "Daily time spent sitting or lying down (accelerometer)*", vardatatable2$Variable)
vardatatable2$Variable <- gsub("sitBreaksAccelerometer", "Daily number of times sitting was interrupted (accelerometer)*", vardatatable2$Variable)
vardatatable2$Variable <- gsub("lpaAccelerometer", "Daily light PA time (accelerometer)", vardatatable2$Variable)
vardatatable2$Variable <- gsub("standingAccelerometer", "Daily standing time (accelerometer)", vardatatable2$Variable)

vardatatable2 <- vardatatable2 %>% 
  dplyr::filter(Variable == "Daily moderate-to-vigorous PA time (accelerometer)*" | 
           Variable == "Daily time spent sitting or lying down (accelerometer)*" |
           Variable == "Daily number of times sitting was interrupted (accelerometer)*" |
           Variable == "Number of days with >30 MVPA min previous week (self-report)*" |
           Variable == "Daily light PA time (accelerometer)" |
           Variable == "Daily standing time (accelerometer)") %>% 
  dplyr::mutate(orderVariable = ifelse(`Variable` == "Daily moderate-to-vigorous PA time (accelerometer)*", "a",
                                ifelse(`Variable` == "Daily light PA time (accelerometer)", "b",
                                ifelse(`Variable` == "Daily standing time (accelerometer)", "c",
                                ifelse(`Variable` == "Daily time spent sitting or lying down (accelerometer)*", "d",
                                ifelse(`Variable` == "Daily number of times sitting was interrupted (accelerometer)*", "e",
                                ifelse(`Variable` == "Number of days with >30 MVPA min previous week (self-report)*", "f", NA))))))) %>% 
  dplyr::arrange(orderVariable) %>% 
  dplyr::select(-orderVariable)

vardatatable2 %>% 
    papaja::apa_table(
        caption = "Primary outcome variables with their class and school ICCs. Primary outcome variables highlighted with asterisks.",
        escape = TRUE, format.args = list(digits = c(3, 0), margin = 2)
        )
```

<a id="variables-with-icc"></a>

## All main variables, their means, CIs and ICCs.

Values calculated with a multilevel model accounting for school and classroom.

```{r allvars-total, results = 'asis'}

vardatatable %>%
   DT::datatable( #papaja::apa_table(
        caption = "All variables with their class and school ICCs (values calculated with a multilevel model accounting for school and classroom)",
        escape = TRUE #, format.args = list(digits = c(1, 3, 0), margin = 2)
   )

```

## Assorted tables with ICCs {.tabset}

### Description

**See tabs above for differently sorted tables** 

### Model with school and class: ICC top 20 items, sorted by classroom ICC

```{r icc-school-class-sortbyclass, results = 'asis'}

vardatatable %>% 
  dplyr::select(Variable, `ICC class`, `ICC school`, n) %>% 
  arrange(desc(`ICC class`)) %>% slice(1:20) %>% 
  as.tbl() %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by classroom ICC",
        format.args = list(digits = c(3, 0), margin = 2))

```

### Model with school and class: ICC top 20 items, sorted by school ICC

```{r icc-school-class-sortbyschool, results = 'asis'}

vardatatable %>% dplyr::select(Variable, `ICC class`, `ICC school`, n) %>% 
  arrange(desc(`ICC school`)) %>% 
  slice(1:20) %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by school ICC",
        format.args = list(digits = c(3, 0), margin = 2))

```

## Model with school, class and educational track {.tabset}

The model below is the same as the one above, except it adds educational track. 

```{r multilevel-edutrack-school-group}
#library(sjstats)
#library(lme4)

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
m_p <- NA
ci_low <- NA
ci_high <- NA
ICC_group <- NA
ICC_School <- NA
nonmissings <- NA
ICC_track <- NA


## To test the code with a single variable:
# dftest <- df #%>% na.omit()
# m <- lme4::lmer(sitLieAccelerometer_T1 ~ (1|school) + (1|group) + (1|track), data=df)
# mean <- lme4::fixef(m)
# m_p <- profile(m)
# ci_low <- confint(m_p)[5]
# ci_high <- confint(m_p)[10]
# ICC_group <- icc(m)[1]
# ICC_School <- icc(m)[2]
# nonmissings <- length(m@resp$y)

# # UNCOMMENT below and run code

# for (i in names){ # Loop over each variable name for all participants, extract statistics
# m <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + (1|track)"), data=df)
# mean[i] <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low[i] <- confint(m_p)[1]
# ci_high[i] <- confint(m_p)[2]
# ICC_group[i] <- sjstats::icc(m)[1]
# ICC_School[i] <- sjstats::icc(m)[3]
# ICC_track[i] <- sjstats::icc(m)[2]
# nonmissings[i] <- length(m@resp$y)
# }
# 
# vardatatable_containing_edutrack <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1) %>% format(., nsmall = 1),
#   "CI95" = paste(round(ci_low, 1) %>% format(., nsmall = 1), " - ", round(ci_high, 1) %>% format(., nsmall = 1)),
#   "ICC class" =ifelse(round(ICC_group, 3) == 0, "< 0.001", round(ICC_group, 3) %>% format(., nsmall = 3)),
#   "ICC school" = ifelse(round(ICC_School, 3) == 0, "< 0.001", round(ICC_School, 3) %>% format(., nsmall = 3)),
#   "ICC educational track" = ifelse(round(ICC_track, 3) == 0, "< 0.001", round(ICC_track, 3) %>% format(., nsmall = 3)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# ci_edutrack <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# # To improve readability, change the variables which are expressed in minutes, to the form "Xh Ymin"
# timeVariables <- c("mvpaAccelerometer", "mpaAccelerometer", "vpaAccelerometer", "lpaAccelerometer", "weartimeAccelerometer", "sitLieAccelerometer", "standingAccelerometer", "mvpaAccelerometer_noCutOff", "mpaAccelerometer_noCutOff", "vpaAccelerometer_noCutOff", "lpaAccelerometer_noCutOff", "weartimeAccelerometer_noCutOff", "sitLieAccelerometer_noCutOff", "standingAccelerometer_noCutOff")
# 
# for (variableToChange in timeVariables) {
# originalMean <- vardatatable_containing_edutrack[vardatatable_containing_edutrack$Variable == variableToChange, "Mean"] %>% as.numeric()
# newMean <- paste0(floor(originalMean/60), "h ", round(originalMean, 0) %% 60, "min")
# vardatatable_containing_edutrack[vardatatable_containing_edutrack$Variable == variableToChange, "Mean"] <- newMean
# originalCI <- vardatatable_containing_edutrack[vardatatable_containing_edutrack$Variable == variableToChange, "CI95"]
# originalCIL <- stringi::stri_extract_first_words(originalCI) %>% as.numeric()
# originalCIH <- stringi::stri_extract_last_words(originalCI) %>% as.numeric()
# newCI <- paste0(floor(originalCIL/60), "h ", round(originalCIL, 0) %% 60, "min - ",
#                 floor(originalCIH/60), "h ", round(originalCIH, 0) %% 60, "min")
# vardatatable_containing_edutrack[vardatatable_containing_edutrack$Variable == variableToChange, "CI95"] <- newCI
# }
# 
# save(vardatatable_containing_edutrack, file = "./Rdata_files/vardatatable_containing_edutrack.Rdata")
# save(ci_edutrack, file = "./Rdata_files/ci_edutrack.Rdata")
load("./Rdata_files/vardatatable_containing_edutrack.Rdata")
load("./Rdata_files/ci_edutrack.Rdata")

```

### Main table

```{r}

vardatatable_containing_edutrack %>% 
  DT::datatable(caption = "Values calculated with a multilevel model accounting for school, classroom and educational track")

```

### Model with school, class and track: Top 20 items, sorted by school

```{r icc-school-class-track-sortbyschool, results = 'asis'}

vardatatable_containing_edutrack %>% 
  dplyr::select(Variable, `ICC educational track`, `ICC class`, `ICC school`, n) %>% 
  arrange(desc(`ICC school`)) %>% 
  top_n(20) %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by school ICC",
        format.args = list(digits = c(0), margin = 2))

```

### Model with school, class and track: Top 20 items, sorted by classroom

```{r icc-school-class-track-sortbyclass, results = 'asis'}

vardatatable_containing_edutrack %>% dplyr::select(Variable, `ICC educational track`, `ICC class`, `ICC school`, n) %>% arrange(desc(`ICC class`)) %>% top_n(20) %>% papaja::apa_table(caption = "Intra-class correlations sorted by classroom ICC",
        format.args = list(digits = c(0), margin = 2))

```

### Model with school, class and track: Top 20 items, sorted by educational track

```{r icc-school-class-track-sortbytrack, results = 'asis'}

vardatatable_containing_edutrack %>% dplyr::select(Variable, `ICC educational track`, `ICC class`, `ICC school`, n) %>% arrange(desc(`ICC educational track`)) %>% top_n(20) %>% papaja::apa_table(caption = "Intra-class correlations sorted by educational track ICC",
        format.args = list(digits = c(0), margin = 2))

```

## Model with educational track only {.tabset}

```{r parameters-multilevel-edutrack-only}
#library(sjstats)
#library(lme4)

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
m_p <- NA
ci_low <- NA
ci_high <- NA
ICC_group <- NA
ICC_School <- NA
nonmissings <- NA
ICC_track <- NA


## To test the code with a single variable:
# dftest <- df #%>% na.omit()
# m <- lme4::lmer(sitLieAccelerometer_T1 ~ (1|track), data=df)
# mean <- lme4::fixef(m)
# m_p <- profile(m)
# ci_low <- confint(m_p)[3]
# ci_high <- confint(m_p)[6]
# ICC_group <- sjstats::icc(m)[1]
# nonmissings <- length(m@resp$y)

# # UNCOMMENT below and run code

# for (i in names){ # Loop over each variable name for all participants, extract statistics
# m <- lme4::lmer(paste0(i," ~ (1|track)"), data=df)
# mean[i] <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low[i] <- confint(m_p)[1]
# ci_high[i] <- confint(m_p)[2]
# ICC_track[i] <- sjstats::icc(m)[1]
# nonmissings[i] <- length(m@resp$y)
# }
# 
# vardatatable_edutrack_only <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1) %>% format(., nsmall = 1),
#   "CI95" = paste(round(ci_low, 1) %>% format(., nsmall = 1), " - ", round(ci_high, 1) %>% format(., nsmall = 1)),
#   "ICC educational track" = ifelse(round(ICC_track, 3) == 0, "< 0.001", round(ICC_track, 3) %>% format(., nsmall = 3)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# ci_edutrack_only <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# # To improve readability, change the variables which are expressed in minutes, to the form "Xh Ymin"
# timeVariables <- c("mvpaAccelerometer", "mpaAccelerometer", "vpaAccelerometer", "lpaAccelerometer", "weartimeAccelerometer", "sitLieAccelerometer", "standingAccelerometer", "mvpaAccelerometer_noCutOff", "mpaAccelerometer_noCutOff", "vpaAccelerometer_noCutOff", "lpaAccelerometer_noCutOff", "weartimeAccelerometer_noCutOff", "sitLieAccelerometer_noCutOff", "standingAccelerometer_noCutOff")
# 
# for (variableToChange in timeVariables) {
# originalMean <- vardatatable_edutrack_only[vardatatable_edutrack_only$Variable == variableToChange, "Mean"] %>% as.numeric()
# newMean <- paste0(floor(originalMean/60), "h ", round(originalMean, 0) %% 60, "min")
# vardatatable_edutrack_only[vardatatable_edutrack_only$Variable == variableToChange, "Mean"] <- newMean
# originalCI <- vardatatable_edutrack_only[vardatatable_edutrack_only$Variable == variableToChange, "CI95"]
# originalCIL <- stringi::stri_extract_first_words(originalCI) %>% as.numeric()
# originalCIH <- stringi::stri_extract_last_words(originalCI) %>% as.numeric()
# newCI <- paste0(floor(originalCIL/60), "h ", round(originalCIL, 0) %% 60, "min - ",
#                 floor(originalCIH/60), "h ", round(originalCIH, 0) %% 60, "min")
# vardatatable_edutrack_only[vardatatable_edutrack_only$Variable == variableToChange, "CI95"] <- newCI
# }
# 
# save(vardatatable_edutrack_only, file = "./Rdata_files/vardatatable_edutrack_only.Rdata")
# save(ci_edutrack_only, file = "./Rdata_files/ci_edutrack_only.Rdata")
load("./Rdata_files/vardatatable_edutrack_only.Rdata")
load("./Rdata_files/ci_edutrack_only.Rdata")


```

### Main table 

```{r datatable-edutrack-only}

vardatatable_edutrack_only %>% 
  DT::datatable(caption = "Values calculated with a multilevel model accounting for educational track only")

```

### Model with educational track only: Top 20 items, sorted by ICC educational track

```{r icc-edu-track-only, results = 'asis'}

vardatatable_edutrack_only %>% 
  dplyr::select(Variable, `ICC educational track`, n) %>% 
  arrange(desc(`ICC educational track`)) %>% 
  top_n(20) %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by educational track ICC",
        format.args = list(digits = c(0), margin = 2))

```

## Calculating CIs using the sandwich estimator

```{r table-parameters-sandwich}
# Basic instructions are from https://web.archive.org/web/20180206180739/http://thestatsgeek.com/2014/02/14/the-robust-sandwich-variance-estimator-for-linear-regression-using-r/

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
sandwich_se <- NA
mean <- NA
ci_low <- NA
ci_high <- NA
nonmissings <- NA

## To test the code with a single variable:
# df_for_sandwich <- df %>% dplyr::select(group, school, track, sitLieAccelerometer_T1) %>% na.omit()
# sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track)
# m <- lm(sitLieAccelerometer_T1 ~ 1, data=df_for_sandwich)
# sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5
# mean <- m$coefficients[[1]]
# ci_low <- coef(m) - 1.96 * sandwich_se
# ci_high <- coef(m) + 1.96 * sandwich_se
# nonmissings <- nrow(m$model)


# # UNCOMMENT below and run code

# for (i in names){ # Loop over each variable name for all participants, extract statistics
# df_for_sandwich <- df %>% dplyr::select(
#   group, school, track, i) %>%
#   na.omit()
# sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track)
# m <- lm(paste0(i," ~ 1"), data = df_for_sandwich)
# sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5
# mean[i] <- m$coefficients[[1]]
# ci_low[i] <- coef(m) - 1.96 * sandwich_se
# ci_high[i] <- coef(m) + 1.96 * sandwich_se
# nonmissings[i] <- nrow(m$model)
# }
# 
# vardatatable_sandwich <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1) %>% format(., nsmall = 1),
#   "CI95" = paste(round(ci_low, 1) %>% format(., nsmall = 1), " - ", round(ci_high, 1) %>% format(., nsmall = 1)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# ci_sandwich <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# # To improve readability, change the variables which are expressed in minutes, to the form "Xh Ymin"
# timeVariables <- c("mvpaAccelerometer", "mpaAccelerometer", "vpaAccelerometer", "lpaAccelerometer", "weartimeAccelerometer", "sitLieAccelerometer", "standingAccelerometer", "mvpaAccelerometer_noCutOff", "mpaAccelerometer_noCutOff", "vpaAccelerometer_noCutOff", "lpaAccelerometer_noCutOff", "weartimeAccelerometer_noCutOff", "sitLieAccelerometer_noCutOff", "standingAccelerometer_noCutOff")
# 
# for (variableToChange in timeVariables) {
# originalMean <- vardatatable_sandwich[vardatatable_sandwich$Variable == variableToChange, "Mean"] %>% as.numeric()
# newMean <- paste0(floor(originalMean/60), "h ", round(originalMean, 0) %% 60, "min")
# vardatatable_sandwich[vardatatable_sandwich$Variable == variableToChange, "Mean"] <- newMean
# originalCI <- vardatatable_sandwich[vardatatable_sandwich$Variable == variableToChange, "CI95"]
# originalCIL <- stringi::stri_extract_first_words(originalCI) %>% as.numeric()
# originalCIH <- stringi::stri_extract_last_words(originalCI) %>% as.numeric()
# newCI <- paste0(floor(originalCIL/60), "h ", round(originalCIL, 0) %% 60, "min - ",
#                 floor(originalCIH/60), "h ", round(originalCIH, 0) %% 60, "min")
# vardatatable_sandwich[vardatatable_sandwich$Variable == variableToChange, "CI95"] <- newCI
# }
# 
# save(vardatatable_sandwich, file = "./Rdata_files/vardatatable_sandwich.Rdata")
# save(ci_sandwich, file = "./Rdata_files/ci_sandwich.Rdata")
load("./Rdata_files/vardatatable_sandwich.Rdata")
load("./Rdata_files/ci_sandwich.Rdata")
```

```{r datatable-sandwich}

vardatatable_sandwich %>% 
  DT::datatable(caption = "Values calculated with a sandwich estimator accounting for school, class and educational track")

```

## Calculating (Bayesian) credibility interval {.tabset}

[Due to incompatibility of researchers' equipment and Stan/brms, this section omitted until further notice. Code below is left to demonstrate how one would perform the analysis]

### Credible interval for model including school & group

```{r table-parameters-bayes}

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
ci_low <- NA
ci_high <- NA
nonmissings <- NA
variable <- NA

# # Use this to test a single variable:
# m <- brms::brm(sitLieAccelerometer_T1 ~ 1 + (1|school) + (1|group) + (1|track), data = df,
#                chains = 4,
#                iter = 5000,
#                control = list(adapt_delta = 0.99))
# brms::prior_summary(m, data = dftest)
# fixef(m)

# # UNCOMMENT below and run code:
# for (i in names){ # Loop over each variable name for all participants, extract statistics
# df_for_brms <- df %>% dplyr::select(
#   group, school, track, i)
# 
# m <- brms::brm(paste0(i," ~ (1|school) + (1|group)"), data = df_for_brms,
#                chains = 4,
#                iter = 5000,
#                control = list(adapt_delta = 0.99))
# mean[i] <- broom::tidy(m) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(estimate) %>% dplyr::pull()
# ci_low[i] <- broom::tidy(m) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(lower) %>% dplyr::pull()
# ci_high[i] <- broom::tidy(m) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(upper) %>% dplyr::pull()
# nonmissings[i] <- m$data %>% nrow(.)
# variable[i] <- i
# }
# 
# save(mean, file = "./Rdata_files/brms_mean.Rdata")
# save(ci_low, file = "./Rdata_files/brms_ci_low.Rdata")
# save(ci_high, file = "./Rdata_files/brms_ci_high.Rdata")
# save(nonmissings, file = "./Rdata_files/brms_nonmissings.Rdata")
# save(variable, file = "./Rdata_files/brms_variable.Rdata")
# 
# # broom::tidy(m_sitLieAccelerometer_T1) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(lower, estimate, upper)
#  
# vardatatable_bayes <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1) %>% format(., nsmall = 1),
#   "CI95" = paste(round(ci_low, 1) %>% format(., nsmall = 1), " - ", round(ci_high, 1) %>% format(., nsmall = 1)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# ci_bayes <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# # To improve readability, change the variables which are expressed in minutes, to the form "Xh Ymin"
# timeVariables <- c("mvpaAccelerometer", "mpaAccelerometer", "vpaAccelerometer", "lpaAccelerometer", "weartimeAccelerometer", "sitLieAccelerometer", "standingAccelerometer", "mvpaAccelerometer_noCutOff", "mpaAccelerometer_noCutOff", "vpaAccelerometer_noCutOff", "lpaAccelerometer_noCutOff", "weartimeAccelerometer_noCutOff", "sitLieAccelerometer_noCutOff", "standingAccelerometer_noCutOff")
# 
# for (variableToChange in timeVariables) {
# originalMean <- vardatatable_bayes[vardatatable_bayes$Variable == variableToChange, "Mean"] %>% as.numeric()
# newMean <- paste0(floor(originalMean/60), "h ", round(originalMean, 0) %% 60, "min")
# vardatatable_bayes[vardatatable_bayes$Variable == variableToChange, "Mean"] <- newMean
# originalCI <- vardatatable_bayes[vardatatable_bayes$Variable == variableToChange, "CI95"]
# originalCIL <- stringi::stri_extract_first_words(originalCI) %>% as.numeric()
# originalCIH <- stringi::stri_extract_last_words(originalCI) %>% as.numeric()
# newCI <- paste0(floor(originalCIL/60), "h ", round(originalCIL, 0) %% 60, "min - ",
#                 floor(originalCIH/60), "h ", round(originalCIH, 0) %% 60, "min")
# vardatatable_bayes[vardatatable_bayes$Variable == variableToChange, "CI95"] <- newCI
# }
# 
# save(vardatatable_bayes, file = "./Rdata_files/vardatatable_bayes.Rdata")
# save(ci_bayes, file = "./Rdata_files/ci_bayes.Rdata")
load("./Rdata_files/vardatatable_bayes.Rdata")
load("./Rdata_files/ci_bayes.Rdata")

```

### Credible interval for model including school, group & track

```{r table-parameters-bayes_containing_edutrack}

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
ci_low <- NA
ci_high <- NA
nonmissings <- NA
variable <- NA

# # Use this to test a single variable:
# m <- brms::brm(sitLieAccelerometer_T1 ~ 1 + (1|school) + (1|group) + (1|track), data = df,
#                chains = 4,
#                iter = 5000,
#                control = list(adapt_delta = 0.99))
# brms::prior_summary(m, data = dftest)
# fixef(m)

# # UNCOMMENT below and run code:
# for (i in names){ # Loop over each variable name for all participants, extract statistics
# df_for_brms <- df %>% dplyr::select(
#   group, school, track, i)
# 
# m <- brms::brm(paste0(i," ~ (1|school) + (1|group) + (1|track)"), data = df_for_brms,
#                chains = 4,
#                iter = 5000,
#                control = list(adapt_delta = 0.99))
# mean[i] <- broom::tidy(m) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(estimate) %>% dplyr::pull()
# ci_low[i] <- broom::tidy(m) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(lower) %>% dplyr::pull()
# ci_high[i] <- broom::tidy(m) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(upper) %>% dplyr::pull()
# nonmissings[i] <- m$data %>% nrow(.)
# variable[i] <- i
# }
# 
# save(mean, file = "./Rdata_files/brms_mean.Rdata")
# save(ci_low, file = "./Rdata_files/brms_ci_low.Rdata")
# save(ci_high, file = "./Rdata_files/brms_ci_high.Rdata")
# save(nonmissings, file = "./Rdata_files/brms_nonmissings.Rdata")
# save(variable, file = "./Rdata_files/brms_variable.Rdata")
# 
# # broom::tidy(m_sitLieAccelerometer_T1) %>% dplyr::filter(term == "b_Intercept") %>% dplyr::select(lower, estimate, upper)
#  
# vardatatable_bayes_containing_edutrack <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1) %>% format(., nsmall = 1),
#   "CI95" = paste(round(ci_low, 1) %>% format(., nsmall = 1), " - ", round(ci_high, 1) %>% format(., nsmall = 1)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# ci_bayes_containing_edutrack <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# # To improve readability, change the variables which are expressed in minutes, to the form "Xh Ymin"
# timeVariables <- c("mvpaAccelerometer", "mpaAccelerometer", "vpaAccelerometer", "lpaAccelerometer", "weartimeAccelerometer", "sitLieAccelerometer", "standingAccelerometer", "mvpaAccelerometer_noCutOff", "mpaAccelerometer_noCutOff", "vpaAccelerometer_noCutOff", "lpaAccelerometer_noCutOff", "weartimeAccelerometer_noCutOff", "sitLieAccelerometer_noCutOff", "standingAccelerometer_noCutOff")
# 
# for (variableToChange in timeVariables) {
# originalMean <- vardatatable_bayes_containing_edutrack[vardatatable_bayes_containing_edutrack$Variable == variableToChange, "Mean"] %>% as.numeric()
# newMean <- paste0(floor(originalMean/60), "h ", round(originalMean, 0) %% 60, "min")
# vardatatable_bayes_containing_edutrack[vardatatable_bayes_containing_edutrack$Variable == variableToChange, "Mean"] <- newMean
# originalCI <- vardatatable_bayes_containing_edutrack[vardatatable_bayes_containing_edutrack$Variable == variableToChange, "CI95"]
# originalCIL <- stringi::stri_extract_first_words(originalCI) %>% as.numeric()
# originalCIH <- stringi::stri_extract_last_words(originalCI) %>% as.numeric()
# newCI <- paste0(floor(originalCIL/60), "h ", round(originalCIL, 0) %% 60, "min - ",
#                 floor(originalCIH/60), "h ", round(originalCIH, 0) %% 60, "min")
# vardatatable_bayes_containing_edutrack[vardatatable_bayes_containing_edutrack$Variable == variableToChange, "CI95"] <- newCI
# }
# 
# save(vardatatable_bayes_containing_edutrack, file = "./Rdata_files/vardatatable_bayes_containing_edutrack.Rdata")
# save(ci_bayes_containing_edutrack, file = "./Rdata_files/ci_bayes_containing_edutrack.Rdata")
load("./Rdata_files/vardatatable_bayes_containing_edutrack.Rdata")
load("./Rdata_files/ci_bayes_containing_edutrack.Rdata")

```


```{r datatable-bayes}

vardatatable_bayes %>% 
  DT::datatable(caption = "Intercepts and (Bayesian) credible intervals, calculated with model accounting for school and class")

```

### Robustness exploration for sedentary behaviour

Here we demonstrate how, in the case of sedentary behaviour, using brms default priors gives practically identical results to those, where the prior for the intercept has been drawn from the [feasibility study](https://helda.helsinki.fi/handle/10138/193787). We compare these two models and add a third, where the educational track is included in addition to school and class. 

Based on the information criterion (WAIC) or cross-validation (LOO), models do not seem to differ with regards their out-of-sample prediction ability.

```{r WAIC}

# # Model with school and class:
# m_sitLieAccelerometer_T1 <- brms::brm(sitLieAccelerometer_T1 ~ 1 + (1|school) + (1|group), data = df,
#                chains = 4,
#                iter = 5000,
#                control = list(adapt_delta = 0.99))
# 
# save(m_sitLieAccelerometer_T1, file = "./Rdata_files/m_sitLieAccelerometer_T1.Rdata")
load("./Rdata_files/m_sitLieAccelerometer_T1.Rdata")

# # Take the prior from the default model, and change the prior for the intercept:
# prior_intercept_fromFeasibility <- brms::prior_summary(m_sitLieAccelerometer_T1, data = df)
# prior_intercept_fromFeasibility[1, 1] <- "normal(563.32, 79.34)"
# 
# m_priorFromFeasibility <- brms::brm(
#   sitLieAccelerometer_T1 ~ 1 + (1|school) + (1|group), data=df,
#   prior = prior_intercept_fromFeasibility,
#   chains = 4,
#   iter = 5000,
#   control = list(adapt_delta = 0.99))
# 
# save(m_priorFromFeasibility, file = "./Rdata_files/m_priorFromFeasibility.Rdata")
load("./Rdata_files/m_priorFromFeasibility.Rdata")

# # Model with school, class and track:
# m_sitLieWithTrack <- brms::brm(sitLieAccelerometer_T1 ~ 1 + (1|school) + (1|group) + (1|track), data = df,
#                chains = 4,
#                iter = 5000,
#                control = list(adapt_delta = 0.99))
# brms::prior_summary(m, data = df)
# fixef(m_sitLieWithTrack)
# save(m_sitLieWithTrack, file = "./Rdata_files/m_sitLieWithTrack.Rdata")
load("./Rdata_files/m_sitLieWithTrack.Rdata")

print("Priors for models summarised:")
brms::prior_summary(m_sitLieAccelerometer_T1, data = df)
brms::prior_summary(m_priorFromFeasibility, data = df)
brms::prior_summary(m_sitLieWithTrack, data = df)

print("Results of models summarised:")
brms::fixef(m_sitLieAccelerometer_T1) 
brms::fixef(m_priorFromFeasibility)
brms::fixef(m_sitLieWithTrack)

# WAIC_m_sitLieAccelerometer_T1 <- brms::WAIC(m_sitLieAccelerometer_T1)
# WAIC_m_priorFromFeasibility <- brms::WAIC(m_priorFromFeasibility)
# WAIC_m_sitLieWithTrack <- brms::WAIC(m_sitLieWithTrack)
# 
# save(WAIC_m_sitLieAccelerometer_T1, file = "./Rdata_files/WAIC_m_sitLieAccelerometer_T1.Rdata")
# save(WAIC_m_priorFromFeasibility, file = "./Rdata_files/WAIC_m_priorFromFeasibility.Rdata")
# save(WAIC_m_sitLieWithTrack, file = "./Rdata_files/WAIC_m_sitLieWithTrack.Rdata")

load("./Rdata_files/WAIC_m_sitLieAccelerometer_T1.Rdata")
load("./Rdata_files/WAIC_m_priorFromFeasibility.Rdata")
load("./Rdata_files/WAIC_m_sitLieWithTrack.Rdata")


print("Comparison based on WAIC:")
brms::compare_ic(WAIC_m_sitLieAccelerometer_T1, WAIC_m_priorFromFeasibility, WAIC_m_sitLieWithTrack)

# loo_m_sitLieAccelerometer_T1 <- brms::loo(m_sitLieAccelerometer_T1)
# loo_m_priorFromFeasibility <- brms::loo(m_priorFromFeasibility)
# loo_m_sitLieWithTrack <- brms::loo(m_sitLieWithTrack)
# 
# save(loo_m_sitLieAccelerometer_T1, file = "./Rdata_files/loo_m_sitLieAccelerometer_T1.Rdata")
# save(loo_m_priorFromFeasibility, file = "./Rdata_files/loo_m_priorFromFeasibility.Rdata")
# save(loo_m_sitLieWithTrack, file = "./Rdata_files/loo_m_sitLieWithTrack.Rdata")

load("./Rdata_files/loo_m_sitLieAccelerometer_T1.Rdata")
load("./Rdata_files/loo_m_priorFromFeasibility.Rdata")
load("./Rdata_files/loo_m_sitLieWithTrack.Rdata")

print("Comparison based on leave-one-out (LOO) cross validation:")
brms::compare_ic(loo_m_sitLieAccelerometer_T1, loo_m_priorFromFeasibility, loo_m_sitLieWithTrack)
```


## Calculating observed means and CIs, without clustering

```{r table-parameters-observed}

df_for_uncorrected <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff"), -contains("_T4"))

# Create empty soon-to-be-filled objects
mean_uncorrected <- NA
ci_low <- NA
ci_high <- NA
nonmissings <- NA

ci_uncorrected <- rbind(
  df_for_uncorrected %>% dplyr::summarise_all(funs(t.test(.)$conf.int[1])),
  df_for_uncorrected %>% dplyr::summarise_all(funs(mean(., na.rm = TRUE))),
  df_for_uncorrected %>% dplyr::summarise_all(funs(t.test(.)$conf.int[2]))) %>% 
  t() %>% 
  data.frame

names(ci_uncorrected) <- c("ciLo", "mean", "ciHi")

```

```{r datatable-observed}

ci_uncorrected %>% 
  dplyr::mutate(Variable = labels(ci_uncorrected)[[1]]) %>% 
  dplyr::mutate_at(vars(-Variable), funs(round(., digits = 3))) %>% 
  dplyr::select(Variable, everything()) %>% 
  DT::datatable(caption = "Values calculated without accounting for clustering")

```

# Gender means, with CIs taking school and class into account

Create confidence bounds for all items by gender and intervention allocation

These numbers are visualised with diamond plots later.

```{r CIs-for-diamondplots}
# names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)
# 
# # Intercepts for boys; when boy is 1, girl is 0, but boy is a factor, so intercept is for boys even though boy is 1 for boys and 0 for girls.
# m.boys <- NA
# mean.boys <- NA
# m_p.boys <- NA
# ci_low.boys <- NA
# ci_high.boys <- NA
# ICC_group.boys <- NA
# ICC_School.boys <- NA
# nonmissings.boys <- NA
# 
# df.boys <- df %>% dplyr::mutate(boy = factor(ifelse(girl == "girl", 0, 1), levels = c(1, 0)))
# 
# for (i in names){
# m.boys <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + boy"), data=df.boys)
# mean.boys[i] <- lme4::fixef(m.boys)[1]
# m_p.boys <- profile(m.boys, which = "beta_")
# ci_low.boys[i] <- confint(m_p.boys)[1, 1]
# ci_high.boys[i] <- confint(m_p.boys)[1, 2]
# ICC_group.boys[i] <- sjstats::icc(m.boys)[1]
# ICC_School.boys[i] <- sjstats::icc(m.boys)[2]
# nonmissings.boys[i] <- length(m.boys@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for girls:", labels(lme4::fixef(m.boys))[2] == "boy0")
# 
# ci_boys <- data.frame(ciLo = ci_low.boys, mean = mean.boys, ciHi = ci_high.boys)
# diamondlabels <- labels(ci_boys)[[1]]
# ci_boys <- data.frame(ci_boys, diamondlabels)
# 
# # Intercepts for girls; when boy is 1, girl is 0, but boy is a factor, so intercept is for girls even though girl is 1 for girls and 0 for boys.
# m.girls <- NA
# mean.girls <- NA
# m_p.girls <- NA
# ci_low.girls <- NA
# ci_high.girls <- NA
# ICC_group.girls <- NA
# ICC_School.girls <- NA
# nonmissings.girls <- NA
# 
# for (i in names){
# m.girls <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + girl"), data=df)
# mean.girls[i] <- lme4::fixef(m.girls)[1]
# m_p.girls <- profile(m.girls, which = "beta_")
# ci_low.girls[i] <- confint(m_p.girls)[1, 1]
# ci_high.girls[i] <- confint(m_p.girls)[1, 2]
# ICC_group.girls[i] <- sjstats::icc(m.girls)[1]
# ICC_School.girls[i] <- sjstats::icc(m.girls)[2]
# nonmissings.girls[i] <- length(m.girls@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for boys:", labels(lme4::fixef(m.girls))[2] == "girl0")
# 
# ci_girls <- data.frame(ciLo = ci_low.girls, mean = mean.girls, ciHi = ci_high.girls)
# diamondlabels <- labels(ci_girls)[[1]]
# ci_girls <- data.frame(ci_girls, diamondlabels)
# 
# 
# # Intercepts for intervention
# m.intervention <- NA
# mean.intervention <- NA
# m_p.intervention <- NA
# ci_low.intervention <- NA
# ci_high.intervention <- NA
# ICC_group.intervention <- NA
# ICC_School.intervention <- NA
# nonmissings.intervention <- NA
# 
# ## change "intervention" to be consistent regarding level order with "girl".
# df.intervention <- df %>% dplyr::mutate(intervention = factor(intervention, levels = c(1, 0)))
# 
# for (i in names){
# m.intervention <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + intervention"), data=df.intervention)
# mean.intervention[i] <- lme4::fixef(m.intervention)[1]
# m_p.intervention <- profile(m.intervention, which = "beta_")
# ci_low.intervention[i] <- confint(m_p.intervention)[1, 1]
# ci_high.intervention[i] <- confint(m_p.intervention)[1, 2]
# ICC_group.intervention[i] <- sjstats::icc(m.intervention)[1]
# ICC_School.intervention[i] <- sjstats::icc(m.intervention)[2]
# nonmissings.intervention[i] <- length(m.intervention@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for control:", labels(lme4::fixef(m.intervention))[2] == "intervention0")
# 
# ci_intervention <- data.frame(ciLo = ci_low.intervention, mean = mean.intervention, ciHi = ci_high.intervention)
# diamondlabels <- labels(ci_intervention)[[1]]
# ci_intervention <- data.frame(ci_intervention, diamondlabels)
# 
# # Intercepts for control
# 
# m.control <- NA
# mean.control <- NA
# m_p.control <- NA
# ci_low.control <- NA
# ci_high.control <- NA
# ICC_group.control <- NA
# ICC_School.control <- NA
# nonmissings.control <- NA
# 
# df.control <- df %>% dplyr::mutate(control = factor(ifelse(intervention == 1, 0, 1), levels = c(1, 0)))
# 
# for (i in names){
# m.control <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + control"), data=df.control)
# mean.control[i] <- lme4::fixef(m.control)[1]
# m_p.control <- profile(m.control, which = "beta_")
# ci_low.control[i] <- confint(m_p.control)[1, 1]
# ci_high.control[i] <- confint(m_p.control)[1, 2]
# ICC_group.control[i] <- sjstats::icc(m.control)[1]
# ICC_School.control[i] <- sjstats::icc(m.control)[2]
# nonmissings.control[i] <- length(m.control@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for intervention:", labels(lme4::fixef(m.control))[2] == "control0")
# 
# ci_control <- data.frame(ciLo = ci_low.control, mean = mean.control, ciHi = ci_high.control)
# diamondlabels <- labels(ci_control)[[1]]
# ci_control <- data.frame(ci_control, diamondlabels)
# 
# # # Same ICC results you'd get with e.g.:
# # m1 <- as.data.frame(VarCorr(m))
# # m1$vcov[1] / (m1$vcov[1] + m1$vcov[3])
# 
# # Or from broom:
# # tidy(m)$estimate[2]^2 / (tidy(m)$estimate[2]^2 + tidy(m)$estimate[4]^2)
# 
# # Or from sjstats:
# # sum(get_re_var(m)) / (sum(get_re_var(m)) + get_re_var(m, "sigma_2"))
# 
# save(ci_control, file = "./Rdata_files/ci_control.Rdata")
# save(ci_intervention, file = "./Rdata_files/ci_intervention.Rdata")
# save(ci_girls, file = "./Rdata_files/ci_girls.Rdata")
# save(ci_boys, file = "./Rdata_files/ci_boys.Rdata")

load("./Rdata_files/ci_control.Rdata")
load("./Rdata_files/ci_intervention.Rdata")
load("./Rdata_files/ci_girls.Rdata")
load("./Rdata_files/ci_boys.Rdata")

```

<!-- ### Gender and intervention group CIs with sandwich estimator -->
<!-- NOT INCLUDED, because the line beginning with "sandwich_se <- diag(..." gives a negative sandwich variance estimate, which can't be square-rooted -->

```{r sandwich_genderintervention, include = FALSE, eval = FALSE}
# Basic instructions are from https://web.archive.org/web/20180206180739/http://thestatsgeek.com/2014/02/14/the-robust-sandwich-variance-estimator-for-linear-regression-using-r/

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -SB_selfRepSitbreaksDidNotSit30min_T1, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
sandwich_se <- NA
mean_girl <- NA
mean_boy <- NA
ci_low_girl <- NA
ci_high_girl <- NA
ci_low_boy <- NA
ci_high_boy <- NA
nonmissings <- NA

# To test the code with a single variable:
df_for_sandwich <- df %>% dplyr::select(group, school, track, girl, sitLieAccelerometer_T1) %>% na.omit()
sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track, girl)
m <- lm(sitLieAccelerometer_T1 ~ girl, data=df_for_sandwich)
sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5

mean_girl <- m$coefficients[[1]]
mean_boy <- m$coefficients[[1]] + m$coefficients[[2]]

ci_low_girl <- mean_girl - 1.96 * sandwich_se
ci_high_girl <- mean_girl + 1.96 * sandwich_se
ci_low_boy <- mean_boy - 1.96 * sandwich_se
ci_high_boy <- mean_boy + 1.96 * sandwich_se

nonmissings <- nrow(m$model)


# # Loop over each variable name, extract statistics:
for (i in names){
df_for_sandwich <- df %>% dplyr::select(
  group, school, track, girl, i) %>%
  na.omit()
sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track, girl)
m <- lm(paste0(i," ~ girl"), data = df_for_sandwich)
sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5
 
mean_girl[i] <- m$coefficients[[1]]
mean_boy[i] <- m$coefficients[[1]] + m$coefficients[[2]]
 
ci_low_girl[i] <- m$coefficients[[1]] - 1.96 * sandwich_se
ci_high_girl[i] <- mean_girl + 1.96 * sandwich_se
ci_low_boy[i] <- mean_boy - 1.96 * sandwich_se
ci_high_boy[i] <- mean_boy + 1.96 * sandwich_se

nonmissings[i] <- nrow(m$model)
}

vardatatable_sandwich <- data_frame(
  Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
  Mean = round(mean, 1),
  CI95 = paste(round(ci_low, 1), "-", round(ci_high, 1)),
  n = nonmissings) %>%
  dplyr::arrange(Variable) %>%
  dplyr::filter(Variable != "") #remove first row, which is empty

save(vardatatable_sandwich, file = "./Rdata_files/vardatatable_sandwich.Rdata")
load("./Rdata_files/vardatatable_sandwich.Rdata")

ci_sandwich <- data_frame(
  "ciLo" = ci_low,
  "mean" = mean,
  "ciHi" = ci_high,
  "diamondlabels" = names(mean)) %>%
  dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
  as.data.frame()

save(ci_sandwich, file = "./Rdata_files/ci_sandwich.Rdata")
load("./Rdata_files/ci_sandwich.Rdata")
```

```{r}
ci_table_boys <- ci_boys %>% dplyr::transmute("Mean boys" = mean %>% round(., 1) %>% format(., nsmall = 1),
                                              "CI95 boys" = paste0( 
                                                            ciLo %>% round(., 1) %>% format(., nsmall = 1), " -",
                                                            ciHi %>% round(., 1) %>% format(., nsmall = 1)))

ci_table_girls <- ci_girls %>% dplyr::transmute("Mean girls" = mean %>% round(., 1) %>% format(., nsmall = 1),
                                                "CI95 girls" = paste0( 
                                                               ciLo %>% round(., 1) %>% format(., nsmall = 1), " -",
                                                               ciHi %>% round(., 1) %>% format(., nsmall = 1)))

genderCIs_table <- cbind(Variable = ci_boys$diamondlabels, ci_table_boys, ci_table_girls) %>% 
  dplyr::filter(Variable != "") 


genderCIs_table %>% 
  DT::datatable()
```

# Visual comparison of different estimates for means and CIs

This section contains diamond plots comparing different estimates for means and CIs.

## High-mean variables

```{r parameter-comparison-highmean-plots}
ci_total_big <- ci_total %>% dplyr::filter(mean > 10)
ci_edutrack_big <- ci_edutrack %>% dplyr::filter(mean > 10)
ci_uncorrected_big <- ci_uncorrected %>% dplyr::filter(mean > 10)
ci_sandwich_big <- ci_sandwich %>% dplyr::filter(mean > 10)
# ci_bayes_big <- ci_bayes %>% dplyr::filter(mean > 10)
# ci_bayes_containing_edutrack_big <- ci_bayes_containing_edutrack %>% dplyr::filter(mean > 10)

for (i in 1:4){
plot1 <- userfriendlyscience::diamondPlot(ci_total_big[i, ], 
                                          color = viridis::viridis(5)[1], 
                                          alpha = 0.1, 
                                          yLabels = ci_total_big[i, ]$diamondlabels, 
                                          fixedSize = 0.4, 
                                          xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_edutrack_big[i, ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(5)[2], 
                                   alpha = 0.1, 
                                   yLabels = ci_edutrack_big[i, ]$diamondlabels, 
                                   fixedSize = 0.5, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_uncorrected_big[i, ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(5)[3], 
                                   alpha = 0.1, 
                                   yLabels = ci_uncorrected_big[i, ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_sandwich_big[i, ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(5)[4], 
                                   alpha = 0.1, 
                                   yLabels = ci_uncorrected_big[i, ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) +
  # userfriendlyscience::diamondPlot(ci_bayes_big[i, ], 
  #                                  returnLayerOnly = TRUE,
  #                                  color = "red", 
  #                                  alpha = 0, 
  #                                  yLabels = ci_uncorrected_big[i, ]$diamondlabels, 
  #                                  fixedSize = 0.10, 
  #                                  xlab = NULL,
  #                                  linetype = "dashed",
  #                                  size = 1.05) +
  # userfriendlyscience::diamondPlot(ci_bayes_containing_edutrack_big[i, ], 
  #                                  returnLayerOnly = TRUE,
  #                                  color = viridis::viridis(5)[5], 
  #                                  alpha = 0, 
  #                                  yLabels = ci_uncorrected_big[i, ]$diamondlabels, 
  #                                  fixedSize = 0.15, 
  #                                  xlab = NULL,
  #                                  linetype = "dashed",
  #                                  size = 1.05) +
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom & school"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom, school & track"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Uncorrected"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Sandwich"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  # geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Bayes: classroom & school"), 
  #           colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  # geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Bayes: classroom, school & track"), 
  #           colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  scale_fill_manual('Model',
                    values = c(
                      # "red",
                      #          viridis::viridis(5)[5],
                               viridis::viridis(5)[1], 
                               viridis::viridis(5)[2], 
                               viridis::viridis(5)[4], 
                               viridis::viridis(5)[3]),
                    guide = guide_legend(override.aes = list(alpha = 1), ncol = 2)) +
  theme(legend.position="bottom") 
  plot(plot1)
}
```

## Other variables

```{r estimates for other variables, results = "asis", fig.show = "asis"}
# Take the high-mean variables out, because otherwise you'd have something with a mean of 200 
# and a mean of 2 in the same plot, and scaling of the x-axis would smudge differences between the
# diamonds, which indicate the estimates

ci_total_small <- ci_total %>% dplyr::filter(mean <= 10)
ci_edutrack_small <- ci_edutrack %>% dplyr::filter(mean <= 10)
ci_uncorrected_small <- ci_uncorrected %>% dplyr::filter(mean <= 10)
ci_sandwich_small <- ci_sandwich %>% dplyr::filter(mean <= 10)
# ci_bayes_small <- ci_bayes %>% dplyr::filter(mean <= 10)
# ci_bayes_containing_edutrack_small <- ci_bayes_containing_edutrack %>% dplyr::filter(mean <= 10)

# Now, four data frames contain columns ciLo, mean, ciHi, and variable name, for each variable (i.e. row).
# Make a diamondPlot layer from each of these data frames, so that i number of variables are in the same plot: 

for (i in c(seq(from = 1, to = nrow(ci_total_small), by = 6))) {
plot1 <- userfriendlyscience::diamondPlot(ci_total_small[i:(i + 6), ], 
                                          color = viridis::viridis(5)[1], 
                                          alpha = 0.1, 
                                          yLabels = ci_total_small[i:(i + 6), ]$diamondlabels, 
                                          fixedSize = 0.4, 
                                          xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_edutrack_small[i:(i + 6), ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(5)[2], 
                                   alpha = 0.1, 
                                   yLabels = ci_edutrack_small[i:(i + 6), ]$diamondlabels, 
                                   fixedSize = 0.5, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_uncorrected_small[i:(i + 6), ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(5)[3], 
                                   alpha = 0.1, 
                                   yLabels = ci_uncorrected_small[i:(i + 6), ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_sandwich_small[i:(i + 6), ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(5)[4], 
                                   alpha = 0.1, 
                                   yLabels = ci_uncorrected_small[i:(i + 6), ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) +
  # geom_point(aes(x = ci_bayes_small$ciLo[i:(i + 6)], y = 1:7),
  #            color = "red") +
  # geom_point(aes(x = ci_bayes_small$ciHi[i:(i + 6)], y = 1:7),
  #            color = "red") +
  # geom_point(aes(x = ci_bayes_containing_edutrack_small$ciLo[i:(i + 6)], y = 1:7),
  #            color = viridis::viridis(5)[5]) +
  # geom_point(aes(x = ci_bayes_containing_edutrack_small$ciHi[i:(i + 6)], y = 1:7),
  #            color = viridis::viridis(5)[5]) +
  # userfriendlyscience::diamondPlot(ci_bayes_small[i:(i + 6), ], 
  #                                  returnLayerOnly = TRUE,
  #                                  color = viridis::viridis(5)[5], 
  #                                  alpha = 0, 
  #                                  yLabels = ci_uncorrected_small[i:(i + 6), ]$diamondlabels, 
  #                                  fixedSize = 0.10, 
  #                                  xlab = NULL,
  #                                  linetype = "dashed"
  #                                  ) +
  # userfriendlyscience::diamondPlot(ci_bayes_containing_edutrack_small[i:(i + 6), ], 
  #                                  returnLayerOnly = TRUE,
  #                                  color = "red", 
  #                                  alpha = 0, 
  #                                  yLabels = ci_uncorrected_small[i:(i + 6), ]$diamondlabels, 
  #                                  fixedSize = 0.15, 
  #                                  xlab = NULL,
  #                                  linetype = "dashed"
  #                                  ) +
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom & school"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom, school & track"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Uncorrected"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Sandwich"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  # geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Bayes: classroom & school"), 
  #           colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  # geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Bayes: classroom, school & track"), 
  #           colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  scale_fill_manual('Model: ',
                    values = c(
                      # "red",
                      #          viridis::viridis(5)[5],
                               viridis::viridis(5)[1], 
                               viridis::viridis(5)[2], 
                               viridis::viridis(5)[4], 
                               viridis::viridis(5)[3]),
                    guide = guide_legend(override.aes = list(alpha = 1), ncol = 3)) +
  theme(legend.position = "bottom", 
        legend.justification = "left",
        plot.margin = margin(t = 0, r = 4, b = 0, l = 0, unit = "cm"),
        axis.text.y = element_text(angle = 30, hjust = 1)) 
#  cat('\n\n####', i, '\n\n  ') 
  print(plot1)
}
```


```{r ci-widths, include = FALSE, eval = FALSE}
# These are perhaps not meaningful, and as variables change, locations of the bumps change.

CI_widths <- data.frame(
  "Label" = ci_total$diamondlabels,
  "Classroom & school" = (ci_total$ciHi - ci_total$ciLo), 
  "Classroom, school & track" = (ci_edutrack$ciHi - ci_edutrack$ciLo), 
  "Uncorrected" = (ci_uncorrected$ciHi - ci_uncorrected$ciLo),
  "Sandwich" = (ci_sandwich$ciHi - ci_sandwich$ciLo)) %>% 
  dplyr::arrange(Sandwich)

CI_widths %>%
  dplyr::mutate(Label = as.numeric(as.factor(ci_total$diamondlabels)))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    ggtitle("All variables")

CI_widths %>%
  dplyr::mutate(Label = paste(ci_total$diamondlabels,
                              as.numeric(as.factor(ci_total$diamondlabels))))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(75, 100), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into bumps")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(81, 83), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into first bump")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(87, 89), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into second bump")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(92, 96), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into third bump")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(97, 99), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into fourth bump")

# # test to see all labels are in the right order
# data.frame(
#   Label = ci_total$diamondlabels,
#   label2 = ci_edutrack$diamondlabels,
#   label3 = ci_uncorrected$diamondlabels,
#   label4 = ci_sandwich) %>% rowwise %>% 
#   dplyr::mutate(test1 = ifelse(Label == label2, "OK",
#                         ifelse(label2 == label3, "OK", 
#                                ifelse(label3 == label4, "OK", "DISCREPANCY"))))

```

# Demographic tables

Next code chunk prepares data.

```{r demographics-prep}

demographics <- lmi %>% dplyr::select(id = ID,
  birthYear = Kys0004.1,
  surveyDate = StartDateTime.1,
  intervention = ryhma,
  school = Aineisto.1,
  girl = Kys0013.1,
  ethnicity1 = Kys0005.1,
  ethnicity2 = Kys0005.2,
  ethnicity3 = Kys0005.3,
  studyYear = Kys0014.1) %>% 
  dplyr::mutate(
    surveyYear = lubridate::year(surveyDate),
    age = as.numeric(surveyYear) - as.numeric(birthYear),
    intervention = ifelse(intervention == 1, 1, 0),
    intervention = as.numeric(intervention, levels = c("0", "1")),
    girl = ifelse(girl == "2", 1, 0),
    girl = as.numeric(girl, levels = c("1", "0")),
    school = factor(school, levels = c("1", "2", "3", "4", "5")),
    bornInFinland = ifelse(!is.na(ethnicity1), ethnicity1, 
                           ifelse(!is.na(ethnicity2), ethnicity2,
                                  ifelse(!is.na(ethnicity3), ethnicity3, NA))),
    bornInFinland = as.numeric(ifelse(bornInFinland == 1, 1, 0)),
    studyYear = ifelse(as.numeric(studyYear) == 0, NA, as.numeric(studyYear))) %>%  # Remove "other" from study year
  dplyr::select(-surveyDate, -surveyYear, -ethnicity1, -ethnicity2, -ethnicity3)

# Insert track variable with those who answered "other" with one of the actual category labels given the appropriate category:
Track <- lmi %>% dplyr::select(Kys0016.1, Kys0017.1) %>% dplyr::mutate(
  Kys0016.1 = as.character(Kys0016.1), # Because I had an Evaluation error: `x` and `labels` must be same type.
  Kys0017.1 = as.character(Kys0017.1),
  Kys0016.1 = ifelse(Kys0017.1 == "Merkonomi" | Kys0017.1 == "merkonomi", 3,
                     ifelse(Kys0017.1 == "Datanomi" | Kys0017.1 == "datanomi", 2, Kys0016.1)),
  Track = factor(Kys0016.1, # Fix track labels first
                 levels = c(0, 1, 2, 3, 4),
                 labels = c("Other", "IT", "BA", "HRC", "Nur"))) %>% 
  dplyr::select(-Kys0016.1, -Kys0017.1)

demographics <- bind_cols(demographics, Track)

save(demographics, file = "./data/demographics.Rdata")
```

## By educational track

```{r demographics-table-track, results = 'asis'}
demotable <- demographics %>% 
  dplyr::filter(track != "Other") %>% 
  dplyr::group_by(Track) %>% 
  dplyr::summarise(
    n = n(),
    "Mean age (range, median)" = paste0(round(mean(age, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                range(age, na.rm = TRUE)[1] %>% format(., nsmall = 1), "-",
                                range(age, na.rm = TRUE)[2] %>% format(., nsmall = 1), ", ",
                                round(median(age, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "Mean study year (sd, median)" = paste0(round(mean(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                    round(sd(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ", ",
                                    round(median(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "% girl" = round(mean(girl, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "% allocated to intervention" = round(mean(intervention, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "Born in Finland (%)" = round(mean(bornInFinland, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1)
                                ) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  dplyr::arrange(desc(Track)) 

demotable_total <- demographics %>% 
  summarise(
    n = n(),
    "Track" = "Full sample",
    "Mean age (range, median)" = paste0(round(mean(age, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                range(age, na.rm = TRUE)[1] %>% format(., nsmall = 1), "-",
                                range(age, na.rm = TRUE)[2] %>% format(., nsmall = 1), ", ",
                                round(median(age, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "Mean study year (sd, median)" = paste0(round(mean(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                    round(sd(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ", ",
                                    round(median(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "% girl" = round(mean(girl, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "% allocated to intervention" = round(mean(intervention, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "Born in Finland (%)" = round(mean(bornInFinland, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1)
    )

demotable <- bind_rows(demotable, demotable_total)

demotable <- demotable %>% 
  tidyr::gather(Variable, val, 2:ncol(demotable)) %>% 
  tidyr::spread(Track, val) %>% 
  dplyr::select(Variable, Nur, HRC, BA, IT, `Full sample`) %>% 
  dplyr::arrange(-row_number())

# For some reason, sum of n's of all tracks is 1084.

save(demotable, file = "./Rdata_files/demotable.Rdata")

papaja::apa_table(demotable, caption = "Baseline demographics of educational tracks", digits = c(0, 1, 1, 1, 1, 1, 0))
```

## By gender

```{r demographics-table-gender, results = 'asis'}
# demographics$Girl <- factor(demographics$girl)

demotable <- demographics %>% 
  group_by(girl) %>% 
  summarise(
    n = n(),
    "Mean age (range, median)" = paste0(round(mean(age, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                range(age, na.rm = TRUE)[1] %>% format(., nsmall = 1), "-",
                                range(age, na.rm = TRUE)[2] %>% format(., nsmall = 1), ", ",
                                round(median(age, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "Mean study year (sd, median)" = paste0(round(mean(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                    round(sd(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ", ",
                                    round(median(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "% allocated to intervention" = round(mean(intervention, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "Born in Finland (%)" = round(mean(bornInFinland, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1)
    ) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  arrange(desc(girl)) 

demotable_total <- demographics %>% 
  summarise(
    n = n(),
    "Mean age (range, median)" = paste0(round(mean(age, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                range(age, na.rm = TRUE)[1] %>% format(., nsmall = 1), "-",
                                range(age, na.rm = TRUE)[2] %>% format(., nsmall = 1), ", ",
                                round(median(age, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "Mean study year (sd, median)" = paste0(round(mean(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                    round(sd(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ", ",
                                    round(median(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "% allocated to intervention" = round(mean(intervention, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "Born in Finland (%)" = round(mean(bornInFinland, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1)
    )

demotable <- bind_rows(demotable, demotable_total)

demotable <- demotable %>% 
  tidyr::gather(Variable, val, 2:ncol(demotable)) %>% 
  tidyr::spread(girl, val) %>% 
  dplyr::arrange(-row_number())

names(demotable) <- c("", "Boy", "Girl", "Full sample")

# For some reason, sum of n's of all tracks is 1084.

papaja::apa_table(demotable, caption = "Baseline demographics of educational tracks", digits = c(0, 1, 1, 1, 1, 0))
```

## By intervention participation

```{r demographics-table-intervention, results = 'asis'}
demographics$intervention <- factor(demographics$intervention)
demographics$girl <- as.numeric(demographics$girl)

demotable <- demographics %>% 
  group_by(intervention) %>% 
  summarise(
    "Mean age (range, median)" = paste0(round(mean(age, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                range(age, na.rm = TRUE)[1] %>% format(., nsmall = 1), "-",
                                range(age, na.rm = TRUE)[2] %>% format(., nsmall = 1), ", ",
                                round(median(age, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "Mean study year (sd, median)" = paste0(round(mean(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                    round(sd(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ", ",
                                    round(median(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "% girl" = round(mean(girl, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "Born in Finland (%)" = round(mean(bornInFinland, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    n = n()
    ) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  arrange(desc(intervention)) 

demotable_total <- demographics %>% 
  summarise(
    "intervention" = "Full sample",
    "Mean age (range, median)" = paste0(round(mean(age, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                range(age, na.rm = TRUE)[1] %>% format(., nsmall = 1), "-",
                                range(age, na.rm = TRUE)[2] %>% format(., nsmall = 1), ", ",
                                round(median(age, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "Mean study year (sd, median)" = paste0(round(mean(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1)," (", 
                                    round(sd(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ", ",
                                    round(median(studyYear, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
    "% girl" = round(mean(girl, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    "Born in Finland (%)" = round(mean(bornInFinland, na.rm = TRUE)*100, 1) %>% format(., nsmall = 1),
    n = n()
    )

demotable <- bind_rows(demotable, demotable_total)

demotable <- demotable %>% 
  tidyr::gather(Variable, val, 2:ncol(demotable)) %>% 
  tidyr::spread(intervention, val) %>% 
  dplyr::arrange(-row_number())

names(demotable) <- c("", "Control", "Intervention", "Full sample")

# For some reason, sum of n's of all tracks is 1084.

papaja::apa_table(demotable, caption = "Baseline demographics of educational tracks", digits = c(0, 1, 1, 1, 1, 0))
```

## Outcome tables

```{r outcome-table, results = 'asis'}

outtable_track <- df %>%
  dplyr::select(mvpaAccelerometer_T1, sitLieAccelerometer_T1, sitBreaksAccelerometer_T1, # Main outcomes 
          weartimeAccelerometer_T1,
          PA_actionplan_T1,
          PA_copingplan_T1,
          PA_agreementDependentBCT_T1,
          PA_frequencyDependentBCT_T1,
          PA_amotivation_T1,
          PA_autonomous_T1,
          PA_controlled_T1,
          PA_goal_T1,
          PA_injunctiveNorm_T1,
          PA_descriptiveNorm_T1,
          PA_intention_T1,
          PA_outcomeExpectations_T1,
          PA_opportunities_T1,
          PA_perceivedBehaviouralControl_T1,
          PA_selfefficacy_T1,
          SB_descriptiveNorm_T1,
          SB_injunctiveNorm_T1,
          SB_intention_T1,
          SB_outcomeExpectations_T1,
          SB_selfEfficacyperceivedBehaviouralControl_T1,
         track, girl, intervention) %>% 
  group_by(track) %>% 
  summarise(
            "PA action planning" = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA coping planning" = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA agreement-BCTs" = paste0(round(mean(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA frequency-BCTs" = paste0(round(mean(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA amotivation" = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                      " (", round(sd(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA autonomous regulation" = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA controlled regulation" = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA injunctive norm" = paste0(round(mean(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA descriptive norm" = paste0(round(mean(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA intention" = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA outcome expectations" = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA opportunities" = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA perceived behavioural control" = paste0(round(mean(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                        " (", round(sd(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA self-efficacy" = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB descriptive norm" = paste0(round(mean(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB injunctive norm" = paste0(round(mean(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB intention" = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB outcome expectations" = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB self-efficacy & perceived behavioural control" = paste0(round(mean(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                                        " (", round(sd(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily MVPA hours" = paste0(round(mean(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                               " (", round(sd(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily hours spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                                      " (", round(sd(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily accelerometer weartime hours" = paste0(round(mean(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            n = n()) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  arrange((track)) %>% 
  dplyr::filter(track != "Other")

outtable_intervention <- df %>%
  dplyr::select(mvpaAccelerometer_T1, sitLieAccelerometer_T1, sitBreaksAccelerometer_T1, # Main outcomes  
          weartimeAccelerometer_T1,
          PA_actionplan_T1,
          PA_copingplan_T1,
          PA_agreementDependentBCT_T1,
          PA_frequencyDependentBCT_T1,
          PA_amotivation_T1,
          PA_autonomous_T1,
          PA_controlled_T1,
          PA_goal_T1,
          PA_injunctiveNorm_T1,
          PA_descriptiveNorm_T1,
          PA_intention_T1,
          PA_outcomeExpectations_T1,
          PA_opportunities_T1,
          PA_perceivedBehaviouralControl_T1,
          PA_selfefficacy_T1,
          SB_descriptiveNorm_T1,
          SB_injunctiveNorm_T1,
          SB_intention_T1,
          SB_outcomeExpectations_T1,
          SB_selfEfficacyperceivedBehaviouralControl_T1,
         track, girl, intervention) %>% 
  group_by(intervention) %>% 
  summarise(
            "PA action planning" = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA coping planning" = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA agreement-BCTs" = paste0(round(mean(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA frequency-BCTs" = paste0(round(mean(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA amotivation" = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                      " (", round(sd(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA autonomous regulation" = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA controlled regulation" = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA injunctive norm" = paste0(round(mean(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA descriptive norm" = paste0(round(mean(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA intention" = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA outcome expectations" = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA opportunities" = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA perceived behavioural control" = paste0(round(mean(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                        " (", round(sd(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA self-efficacy" = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB descriptive norm" = paste0(round(mean(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB injunctive norm" = paste0(round(mean(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB intention" = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB outcome expectations" = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB self-efficacy & perceived behavioural control" = paste0(round(mean(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                                        " (", round(sd(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily MVPA minutes" = paste0(round(mean(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                               " (", round(sd(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                                      " (", round(sd(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily accelerometer weartime" = paste0(round(mean(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            n = n()) %>% 
  dplyr::filter(complete.cases(.))

outtable_girl <- df %>%
  dplyr::select(mvpaAccelerometer_T1, sitLieAccelerometer_T1, sitBreaksAccelerometer_T1, # Main outcomes  
          weartimeAccelerometer_T1,
          PA_actionplan_T1,
          PA_copingplan_T1,
          PA_agreementDependentBCT_T1,
          PA_frequencyDependentBCT_T1,
          PA_amotivation_T1,
          PA_autonomous_T1,
          PA_controlled_T1,
          PA_goal_T1,
          PA_injunctiveNorm_T1,
          PA_descriptiveNorm_T1,
          PA_intention_T1,
          PA_outcomeExpectations_T1,
          PA_opportunities_T1,
          PA_perceivedBehaviouralControl_T1,
          PA_selfefficacy_T1,
          SB_descriptiveNorm_T1,
          SB_injunctiveNorm_T1,
          SB_intention_T1,
          SB_outcomeExpectations_T1,
          SB_selfEfficacyperceivedBehaviouralControl_T1,
         track, girl, intervention) %>% 
  group_by(girl) %>% 
  summarise(
            "PA action planning" = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA coping planning" = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA agreement-BCTs" = paste0(round(mean(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA frequency-BCTs" = paste0(round(mean(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA amotivation" = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                      " (", round(sd(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA autonomous regulation" = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA controlled regulation" = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA injunctive norm" = paste0(round(mean(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA descriptive norm" = paste0(round(mean(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA intention" = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA outcome expectations" = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA opportunities" = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA perceived behavioural control" = paste0(round(mean(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                        " (", round(sd(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA self-efficacy" = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB descriptive norm" = paste0(round(mean(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB injunctive norm" = paste0(round(mean(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB intention" = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB outcome expectations" = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB self-efficacy & perceived behavioural control" = paste0(round(mean(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                                        " (", round(sd(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily MVPA minutes" = paste0(round(mean(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                               " (", round(sd(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                                      " (", round(sd(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily accelerometer weartime" = paste0(round(mean(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            n = n()) %>% 
  dplyr::filter(complete.cases(.))

outtable_total <- df %>% 
  summarise("girl" = "Full sample",
            "PA action planning" = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_actionplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA coping planning" = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_copingplan_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA agreement-BCTs" = paste0(round(mean(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_agreementDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA frequency-BCTs" = paste0(round(mean(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                         " (", round(sd(PA_frequencyDependentBCT_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA amotivation" = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                      " (", round(sd(PA_amotivation_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA autonomous regulation" = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_autonomous_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA controlled regulation" = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                " (", round(sd(PA_controlled_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA injunctive norm" = paste0(round(mean(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(PA_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA descriptive norm" = paste0(round(mean(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(PA_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA intention" = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(PA_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA outcome expectations" = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(PA_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA opportunities" = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_opportunities_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA perceived behavioural control" = paste0(round(mean(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                        " (", round(sd(PA_perceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "PA self-efficacy" = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                        " (", round(sd(PA_selfefficacy_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB descriptive norm" = paste0(round(mean(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                           " (", round(sd(SB_descriptiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB injunctive norm" = paste0(round(mean(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                          " (", round(sd(SB_injunctiveNorm_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB intention" = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                    " (", round(sd(SB_intention_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB outcome expectations" = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                               " (", round(sd(SB_outcomeExpectations_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "SB self-efficacy & perceived behavioural control" = paste0(round(mean(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), 
                                                                        " (", round(sd(SB_selfEfficacyperceivedBehaviouralControl_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily MVPA minutes" = paste0(round(mean(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                               " (", round(sd(mvpaAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                                      " (", round(sd(sitLieAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(sitBreaksAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            "Mean daily accelerometer weartime" = paste0(round(mean(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1),
                                                    " (", round(sd(weartimeAccelerometer_T1, na.rm = TRUE), 1) %>% format(., nsmall = 1), ")"),
            n = n())



# Transpose each table
outtable_track <- outtable_track %>% tidyr::gather(Variable, val, 2:ncol(.)) %>% tidyr::spread(track, val)

outtable_intervention <- outtable_intervention %>% tidyr::gather(Variable, val, 2:ncol(.)) %>% tidyr::spread(intervention, val)
names(outtable_intervention) <- c("Variable", "Control", "Intervention")

## In the last table, have a column for total before transposing
outtable_girl <- bind_rows(outtable_total, outtable_girl)
outtable_girl <- outtable_girl %>% 
  tidyr::gather(Variable, val, 2:ncol(.)) %>% 
  tidyr::spread(girl, val) %>% 
  dplyr::select(Variable, boy, girl, "Full sample")

names(outtable_girl) <- c("Variable", "Boy", "Girl", "Full sample")

# Are all variables the same? They should be, for the table to work!
# identical(outtable_track$Variable, outtable_girl$Variable)
# identical(outtable_track$Variable, outtable_intervention$Variable)

# Create large table with all variables
outtable_mega <- bind_cols(outtable_track, outtable_intervention, outtable_girl) %>% 
  dplyr::select(-Variable1, -Variable2) 

# Move n to be the first row
out1 <- outtable_mega %>% dplyr::filter(Variable == "n")
out2 <- outtable_mega %>% dplyr::filter(Variable != "n")
outtable_mega <- bind_rows(out1, out2)

# Fix names: leave first blank, have the rest as they were
names(outtable_mega) <- c("", names(outtable_mega)[2:(length(names(outtable_mega)))])

papaja::apa_table(outtable_mega, caption = "Baseline demographics of educational tracks. Values indicate mean (sd, without taking clustering into account)")


```


## Determinant table with CIs

```{r outcome-table2, results = 'asis'}
vars_to_get_n_for <- ci_total %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agreementDependentBCT_T1|PA_frequencyDependentBCT_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_injunctiveNorm_T1|PA_descriptiveNorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_perceivedBehaviouralControl_T1|PA_selfefficacy_T1|SB_descriptiveNorm_T1|SB_injunctiveNorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_total$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::select(vars = diamondlabels) %>% 
  dplyr::pull()

mediatortable_intervention <- ci_intervention %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agreementDependentBCT_T1|PA_frequencyDependentBCT_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_injunctiveNorm_T1|PA_descriptiveNorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_perceivedBehaviouralControl_T1|PA_selfefficacy_T1|SB_descriptiveNorm_T1|SB_injunctiveNorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_intervention$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1) %>% format(., nsmall = 1), "-", round(ciHi, 1) %>% format(., nsmall = 1)),
         mean = round(mean, 1) %>% format(., nsmall = 1))

n_range_intervention <- df %>% 
  dplyr::filter(intervention == "1") %>% 
  dplyr::select(one_of(vars_to_get_n_for)) %>% 
  tidyr::gather(variable, value) %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise_each(funs(sum(!is.na(.))))

n_range_intervention <- paste0("(n = ", min(n_range_intervention$value), "-", max(n_range_intervention$value), ")")

mediatortable_intervention$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_agreementDependentBCT_T1', 'PA agreement-BCTs', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_frequencyDependentBCT_T1', 'PA frequency-BCTs', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_injunctiveNorm_T1', 'PA injunctive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_descriptiveNorm_T1', 'PA descriptive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_perceivedBehaviouralControl_T1', 'PA perceived behavioural control', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_descriptiveNorm_T1', 'SB descriptive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_injunctiveNorm_T1', 'SB injunctive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_intervention$diamondlabels)

mediatortable_control <- ci_control %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agreementDependentBCT_T1|PA_frequencyDependentBCT_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_injunctiveNorm_T1|PA_descriptiveNorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_perceivedBehaviouralControl_T1|PA_selfefficacy_T1|SB_descriptiveNorm_T1|SB_injunctiveNorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_control$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1) %>% format(., nsmall = 1), "-", round(ciHi, 1) %>% format(., nsmall = 1)),
         mean = round(mean, 1) %>% format(., nsmall = 1))

n_range_control <- df %>% 
  dplyr::filter(intervention == "0") %>% 
  dplyr::select(one_of(vars_to_get_n_for)) %>% 
  tidyr::gather(variable, value) %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise_each(funs(sum(!is.na(.))))

n_range_control <- paste0("(n = ", min(n_range_control$value), "-", max(n_range_control$value), ")")

mediatortable_control$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_agreementDependentBCT_T1', 'PA agreement-BCTs', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_frequencyDependentBCT_T1', 'PA frequency-BCTs', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_injunctiveNorm_T1', 'PA injunctive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_descriptiveNorm_T1', 'PA descriptive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_perceivedBehaviouralControl_T1', 'PA perceived behavioural control', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_descriptiveNorm_T1', 'SB descriptive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_injunctiveNorm_T1', 'SB injunctive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_control$diamondlabels)

mediatortable_girls <- ci_girls %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agreementDependentBCT_T1|PA_frequencyDependentBCT_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_injunctiveNorm_T1|PA_descriptiveNorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_perceivedBehaviouralControl_T1|PA_selfefficacy_T1|SB_descriptiveNorm_T1|SB_injunctiveNorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_girls$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1) %>% format(., nsmall = 1), "-", round(ciHi, 1) %>% format(., nsmall = 1)),
         mean = round(mean, 1) %>% format(., nsmall = 1))

n_range_girls <- df %>% 
  dplyr::filter(girl == "girl") %>% 
  dplyr::select(one_of(vars_to_get_n_for)) %>% 
  tidyr::gather(variable, value) %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise_each(funs(sum(!is.na(.))))

n_range_girls <- paste0("(n = ", min(n_range_girls$value), "-", max(n_range_girls$value), ")")

mediatortable_girls$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_agreementDependentBCT_T1', 'PA agreement-BCTs', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_frequencyDependentBCT_T1', 'PA frequency-BCTs', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_injunctiveNorm_T1', 'PA injunctive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_descriptiveNorm_T1', 'PA descriptive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_perceivedBehaviouralControl_T1', 'PA perceived behavioural control', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_descriptiveNorm_T1', 'SB descriptive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_injunctiveNorm_T1', 'SB injunctive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_girls$diamondlabels)

mediatortable_boys <- ci_boys %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agreementDependentBCT_T1|PA_frequencyDependentBCT_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_injunctiveNorm_T1|PA_descriptiveNorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_perceivedBehaviouralControl_T1|PA_selfefficacy_T1|SB_descriptiveNorm_T1|SB_injunctiveNorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_boys$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1) %>% format(., nsmall = 1), "-", round(ciHi, 1) %>% format(., nsmall = 1)),
         mean = round(mean, 1) %>% format(., nsmall = 1))

n_range_boys <- df %>% 
  dplyr::filter(girl == "boy") %>% 
  dplyr::select(one_of(vars_to_get_n_for)) %>% 
  tidyr::gather(variable, value) %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise_each(funs(sum(!is.na(.))))

n_range_boys <- paste0("(n = ", min(n_range_boys$value), "-", max(n_range_boys$value), ")")

mediatortable_boys$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_agreementDependentBCT_T1', 'PA agreement-BCTs', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_frequencyDependentBCT_T1', 'PA frequency-BCTs', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_injunctiveNorm_T1', 'PA injunctive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_descriptiveNorm_T1', 'PA descriptive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_perceivedBehaviouralControl_T1', 'PA perceived behavioural control', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_descriptiveNorm_T1', 'SB descriptive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_injunctiveNorm_T1', 'SB injunctive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_boys$diamondlabels)

mediatortable_total <- ci_total %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agreementDependentBCT_T1|PA_frequencyDependentBCT_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_injunctiveNorm_T1|PA_descriptiveNorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_perceivedBehaviouralControl_T1|PA_selfefficacy_T1|SB_descriptiveNorm_T1|SB_injunctiveNorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_total$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1) %>% format(., nsmall = 1), "-", round(ciHi, 1) %>% format(., nsmall = 1)),
         mean = round(mean, 1) %>% format(., nsmall = 1))

n_range_total <- df %>% dplyr::select(one_of(vars_to_get_n_for)) %>% 
  tidyr::gather(variable, value) %>% 
  dplyr::group_by(variable) %>% 
  dplyr::summarise_each(funs(sum(!is.na(.))))

n_range_total <- paste0("(n = ", min(n_range_total$value), "-", max(n_range_total$value), ")")

mediatortable_total$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_agreementDependentBCT_T1', 'PA agreement-BCTs', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_frequencyDependentBCT_T1', 'PA frequency-BCTs', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_injunctiveNorm_T1', 'PA injunctive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_descriptiveNorm_T1', 'PA descriptive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_perceivedBehaviouralControl_T1', 'PA perceived behavioural control', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_descriptiveNorm_T1', 'SB descriptive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_injunctiveNorm_T1', 'SB injunctive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_total$diamondlabels)

mega_mediatortable <- data.frame(
  "Variable" = mediatortable_girls$diamondlabels, 
  "Girls" = paste0(round(mediatortable_girls$mean %>% as.numeric(.), 1) %>% format(., nsmall = 1), " (", mediatortable_girls$CI95, ")"),
  "Boys" = paste0(round(mediatortable_boys$mean %>% as.numeric(.), 1) %>% format(., nsmall = 1), " (", mediatortable_boys$CI95, ")"),
  "Intervention" = paste0(round(mediatortable_intervention$mean %>% as.numeric(.), 1) %>% format(., nsmall = 1), " (", mediatortable_intervention$CI95, ")"),
  "Control" = paste0(round(mediatortable_control$mean %>% as.numeric(.), 1) %>% format(., nsmall = 1), " (", mediatortable_control$CI95, ")"),
  "Total" = paste0(round(mediatortable_total$mean %>% as.numeric(.), 1) %>% format(., nsmall = 1), " (", mediatortable_total$CI95, ")")
  ) %>% 
  arrange(Variable)

colnames(mega_mediatortable) <- paste(colnames(mega_mediatortable),
                                      c("", n_range_girls, n_range_boys, n_range_intervention, n_range_control, n_range_total))

mega_mediatortable <- mega_mediatortable %>% dplyr::arrange(factor(mega_mediatortable$Variable, levels = c(
                                                    "PA intention",
                                                    "PA perceived behavioural control",
                                                    "PA self-efficacy",
                                                    "PA opportunities",
                                                    "PA descriptive norm",
                                                    "PA injunctive norm",
                                                    "PA outcome expectations",
                                                    "PA action planning",
                                                    "PA coping planning",
                                                    "PA autonomous regulation",
                                                    "PA controlled regulation",
                                                    "PA amotivation",
                                                    "PA agreement-BCTs",
                                                    "PA frequency-BCTs",
                                                    "SB intention",
                                                    "SB descriptive norm",
                                                    "SB injunctive norm",
                                                    "SB outcome expectations")))


save(mega_mediatortable, file = "./Rdata_files/mega_mediatortable.Rdata")
papaja::apa_table(mega_mediatortable, caption = "Main theoretical determinants of PA and SB. Number of observations in brackets after column names.")


```

# Excercise types

Table below shows, how bivariate correlations between exercise types differ between the accelerometer and self-reported MVPA measure. More information can be found in the section on networks.

```{r exercisetypes-bivariate-table}

exerciseTypes_df <- lmi %>% select(Kys0051.1:Kys0064.1) %>% 
  dplyr::select(contains(".1")) %>% 
  dplyr::mutate_all(funs(replace_na(., 0)))
# exerciseTypes_df$track <- df$track
# exerciseTypes_df$girl <- df$girl
exerciseTypes_df$`PA accelerometer` <- df$mvpaAccelerometer_T1
exerciseTypes_df$`PA self-report` <- df$padaysLastweek_T1

names(exerciseTypes_df) <- c("Team ball games", 
                             "Other ball games",
                             "Gym training",
                             "Combat sports",
                             "Fitness classes",
                             "Home workout",
                             "Cycling",
                             "Swimming",
                             "Walking",
                             "Running",
                             "Skiing",
                             "Roller skating",
                             "Horseback riding",
                             "Other",
                             "PA accelerometer",
                             "PA self-report"
                             )

# Roller skating has only 8 observations; leave out
exerciseTypes_df <- exerciseTypes_df %>% dplyr::select(-`Roller skating`)

# Variable types are muddled, change all to numeric
exerciseTypes_df <- as.data.frame(purrr::map(exerciseTypes_df, `class<-`, c("numeric"))) 

# Change data frame to type tbl to allow for spaces
exerciseTypes_df <- as.tbl(exerciseTypes_df)

# Take all names, replace the dots with space
names(exerciseTypes_df) <- stringr::str_replace_all(names(exerciseTypes_df), pattern = "\\.", replacement = " ")

qgraph::cor_auto(exerciseTypes_df) %>% data.frame() %>% 
  dplyr::mutate(variable = names(exerciseTypes_df)) %>% 
  dplyr::mutate_at(vars(PA.accelerometer, PA.self.report), funs(round(., 3))) %>% 
  dplyr::select(variable, PA.accelerometer, PA.self.report) %>% 
  dplyr::mutate(diff = PA.accelerometer - PA.self.report) %>% 
  dplyr::arrange(desc(abs(diff))) %>% 
  dplyr::filter(variable != "PA accelerometer", variable != "PA self report") %>% 
  DT::datatable(caption = "Bivariate correlations between PA measures and self-reported activity types")

```

# Session information

Description of the R environment can be found below.

```{r session-info, results = 'markup'}
devtools::session_info()

pander::pander(sessionInfo())
```
