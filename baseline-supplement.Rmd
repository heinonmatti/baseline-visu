---
title: "Baseline analysis supplement"
---

Welcome to the LMI baseline supplement! This supplement will walk you through the paper and provides additional graphs.

Measures used in the study

Clicking the "Code"-buttons on the right shows code for each chunk.

To start data analysis, we set up the basics to enable compiling the document:

```{r setup, verbose = FALSE, warning = FALSE, message = FALSE}
source("baseline-datasetup.R")
```


# Estimating means with CIs taking clustering into account 

The code chunks create linear models for all variables. The results are used to estimate confidence intervals and intra-class correlations (ICC).

Browse throught the tabs above to see different information.

Code chunk below shows how the values are calculated.

```{r multilevel-clusters}
# Create a vector with all names of the variables we want. Exclude T3 variables.
names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
m_p <- NA
ci_low <- NA
ci_high <- NA
ICC_group <- NA
ICC_School <- NA
nonmissings <- NA

## Use this to test a single variable:
# dftest <- df #%>% na.omit()
# m <- lme4::lmer(sitLieAccelerometer_diff ~ (1|school) + (1|group), data=dftest)
# mean <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low <- confint(m_p)[, 1]
# ci_high <- confint(m_p)[, 2]
# ICC_group <- icc(m)[1]
# ICC_School <- icc(m)[2]
# nonmissings <- length(m@resp$y)


# Loop over each variable name, extract statistics: 

# all participants
# for (i in names){
# m <- lme4::lmer(paste0(i," ~ (1|school) + (1|group)"), data=df)
# mean[i] <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low[i] <- confint(m_p)[, 1]
# ci_high[i] <- confint(m_p)[, 2]
# ICC_group[i] <- sjstats::icc(m)[1]
# ICC_School[i] <- sjstats::icc(m)[2]
# nonmissings[i] <- length(m@resp$y)
# }
#
#
# vardatatable <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   "Mean" = round(mean, 1),
#   "CI95" = paste(round(ci_low, 1), " - ", round(ci_high, 2)),
#   "ICC class" =ifelse(round(ICC_group, 3) == 0, "< 0.001", round(ICC_group, 3)),
#   "ICC school" = ifelse(round(ICC_School, 3) == 0, "< 0.001", round(ICC_School, 3)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") %>% #remove first row, which is empty
#   dplyr::mutate(`ICC class` = as.numeric(`ICC class`)) %>%
#   as.data.frame()
#
# ci_total <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()

# save(vardatatable, file = "vardatatable.Rdata")
# save(ci_total, file = "ci_total.Rdata")
load("vardatatable.Rdata")
load("ci_total.Rdata")
```

```{r primary-outcome-vars-table-total, results = 'asis'}
options(tibble.print_max = 1000)

vardatatable2 <- vardatatable
vardatatable2$Variable <- gsub("paAccelerometer", "MVPA minutes (accelerometer)", vardatatable2$Variable)
vardatatable2$Variable <- gsub("padaysLastweek", "Number of MVPA days last week (self-report)", vardatatable2$Variable)
vardatatable2$Variable <- gsub("sitLieAccelerometer", "Minutes spent sitting or lying down (accelerometer)", vardatatable2$Variable)
vardatatable2$Variable <- gsub("sitBreaks", "Number of times sitting was interrupted (accelerometer)", vardatatable2$Variable)

vardatatable2 %>% 
  dplyr::filter(Variable == "MVPA minutes (accelerometer)" | 
           Variable == "Number of MVPA days last week (self-report)" | 
           Variable == "Minutes spent sitting or lying down (accelerometer)" | 
           Variable == "Number of times sitting was interrupted (accelerometer)" ) %>% 
    papaja::apa_table(
        caption = "Primary outcome variables with their class and school ICCs",
        escape = T,
        format.args = list(digits = c(1, 3, 0), margin = 2))
```

## All main variables, their means, CIs and ICCs.


```{r allvars-total, results = 'asis'}
options(tibble.print_max = 1000)
 
vardatatable %>%
    papaja::apa_table(
        caption = "All variables with their class and school ICCs",
        escape = T,
        format.args = list(digits = c(1, 3, 0), margin = 2))
```

### ICC top 20 items, sorted by classroom ICC

```{r icc-school-class-sortbyclass, results = 'asis'}

vardatatable %>% 
  dplyr::select(Variable, `ICC class`, `ICC school`, n) %>% 
  arrange(desc(`ICC class`)) %>% slice(1:20) %>% 
  as.tbl() %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by classroom ICC",
        format.args = list(digits = c(3, 0), margin = 2))

```

### ICC top 20 items, sorted by school ICC

```{r icc-school-class-sortbyschool, results = 'asis'}

vardatatable %>% dplyr::select(Variable, `ICC class`, `ICC school`, n) %>% 
  arrange(desc(`ICC school`)) %>% 
  slice(1:20) %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by school ICC",
        format.args = list(digits = c(3, 0), margin = 2))

```

Model with educational track

The model below is the same as the one above, except it adds educational track. 

As before, we create a table with all variables, their means, CIs and ICCs.


```{r multilevel-edutrack-school-group}
#library(sjstats)
#library(lme4)

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
m_p <- NA
ci_low <- NA
ci_high <- NA
ICC_group <- NA
ICC_School <- NA
nonmissings <- NA
ICC_track <- NA


## To test the code with a single variable:
# dftest <- df #%>% na.omit()
# m <- lme4::lmer(sitLieAccelerometer_T1 ~ (1|school) + (1|group) + (1|track), data=df)
# mean <- lme4::fixef(m)
# m_p <- profile(m)
# ci_low <- confint(m_p)[5]
# ci_high <- confint(m_p)[10]
# ICC_group <- icc(m)[1]
# ICC_School <- icc(m)[2]
# nonmissings <- length(m@resp$y)

# Loop over each variable name, extract statistics: 

# all participants  
# for (i in names){
# m <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + (1|track)"), data=df)
# mean[i] <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low[i] <- confint(m_p)[1]
# ci_high[i] <- confint(m_p)[2]
# ICC_group[i] <- sjstats::icc(m)[1]
# ICC_School[i] <- sjstats::icc(m)[3]
# ICC_track[i] <- sjstats::icc(m)[2]
# nonmissings[i] <- length(m@resp$y)
# }
# 
# vardatatable_containing_edutrack <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   Mean = round(mean, 1), 
#   CI95 = paste(round(ci_low, 2), "-", round(ci_high, 2)), 
#   "ICC class" =ifelse(round(ICC_group, 3) == 0, "< 0.001", round(ICC_group, 3)), 
#   "ICC school" = ifelse(round(ICC_School, 3) == 0, "< 0.001", round(ICC_School, 3)),
#   "ICC educational track" = ifelse(round(ICC_track, 3) == 0, "< 0.001", round(ICC_track, 3)),
#   n = nonmissings) %>% 
#   dplyr::arrange(Variable) %>% 
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# save(vardatatable_containing_edutrack, file = "vardatatable_containing_edutrack.Rdata")
load("vardatatable_containing_edutrack.Rdata")

# ci_edutrack <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# save(ci_edutrack, file = "ci_edutrack.Rdata")
load("ci_edutrack.Rdata")

```

### Top 20 items, sorted by school

```{r icc-school-class-track-sortbyschool, results = 'asis'}

vardatatable_containing_edutrack %>% 
  dplyr::select(Variable, `ICC educational track`, `ICC class`, `ICC school`, n) %>% 
  arrange(desc(`ICC school`)) %>% 
  top_n(20) %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by school ICC",
        format.args = list(digits = c(0), margin = 2))

```

### Top 20 items, sorted by classroom

```{r icc-school-class-track-sortbyclass, results = 'asis'}

vardatatable_containing_edutrack %>% dplyr::select(Variable, `ICC educational track`, `ICC class`, `ICC school`, n) %>% arrange(desc(`ICC class`)) %>% top_n(20) %>% papaja::apa_table(caption = "Intra-class correlations sorted by classroom ICC",
        format.args = list(digits = c(0), margin = 2))

```

### Top 20 items, sorted by educational track

```{r icc-school-class-track-sortbytrack, results = 'asis'}

vardatatable_containing_edutrack %>% dplyr::select(Variable, `ICC educational track`, `ICC class`, `ICC school`, n) %>% arrange(desc(`ICC educational track`)) %>% top_n(20) %>% papaja::apa_table(caption = "Intra-class correlations sorted by educational track ICC",
        format.args = list(digits = c(0), margin = 2))

```

Model with educational track only

```{r parameters-multilevel-edutrack-only}
#library(sjstats)
#library(lme4)

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
mean <- NA
m_p <- NA
ci_low <- NA
ci_high <- NA
ICC_group <- NA
ICC_School <- NA
nonmissings <- NA
ICC_track <- NA


## To test the code with a single variable:
# dftest <- df #%>% na.omit()
# m <- lme4::lmer(sitLieAccelerometer_T1 ~ (1|track), data=df)
# mean <- lme4::fixef(m)
# m_p <- profile(m)
# ci_low <- confint(m_p)[3]
# ci_high <- confint(m_p)[6]
# ICC_group <- sjstats::icc(m)[1]
# nonmissings <- length(m@resp$y)

# Loop over each variable name, extract statistics: 

# all participants  
# for (i in names){
# m <- lme4::lmer(paste0(i," ~ (1|track)"), data=df)
# mean[i] <- lme4::fixef(m)
# m_p <- profile(m, which = "beta_")
# ci_low[i] <- confint(m_p)[1]
# ci_high[i] <- confint(m_p)[2]
# ICC_track[i] <- sjstats::icc(m)[1]
# nonmissings[i] <- length(m@resp$y)
# }
# 
# vardatatable_edutrack_only <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   Mean = round(mean, 1),
#   CI95 = paste(round(ci_low, 1), "-", round(ci_high, 1)),
#   "ICC educational track" = ifelse(round(ICC_track, 3) == 0, "< 0.001", round(ICC_track, 3)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# save(vardatatable_edutrack_only, file = "vardatatable_edutrack_only.Rdata")
load("vardatatable_edutrack_only.Rdata")

# ci_edutrack_only <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# save(ci_edutrack_only, file = "ci_edutrack_only.Rdata")
load("ci_edutrack_only.Rdata")

```

### Top 20 items, sorted by ICC educational track

```{r icc-edu-track-only, results = 'asis'}

vardatatable_containing_edutrack %>% 
  dplyr::select(Variable, `ICC educational track`, n) %>% 
  arrange(desc(`ICC educational track`)) %>% 
  top_n(20) %>% 
  papaja::apa_table(caption = "Intra-class correlations sorted by educational track ICC",
        format.args = list(digits = c(0), margin = 2))

```

CIs using the sandwich estimator

```{r table-parameters-sandwich}
# Basic instructions are from https://web.archive.org/web/20180206180739/http://thestatsgeek.com/2014/02/14/the-robust-sandwich-variance-estimator-for-linear-regression-using-r/

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
sandwich_se <- NA
mean <- NA
ci_low <- NA
ci_high <- NA
nonmissings <- NA

## To test the code with a single variable:
# df_for_sandwich <- df %>% dplyr::select(group, school, track, sitLieAccelerometer_T1) %>% na.omit()
# sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track)
# m <- lm(sitLieAccelerometer_T1 ~ 1, data=df_for_sandwich)
# sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5
# mean <- m$coefficients[[1]]
# ci_low <- coef(m) - 1.96 * sandwich_se
# ci_high <- coef(m) + 1.96 * sandwich_se
# nonmissings <- nrow(m$model)


# # Loop over each variable name, extract statistics:
# for (i in names){
# df_for_sandwich <- df %>% dplyr::select(
#   group, school, track, i) %>%
#   na.omit()
# sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track)
# m <- lm(paste0(i," ~ 1"), data = df_for_sandwich)
# sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5
# mean[i] <- m$coefficients[[1]]
# ci_low[i] <- coef(m) - 1.96 * sandwich_se
# ci_high[i] <- coef(m) + 1.96 * sandwich_se
# nonmissings[i] <- nrow(m$model)
# }
# 
# vardatatable_sandwich <- data_frame(
#   Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
#   Mean = round(mean, 1),
#   CI95 = paste(round(ci_low, 1), "-", round(ci_high, 1)),
#   n = nonmissings) %>%
#   dplyr::arrange(Variable) %>%
#   dplyr::filter(Variable != "") #remove first row, which is empty
# 
# save(vardatatable_sandwich, file = "vardatatable_sandwich.Rdata")
load("vardatatable_sandwich.Rdata")

# ci_sandwich <- data_frame(
#   "ciLo" = ci_low,
#   "mean" = mean,
#   "ciHi" = ci_high,
#   "diamondlabels" = names(mean)) %>%
#   dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
#   as.data.frame()
# 
# save(ci_sandwich, file = "ci_sandwich.Rdata")
load("ci_sandwich.Rdata")
```

Observed means and CIs, without clustering

```{r table-parameters-observed}

df_for_uncorrected <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff"))

# Create empty soon-to-be-filled objects
mean_uncorrected <- NA
ci_low <- NA
ci_high <- NA
nonmissings <- NA

ci_uncorrected <- rbind(
  df_for_uncorrected %>% dplyr::summarise_all(funs(t.test(.)$conf.int[1])),
  df_for_uncorrected %>% dplyr::summarise_all(funs(mean(., na.rm = TRUE))),
  df_for_uncorrected %>% dplyr::summarise_all(funs(t.test(.)$conf.int[2]))) %>% 
  t() %>% 
  data.frame

names(ci_uncorrected) <- c("ciLo", "mean", "ciHi")

```


# Compare mean- and CI-estimates visually 

This section contains diamond plots comparing different estimates for means and CIs.

## High-mean variables

```{r parameter-comparison-highmean-plots}
ci_total_big <- ci_total %>% dplyr::filter(mean > 10)
ci_edutrack_big <- ci_edutrack %>% dplyr::filter(mean > 10)
ci_uncorrected_big <- ci_uncorrected %>% dplyr::filter(mean > 10)
ci_sandwich_big <- ci_sandwich %>% dplyr::filter(mean > 10)


for (i in 1:4){
plot1 <- userfriendlyscience::diamondPlot(ci_total_big[i, ], 
                                          color = viridis::viridis(4)[1], 
                                          alpha=.15, 
                                          yLabels = ci_total_big[i, ]$diamondlabels, 
                                          fixedSize = 0.3, 
                                          xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_edutrack_big[i, ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(4)[2], 
                                   alpha=.15, 
                                   yLabels = ci_edutrack_big[i, ]$diamondlabels, 
                                   fixedSize = 0.5, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_uncorrected_big[i, ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(4)[3], 
                                   alpha=.15, 
                                   yLabels = ci_uncorrected_big[i, ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_sandwich_big[i, ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(4)[4], 
                                   alpha=.15, 
                                   yLabels = ci_uncorrected_big[i, ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) + 
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom & school"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom, school & track"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Uncorrected"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Sandwich"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  scale_fill_manual('Model',
                    values = c(viridis::viridis(4)[1], 
                               viridis::viridis(4)[2], 
                               viridis::viridis(4)[4], 
                               viridis::viridis(4)[3]),
                    guide = guide_legend(override.aes = list(alpha = 1), ncol = 2)) +
  theme(legend.position="right") 
  plot(plot1)
}
```


## Other variables

```{r estimates for other variables, results = "asis", fig.show = "asis"}
# Take the high-mean variables out, because otherwise you'd have something with a mean of 200 
# and a mean of 2 in the same plot, and scaling of the x-axis would smudge differences between the
# diamonds, which indicate the estimates

ci_total_small <- ci_total %>% dplyr::filter(mean <= 10)
ci_edutrack_small <- ci_edutrack %>% dplyr::filter(mean <= 10)
ci_uncorrected_small <- ci_uncorrected %>% dplyr::filter(mean <= 10)
ci_sandwich_small <- ci_sandwich %>% dplyr::filter(mean <= 10)

# Now, four data frames contain columns ciLo, mean, ciHi, and variable name, for each variable (i.e. row).
# Make a diamondPlot layer from each of these data frames, so that i number of variables are in the same plot: 

for (i in c(seq(from = 1, to = 171, by = 8))) {
plot1 <- userfriendlyscience::diamondPlot(ci_total_small[i:(i + 8), ], 
                                          color = viridis::viridis(4)[1], 
                                          alpha=.15, 
                                          yLabels = ci_total_small[i:(i + 8), ]$diamondlabels, 
                                          fixedSize = 0.3, 
                                          xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_edutrack_small[i:(i + 8), ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(4)[2], 
                                   alpha=.15, 
                                   yLabels = ci_edutrack_small[i:(i + 8), ]$diamondlabels, 
                                   fixedSize = 0.5, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_uncorrected_small[i:(i + 8), ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(4)[3], 
                                   alpha=.15, 
                                   yLabels = ci_uncorrected_small[i:(i + 8), ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) +
  userfriendlyscience::diamondPlot(ci_sandwich_small[i:(i + 8), ], 
                                   returnLayerOnly = TRUE,
                                   color = viridis::viridis(4)[4], 
                                   alpha=.15, 
                                   yLabels = ci_uncorrected_small[i:(i + 8), ]$diamondlabels, 
                                   fixedSize = 0.3, 
                                   xlab = NULL) + 
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom & school"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Classroom, school & track"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Uncorrected"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  geom_rect(aes(xmin=Inf, xmax=Inf, ymin=Inf, ymax=Inf, fill = "Sandwich"), 
            colour=NA, alpha=0.05) + # Create invisible rectangle for legend
  scale_fill_manual('Model: ',
                    values = c(viridis::viridis(4)[1], 
                               viridis::viridis(4)[2], 
                               viridis::viridis(4)[4], 
                               viridis::viridis(4)[3]),
                    guide = guide_legend(override.aes = list(alpha = 1), ncol = 2)) +
  theme(legend.position="bottom") 
#  cat('\n\n####', i, '\n\n  ') 
  print(plot1)
}
```


```{r ci-widths}


CI_widths <- data.frame(
  "Label" = ci_total$diamondlabels,
  "Classroom & school" = (ci_total$ciHi - ci_total$ciLo), 
  "Classroom, school & track" = (ci_edutrack$ciHi - ci_edutrack$ciLo), 
  "Uncorrected" = (ci_uncorrected$ciHi - ci_uncorrected$ciLo),
  "Sandwich" = (ci_sandwich$ciHi - ci_sandwich$ciLo)) %>% 
  dplyr::arrange(Sandwich)

CI_widths %>%
  dplyr::mutate(Label = as.numeric(as.factor(ci_total$diamondlabels)))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    ggtitle("All variables")

CI_widths %>%
  dplyr::mutate(Label = paste(ci_total$diamondlabels,
                              as.numeric(as.factor(ci_total$diamondlabels))))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(75, 100), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into bumps")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(81, 83), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into first bump")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(87, 89), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into second bump")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(92, 96), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into third bump")

CI_widths %>%
  dplyr::mutate(Label = (ci_total$diamondlabels))  %>% 
  tidyr::gather(estimator, value, 2:Sandwich) %>% 
  ggplot2::ggplot(aes(x = Label, y = value, group = estimator)) +
    geom_line(aes(color = estimator)) +
    coord_cartesian(xlim = c(97, 99), ylim = c(0, 100)) +
    theme(axis.text.x=element_text(angle = 45, hjust = 1)) +
    ggtitle("Zoomed into fourth bump")

# # test to see all labels are in the right order
# data.frame(
#   Label = ci_total$diamondlabels,
#   label2 = ci_edutrack$diamondlabels,
#   label3 = ci_uncorrected$diamondlabels,
#   label4 = ci_sandwich) %>% rowwise %>% 
#   dplyr::mutate(test1 = ifelse(Label == label2, "OK",
#                         ifelse(label2 == label3, "OK", 
#                                ifelse(label3 == label4, "OK", "DISCREPANCY"))))

```


Create confidence bounds for all items by gender and intervention allocation

These numbers are visualised with diamond plots later.

```{r CIs-for-diamondplots}
# names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)
# 
# # Intercepts for boys; when boy is 1, girl is 0, but boy is a factor, so intercept is for boys even though boy is 1 for boys and 0 for girls.
# m.boys <- NA
# mean.boys <- NA
# m_p.boys <- NA
# ci_low.boys <- NA
# ci_high.boys <- NA
# ICC_group.boys <- NA
# ICC_School.boys <- NA
# nonmissings.boys <- NA
# 
# df.boys <- df %>% dplyr::mutate(boy = factor(ifelse(girl == "girl", 0, 1), levels = c(1, 0)))
# 
# for (i in names){
# m.boys <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + boy"), data=df.boys)
# mean.boys[i] <- lme4::fixef(m.boys)[1]
# m_p.boys <- profile(m.boys, which = "beta_")
# ci_low.boys[i] <- confint(m_p.boys)[1, 1]
# ci_high.boys[i] <- confint(m_p.boys)[1, 2]
# ICC_group.boys[i] <- sjstats::icc(m.boys)[1]
# ICC_School.boys[i] <- sjstats::icc(m.boys)[2]
# nonmissings.boys[i] <- length(m.boys@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for girls:", labels(lme4::fixef(m.boys))[2] == "boy0")
# 
# ci_boys <- data.frame(ciLo = ci_low.boys, mean = mean.boys, ciHi = ci_high.boys)
# diamondlabels <- labels(ci_boys)[[1]]
# ci_boys <- data.frame(ci_boys, diamondlabels)
# 
# # Intercepts for girls; when boy is 1, girl is 0, but boy is a factor, so intercept is for girls even though girl is 1 for girls and 0 for boys.
# m.girls <- NA
# mean.girls <- NA
# m_p.girls <- NA
# ci_low.girls <- NA
# ci_high.girls <- NA
# ICC_group.girls <- NA
# ICC_School.girls <- NA
# nonmissings.girls <- NA
# 
# for (i in names){
# m.girls <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + girl"), data=df)
# mean.girls[i] <- lme4::fixef(m.girls)[1]
# m_p.girls <- profile(m.girls, which = "beta_")
# ci_low.girls[i] <- confint(m_p.girls)[1, 1]
# ci_high.girls[i] <- confint(m_p.girls)[1, 2]
# ICC_group.girls[i] <- sjstats::icc(m.girls)[1]
# ICC_School.girls[i] <- sjstats::icc(m.girls)[2]
# nonmissings.girls[i] <- length(m.girls@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for boys:", labels(lme4::fixef(m.girls))[2] == "girl0")
# 
# ci_girls <- data.frame(ciLo = ci_low.girls, mean = mean.girls, ciHi = ci_high.girls)
# diamondlabels <- labels(ci_girls)[[1]]
# ci_girls <- data.frame(ci_girls, diamondlabels)
# 
# 
# # Intercepts for intervention
# m.intervention <- NA
# mean.intervention <- NA
# m_p.intervention <- NA
# ci_low.intervention <- NA
# ci_high.intervention <- NA
# ICC_group.intervention <- NA
# ICC_School.intervention <- NA
# nonmissings.intervention <- NA
# 
# ## change "intervention" to be consistent regarding level order with "girl".
# df.intervention <- df %>% dplyr::mutate(intervention = factor(intervention, levels = c(1, 0)))
# 
# for (i in names){
# m.intervention <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + intervention"), data=df.intervention)
# mean.intervention[i] <- lme4::fixef(m.intervention)[1]
# m_p.intervention <- profile(m.intervention, which = "beta_")
# ci_low.intervention[i] <- confint(m_p.intervention)[1, 1]
# ci_high.intervention[i] <- confint(m_p.intervention)[1, 2]
# ICC_group.intervention[i] <- sjstats::icc(m.intervention)[1]
# ICC_School.intervention[i] <- sjstats::icc(m.intervention)[2]
# nonmissings.intervention[i] <- length(m.intervention@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for control:", labels(lme4::fixef(m.intervention))[2] == "intervention0")
# 
# ci_intervention <- data.frame(ciLo = ci_low.intervention, mean = mean.intervention, ciHi = ci_high.intervention)
# diamondlabels <- labels(ci_intervention)[[1]]
# ci_intervention <- data.frame(ci_intervention, diamondlabels)
# 
# # Intercepts for control
# 
# m.control <- NA
# mean.control <- NA
# m_p.control <- NA
# ci_low.control <- NA
# ci_high.control <- NA
# ICC_group.control <- NA
# ICC_School.control <- NA
# nonmissings.control <- NA
# 
# df.control <- df %>% dplyr::mutate(control = factor(ifelse(intervention == 1, 0, 1), levels = c(1, 0)))
# 
# for (i in names){
# m.control <- lme4::lmer(paste0(i," ~ (1|school) + (1|group) + control"), data=df.control)
# mean.control[i] <- lme4::fixef(m.control)[1]
# m_p.control <- profile(m.control, which = "beta_")
# ci_low.control[i] <- confint(m_p.control)[1, 1]
# ci_high.control[i] <- confint(m_p.control)[1, 2]
# ICC_group.control[i] <- sjstats::icc(m.control)[1]
# ICC_School.control[i] <- sjstats::icc(m.control)[2]
# nonmissings.control[i] <- length(m.control@resp$y)
# }
# 
# cat("The labels are arranged such that intercept is not for intervention:", labels(lme4::fixef(m.control))[2] == "control0")
# 
# ci_control <- data.frame(ciLo = ci_low.control, mean = mean.control, ciHi = ci_high.control)
# diamondlabels <- labels(ci_control)[[1]]
# ci_control <- data.frame(ci_control, diamondlabels)

# # # Same ICC results you'd get with e.g.:
# # m1 <- as.data.frame(VarCorr(m))
# # m1$vcov[1] / (m1$vcov[1] + m1$vcov[3])
# 
# # Or from broom:
# # tidy(m)$estimate[2]^2 / (tidy(m)$estimate[2]^2 + tidy(m)$estimate[4]^2)
# 
# # Or from sjstats:
# # sum(get_re_var(m)) / (sum(get_re_var(m)) + get_re_var(m, "sigma_2"))
# 
# # save(ci_control, file = "ci_control.Rdata")
# # save(ci_intervention, file = "ci_intervention.Rdata")
# # save(ci_girls, file = "ci_girls.Rdata")
# # save(ci_boys, file = "ci_boys.Rdata")

load("ci_control.Rdata")
load("ci_intervention.Rdata")
load("ci_girls.Rdata")
load("ci_boys.Rdata")
```

<!-- ### Gender and intervention group CIs with sandwich estimator -->
<!-- NOT INCLUDED, because the line beginning with "sandwich_se <- diag(..." gives a negative sandwich variance estimate, which can't be square-rooted -->

```{r sandwich_genderintervention, include = FALSE, eval = FALSE}
# Basic instructions are from https://web.archive.org/web/20180206180739/http://thestatsgeek.com/2014/02/14/the-robust-sandwich-variance-estimator-for-linear-regression-using-r/

names <- df %>% dplyr::select(-id, -intervention, -group, -school, -girl, -track, -trackSchool, -contains("_T3"), -contains("_diff")) %>% names(.)

# Create empty soon-to-be-filled objects
m <- NA
sandwich_se <- NA
mean_girl <- NA
mean_boy <- NA
ci_low_girl <- NA
ci_high_girl <- NA
ci_low_boy <- NA
ci_high_boy <- NA
nonmissings <- NA

# To test the code with a single variable:
df_for_sandwich <- df %>% dplyr::select(group, school, track, girl, sitLieAccelerometer_T1) %>% na.omit()
sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track, girl)
m <- lm(sitLieAccelerometer_T1 ~ girl, data=df_for_sandwich)
sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5

mean_girl <- m$coefficients[[1]]
mean_boy <- m$coefficients[[1]] + m$coefficients[[2]]

ci_low_girl <- mean_girl - 1.96 * sandwich_se
ci_high_girl <- mean_girl + 1.96 * sandwich_se
ci_low_boy <- mean_boy - 1.96 * sandwich_se
ci_high_boy <- mean_boy + 1.96 * sandwich_se

nonmissings <- nrow(m$model)


# # Loop over each variable name, extract statistics:
for (i in names){
df_for_sandwich <- df %>% dplyr::select(
  group, school, track, girl, i) %>%
  na.omit()
sandwich_clusters <- df_for_sandwich %>% dplyr::select(group, school, track, girl)
m <- lm(paste0(i," ~ girl"), data = df_for_sandwich)
sandwich_se <- diag(sandwich::vcovCL(m, type = "HC1", cluster = sandwich_clusters))^0.5
 
mean_girl[i] <- m$coefficients[[1]]
mean_boy[i] <- m$coefficients[[1]] + m$coefficients[[2]]
 
ci_low_girl[i] <- m$coefficients[[1]] - 1.96 * sandwich_se
ci_high_girl[i] <- mean_girl + 1.96 * sandwich_se
ci_low_boy[i] <- mean_boy - 1.96 * sandwich_se
ci_high_boy[i] <- mean_boy + 1.96 * sandwich_se

nonmissings[i] <- nrow(m$model)
}

vardatatable_sandwich <- data_frame(
  Variable = stringr::str_sub(names(mean), end = -4), #remove "_T1" from names
  Mean = round(mean, 1),
  CI95 = paste(round(ci_low, 1), "-", round(ci_high, 1)),
  n = nonmissings) %>%
  dplyr::arrange(Variable) %>%
  dplyr::filter(Variable != "") #remove first row, which is empty

save(vardatatable_sandwich, file = "vardatatable_sandwich.Rdata")
load("vardatatable_sandwich.Rdata")

ci_sandwich <- data_frame(
  "ciLo" = ci_low,
  "mean" = mean,
  "ciHi" = ci_high,
  "diamondlabels" = names(mean)) %>%
  dplyr::filter(diamondlabels != "") %>% #remove first row, which is empty
  as.data.frame()

save(ci_sandwich, file = "ci_sandwich.Rdata")
load("ci_sandwich.Rdata")
```

# Descriptive tables

Next code chunk prepares data.

```{r demographics-prep}

demographics <- lmi %>% dplyr::select(id = ID,
  birthYear = Kys0004.1,
  surveyDate = StartDateTime.1,
  intervention = ryhma,
  school = Aineisto.1,
  girl = Kys0013.1,
  ethnicity = Kys0005.1,
  studyYear = Kys0014.1) %>% 
  dplyr::mutate(
    surveyYear = lubridate::year(surveyDate),
    age = as.numeric(surveyYear) - as.numeric(birthYear),
    intervention = ifelse(intervention == 1, 1, 0),
    intervention = as.numeric(intervention, levels = c("0", "1")),
    girl = ifelse(girl == "2", 1, 0),
    girl = as.numeric(girl, levels = c("1", "0")),
    school = factor(school, levels = c("1", "2", "3", "4", "5")),
    bornInFinland = as.numeric(ifelse(ethnicity == 1, 1, 0)),
    studyYear = ifelse(as.numeric(studyYear) == 0, NA, as.numeric(studyYear))) %>%  # Remove "other" from study year
  dplyr::select(-surveyDate, -surveyYear)

# Insert track variable with those who answered "other" with one of the actual category labels given the appropriate category:
Track <- lmi %>% dplyr::select(Kys0016.1, Kys0017.1) %>% dplyr::mutate(
  Kys0016.1 = as.character(Kys0016.1), # Because I had an Evaluation error: `x` and `labels` must be same type.
  Kys0017.1 = as.character(Kys0017.1),
  Kys0016.1 = ifelse(Kys0017.1 == "Merkonomi" | Kys0017.1 == "merkonomi", 3,
                     ifelse(Kys0017.1 == "Datanomi" | Kys0017.1 == "datanomi", 2, Kys0016.1)),
  Track = factor(Kys0016.1, # Fix track labels first
                 levels = c(0, 1, 2, 3, 4),
                 labels = c("Other", "IT", "BA", "HRC", "Nur"))) %>% 
  dplyr::select(-Kys0016.1, -Kys0017.1)

demographics <- bind_cols(demographics, Track)
```

## Create demographic tables

### By educational track

```{r demographics-table-track, results = 'asis'}
demotable <- demographics %>% 
  dplyr::filter(track != "Other") %>% 
  dplyr::group_by(Track) %>% 
  dplyr::summarise("Mean age (range)" = paste0(round(mean(age, na.rm = T), 1)," (", 
                                        range(age, na.rm = T)[1], "-",
                                        range(age, na.rm = T)[2], ")"),
            "Mean study year (sd)" = paste0(round(mean(studyYear, na.rm = T), 1)," (", 
                                               round(sd(studyYear, na.rm = T), 1), ")"),
            "% girl" = round(mean(girl, na.rm = TRUE)*100, 1),
            "% intervention" = round(mean(intervention, na.rm = T)*100, 1),
            "% born in Finland" = round(mean(bornInFinland, na.rm = T)*100, 1),
            n = n()) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  dplyr::arrange(desc(Track)) 

demotable_total <- demographics %>% 
  summarise("Track" = "Full sample",
            "Mean age (range)" = paste0(round(mean(age, na.rm = T), 1)," (", 
                                        range(age, na.rm = T)[1], "-",
                                        range(age, na.rm = T)[2], ")"),
            "Mean study year (sd)" = paste0(round(mean(studyYear, na.rm = T), 1)," (", 
                                               round(sd(studyYear, na.rm = T), 1), ")"),
            "% girl" = round(mean(girl, na.rm = T)*100, 1),
            "% intervention" = round(mean(intervention, na.rm = T)*100, 1),
            "% born in Finland" = round(mean(bornInFinland, na.rm = T)*100, 1),
            n = n())

demotable <- bind_rows(demotable, demotable_total)

demotable <- demotable %>% tidyr::gather(Variable, val, 2:ncol(demotable)) %>% tidyr::spread(Track, val)

# For some reason, sum of n's of all tracks is 1084.

papaja::apa_table(demotable, caption = "Baseline demographics of educational tracks", digits = c(0, 1, 1, 1, 1, 1, 0))
```

### By gender

```{r demographics-table-gender, results = 'asis'}
demographics$Girl <- factor(demographics$girl)

demotable <- demographics %>% 
  group_by(Girl) %>% 
  summarise("Mean age (range)" = paste0(round(mean(age, na.rm = T), 1)," (", 
                                        range(age, na.rm = T)[1], "-",
                                        range(age, na.rm = T)[2], ")"),
            "Mean study year (sd)" = paste0(round(mean(studyYear, na.rm = T), 1)," (", 
                                               round(sd(studyYear, na.rm = T), 1), ")"),
            "% intervention" = round(mean(as.numeric(intervention), na.rm = T)*100, 1),
            "% born in Finland" = round(mean(bornInFinland, na.rm = T)*100, 1),
            n = n()) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  arrange(desc(Girl)) 

demotable_total <- demographics %>% 
  summarise("Girl" = "Full sample",
            "Mean age (range)" = paste0(round(mean(age, na.rm = T), 1)," (", 
                                        range(age, na.rm = T)[1], "-",
                                        range(age, na.rm = T)[2], ")"),
            "Mean study year (sd)" = paste0(round(mean(studyYear, na.rm = T), 1)," (", 
                                               round(sd(studyYear, na.rm = T), 1), ")"),
            "% intervention" = round(mean(intervention, na.rm = T)*100, 1),
            "% born in Finland" = round(mean(bornInFinland, na.rm = T)*100, 1),
            n = n())

demotable <- bind_rows(demotable, demotable_total)

demotable <- demotable %>% tidyr::gather(Variable, val, 2:ncol(demotable)) %>% tidyr::spread(Girl, val)

names(demotable) <- c("", "Boy", "Girl", "Full sample")

# For some reason, sum of n's of all tracks is 1084.

papaja::apa_table(demotable, caption = "Baseline demographics of educational tracks", digits = c(0, 1, 1, 1, 1, 0))
```

### By intervention participation

```{r demographics-table-intervention, results = 'asis'}
demographics$intervention <- factor(demographics$intervention)
demographics$girl <- as.numeric(demographics$girl)

demotable <- demographics %>% 
  group_by(intervention) %>% 
  summarise("Mean age (range)" = paste0(round(mean(age, na.rm = T), 1)," (", 
                                        range(age, na.rm = T)[1], "-",
                                        range(age, na.rm = T)[2], ")"),
            "Mean study year (sd)" = paste0(round(mean(studyYear, na.rm = T), 1)," (", 
                                               round(sd(studyYear, na.rm = T), 1), ")"),
            "% girl" = round(mean(girl, na.rm = T)*100, 1),
            "% born in Finland" = round(mean(bornInFinland, na.rm = T)*100, 1),
            n = n()) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  arrange(desc(intervention)) 

demotable_total <- demographics %>% 
  summarise("intervention" = "Full sample",
            "Mean age (range)" = paste0(round(mean(age, na.rm = T), 1)," (", 
                                        range(age, na.rm = T)[1], "-",
                                        range(age, na.rm = T)[2], ")"),
            "Mean study year (sd)" = paste0(round(mean(studyYear, na.rm = T), 1)," (", 
                                               round(sd(studyYear, na.rm = T), 1), ")"),
            "% girl" = round(mean(girl, na.rm = T)*100, 1),
            "% born in Finland" = round(mean(bornInFinland, na.rm = T)*100, 1),
            n = n())

demotable <- bind_rows(demotable, demotable_total)

demotable <- demotable %>% tidyr::gather(Variable, val, 2:ncol(demotable)) %>% tidyr::spread(intervention, val)

names(demotable) <- c("", "Control", "Intervention", "Full sample")

# For some reason, sum of n's of all tracks is 1084.

papaja::apa_table(demotable, caption = "Baseline demographics of educational tracks", digits = c(0, 1, 1, 1, 1, 0))
```

## Create outcome tables

```{r outcome-table, results = 'asis'}

outtable_track <- df %>%
  dplyr::select(paAccelerometer_T1, sitLieAccelerometer_T1, sitBreaks_T1, # Main outcomes 
          PA_actionplan_T1,
          PA_copingplan_T1,
          PA_agrbct_T1,
          PA_frqbct_T1,
          PA_amotivation_T1,
          PA_autonomous_T1,
          PA_controlled_T1,
          PA_goal_T1,
          PA_inorm_T1,
          PA_dnorm_T1,
          PA_intention_T1,
          PA_outcomeExpectations_T1,
          PA_opportunities_T1,
          PA_pbc_T1,
          PA_selfefficacy_T1,
          SB_dnorm_T1,
          SB_inorm_T1,
          SB_intention_T1,
          SB_outcomeExpectations_T1,
          SB_sePbc_T1,
         track, girl, intervention) %>% 
  group_by(track) %>% 
  summarise(
            'PA action planning' = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1), " (", round(sd(PA_actionplan_T1, na.rm = T), 1), ")"),
            'PA coping planning' = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1), ' (', round(sd(PA_copingplan_T1, na.rm = T), 1), ')'),
            'PA agreement-BCTs' = paste0(round(mean(PA_agrbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_agrbct_T1, na.rm = T), 1), ')'),
            'PA frequency-BCTs' = paste0(round(mean(PA_frqbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_frqbct_T1, na.rm = T), 1), ')'),
            'PA amotivation' = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1), ' (', round(sd(PA_amotivation_T1, na.rm = T), 1), ')'),
            'PA autonomous regulation' = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1), ' (', round(sd(PA_autonomous_T1, na.rm = T), 1), ')'),
            'PA controlled regulation' = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1), ' (', round(sd(PA_controlled_T1, na.rm = T), 1), ')'),
            'PA injunctive norm' = paste0(round(mean(PA_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_inorm_T1, na.rm = T), 1), ')'),
            'PA descriptive norm' = paste0(round(mean(PA_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_dnorm_T1, na.rm = T), 1), ')'),
            'PA intention' = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1), ' (', round(sd(PA_intention_T1, na.rm = T), 1), ')'),
            'PA outcome expectations' = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(PA_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'PA opportunities' = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1), ' (', round(sd(PA_opportunities_T1, na.rm = T), 1), ')'),
            'PA perceived behavioural control' = paste0(round(mean(PA_pbc_T1, na.rm = TRUE), 1), ' (', round(sd(PA_pbc_T1, na.rm = T), 1), ')'),
            'PA self-efficacy' = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1), ' (', round(sd(PA_selfefficacy_T1, na.rm = T), 1), ')'),
            'SB descriptive norm' = paste0(round(mean(SB_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_dnorm_T1, na.rm = T), 1), ')'),
            'SB injunctive norm' = paste0(round(mean(SB_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_inorm_T1, na.rm = T), 1), ')'),
            'SB intention' = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1), ' (', round(sd(SB_intention_T1, na.rm = T), 1), ')'),
            'SB outcome expectations' = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(SB_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'SB self-efficacy & perceived behavioural control' = paste0(round(mean(SB_sePbc_T1, na.rm = TRUE), 1), ' (', round(sd(SB_sePbc_T1, na.rm = T), 1), ')'),

            "Mean daily MVPA minutes" = paste0(round(mean(paAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(paAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(sitLieAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaks_T1, na.rm = T), 1)," (", 
                                        round(sd(sitBreaks_T1, na.rm = T), 1), ")"),
            n = n()) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  arrange(desc(track)) %>% 
  dplyr::filter(track != "Other")

outtable_intervention <- df %>%
  dplyr::select(paAccelerometer_T1, sitLieAccelerometer_T1, sitBreaks_T1, # Main outcomes 
          PA_actionplan_T1,
          PA_copingplan_T1,
          PA_agrbct_T1,
          PA_frqbct_T1,
          PA_amotivation_T1,
          PA_autonomous_T1,
          PA_controlled_T1,
          PA_goal_T1,
          PA_inorm_T1,
          PA_dnorm_T1,
          PA_intention_T1,
          PA_outcomeExpectations_T1,
          PA_opportunities_T1,
          PA_pbc_T1,
          PA_selfefficacy_T1,
          SB_dnorm_T1,
          SB_inorm_T1,
          SB_intention_T1,
          SB_outcomeExpectations_T1,
          SB_sePbc_T1,
         track, girl, intervention) %>% 
  group_by(intervention) %>% 
  summarise(
            'PA action planning' = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1), " (", round(sd(PA_actionplan_T1, na.rm = T), 1), ")"),
            'PA coping planning' = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1), ' (', round(sd(PA_copingplan_T1, na.rm = T), 1), ')'),
            'PA agreement-BCTs' = paste0(round(mean(PA_agrbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_agrbct_T1, na.rm = T), 1), ')'),
            'PA frequency-BCTs' = paste0(round(mean(PA_frqbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_frqbct_T1, na.rm = T), 1), ')'),
            'PA amotivation' = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1), ' (', round(sd(PA_amotivation_T1, na.rm = T), 1), ')'),
            'PA autonomous regulation' = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1), ' (', round(sd(PA_autonomous_T1, na.rm = T), 1), ')'),
            'PA controlled regulation' = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1), ' (', round(sd(PA_controlled_T1, na.rm = T), 1), ')'),
            'PA injunctive norm' = paste0(round(mean(PA_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_inorm_T1, na.rm = T), 1), ')'),
            'PA descriptive norm' = paste0(round(mean(PA_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_dnorm_T1, na.rm = T), 1), ')'),
            'PA intention' = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1), ' (', round(sd(PA_intention_T1, na.rm = T), 1), ')'),
            'PA outcome expectations' = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(PA_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'PA opportunities' = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1), ' (', round(sd(PA_opportunities_T1, na.rm = T), 1), ')'),
            'PA perceived behavioural control' = paste0(round(mean(PA_pbc_T1, na.rm = TRUE), 1), ' (', round(sd(PA_pbc_T1, na.rm = T), 1), ')'),
            'PA self-efficacy' = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1), ' (', round(sd(PA_selfefficacy_T1, na.rm = T), 1), ')'),
            'SB descriptive norm' = paste0(round(mean(SB_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_dnorm_T1, na.rm = T), 1), ')'),
            'SB injunctive norm' = paste0(round(mean(SB_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_inorm_T1, na.rm = T), 1), ')'),
            'SB intention' = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1), ' (', round(sd(SB_intention_T1, na.rm = T), 1), ')'),
            'SB outcome expectations' = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(SB_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'SB self-efficacy & perceived behavioural control' = paste0(round(mean(SB_sePbc_T1, na.rm = TRUE), 1), ' (', round(sd(SB_sePbc_T1, na.rm = T), 1), ')'),

            "Mean daily MVPA minutes" = paste0(round(mean(paAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(paAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(sitLieAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaks_T1, na.rm = T), 1)," (", 
                                        round(sd(sitBreaks_T1, na.rm = T), 1), ")"),
            n = n()) %>% 
  dplyr::filter(complete.cases(.))

outtable_girl <- df %>%
  dplyr::select(paAccelerometer_T1, sitLieAccelerometer_T1, sitBreaks_T1, # Main outcomes 
          PA_actionplan_T1,
          PA_copingplan_T1,
          PA_agrbct_T1,
          PA_frqbct_T1,
          PA_amotivation_T1,
          PA_autonomous_T1,
          PA_controlled_T1,
          PA_goal_T1,
          PA_inorm_T1,
          PA_dnorm_T1,
          PA_intention_T1,
          PA_outcomeExpectations_T1,
          PA_opportunities_T1,
          PA_pbc_T1,
          PA_selfefficacy_T1,
          SB_dnorm_T1,
          SB_inorm_T1,
          SB_intention_T1,
          SB_outcomeExpectations_T1,
          SB_sePbc_T1,
         track, girl, intervention) %>% 
  group_by(girl) %>% 
  summarise(
            'PA action planning' = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1), " (", round(sd(PA_actionplan_T1, na.rm = T), 1), ")"),
            'PA coping planning' = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1), ' (', round(sd(PA_copingplan_T1, na.rm = T), 1), ')'),
            'PA agreement-BCTs' = paste0(round(mean(PA_agrbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_agrbct_T1, na.rm = T), 1), ')'),
            'PA frequency-BCTs' = paste0(round(mean(PA_frqbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_frqbct_T1, na.rm = T), 1), ')'),
            'PA amotivation' = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1), ' (', round(sd(PA_amotivation_T1, na.rm = T), 1), ')'),
            'PA autonomous regulation' = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1), ' (', round(sd(PA_autonomous_T1, na.rm = T), 1), ')'),
            'PA controlled regulation' = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1), ' (', round(sd(PA_controlled_T1, na.rm = T), 1), ')'),
            'PA injunctive norm' = paste0(round(mean(PA_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_inorm_T1, na.rm = T), 1), ')'),
            'PA descriptive norm' = paste0(round(mean(PA_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_dnorm_T1, na.rm = T), 1), ')'),
            'PA intention' = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1), ' (', round(sd(PA_intention_T1, na.rm = T), 1), ')'),
            'PA outcome expectations' = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(PA_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'PA opportunities' = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1), ' (', round(sd(PA_opportunities_T1, na.rm = T), 1), ')'),
            'PA perceived behavioural control' = paste0(round(mean(PA_pbc_T1, na.rm = TRUE), 1), ' (', round(sd(PA_pbc_T1, na.rm = T), 1), ')'),
            'PA self-efficacy' = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1), ' (', round(sd(PA_selfefficacy_T1, na.rm = T), 1), ')'),
            'SB descriptive norm' = paste0(round(mean(SB_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_dnorm_T1, na.rm = T), 1), ')'),
            'SB injunctive norm' = paste0(round(mean(SB_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_inorm_T1, na.rm = T), 1), ')'),
            'SB intention' = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1), ' (', round(sd(SB_intention_T1, na.rm = T), 1), ')'),
            'SB outcome expectations' = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(SB_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'SB self-efficacy & perceived behavioural control' = paste0(round(mean(SB_sePbc_T1, na.rm = TRUE), 1), ' (', round(sd(SB_sePbc_T1, na.rm = T), 1), ')'),

            "Mean daily MVPA minutes" = paste0(round(mean(paAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(paAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(sitLieAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaks_T1, na.rm = T), 1)," (", 
                                        round(sd(sitBreaks_T1, na.rm = T), 1), ")"),
            n = n()) %>% 
  dplyr::filter(complete.cases(.))

outtable_total <- df %>% 
  summarise('girl' = "Full sample",
            'PA action planning' = paste0(round(mean(PA_actionplan_T1, na.rm = TRUE), 1), " (", round(sd(PA_actionplan_T1, na.rm = T), 1), ")"),
            'PA coping planning' = paste0(round(mean(PA_copingplan_T1, na.rm = TRUE), 1), ' (', round(sd(PA_copingplan_T1, na.rm = T), 1), ')'),
            'PA agreement-BCTs' = paste0(round(mean(PA_agrbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_agrbct_T1, na.rm = T), 1), ')'),
            'PA frequency-BCTs' = paste0(round(mean(PA_frqbct_T1, na.rm = TRUE), 1), ' (', round(sd(PA_frqbct_T1, na.rm = T), 1), ')'),
            'PA amotivation' = paste0(round(mean(PA_amotivation_T1, na.rm = TRUE), 1), ' (', round(sd(PA_amotivation_T1, na.rm = T), 1), ')'),
            'PA autonomous regulation' = paste0(round(mean(PA_autonomous_T1, na.rm = TRUE), 1), ' (', round(sd(PA_autonomous_T1, na.rm = T), 1), ')'),
            'PA controlled regulation' = paste0(round(mean(PA_controlled_T1, na.rm = TRUE), 1), ' (', round(sd(PA_controlled_T1, na.rm = T), 1), ')'),
            'PA injunctive norm' = paste0(round(mean(PA_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_inorm_T1, na.rm = T), 1), ')'),
            'PA descriptive norm' = paste0(round(mean(PA_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(PA_dnorm_T1, na.rm = T), 1), ')'),
            'PA intention' = paste0(round(mean(PA_intention_T1, na.rm = TRUE), 1), ' (', round(sd(PA_intention_T1, na.rm = T), 1), ')'),
            'PA outcome expectations' = paste0(round(mean(PA_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(PA_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'PA opportunities' = paste0(round(mean(PA_opportunities_T1, na.rm = TRUE), 1), ' (', round(sd(PA_opportunities_T1, na.rm = T), 1), ')'),
            'PA perceived behavioural control' = paste0(round(mean(PA_pbc_T1, na.rm = TRUE), 1), ' (', round(sd(PA_pbc_T1, na.rm = T), 1), ')'),
            'PA self-efficacy' = paste0(round(mean(PA_selfefficacy_T1, na.rm = TRUE), 1), ' (', round(sd(PA_selfefficacy_T1, na.rm = T), 1), ')'),
            'SB descriptive norm' = paste0(round(mean(SB_dnorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_dnorm_T1, na.rm = T), 1), ')'),
            'SB injunctive norm' = paste0(round(mean(SB_inorm_T1, na.rm = TRUE), 1), ' (', round(sd(SB_inorm_T1, na.rm = T), 1), ')'),
            'SB intention' = paste0(round(mean(SB_intention_T1, na.rm = TRUE), 1), ' (', round(sd(SB_intention_T1, na.rm = T), 1), ')'),
            'SB outcome expectations' = paste0(round(mean(SB_outcomeExpectations_T1, na.rm = TRUE), 1), ' (', round(sd(SB_outcomeExpectations_T1, na.rm = T), 1), ')'),
            'SB self-efficacy & perceived behavioural control' = paste0(round(mean(SB_sePbc_T1, na.rm = TRUE), 1), ' (', round(sd(SB_sePbc_T1, na.rm = T), 1), ')'),

            "Mean daily MVPA minutes" = paste0(round(mean(paAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(paAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily minutes spent sitting or lying down" = paste0(round(mean(sitLieAccelerometer_T1, na.rm = T), 1)," (", 
                                        round(sd(sitLieAccelerometer_T1, na.rm = T), 1), ")"),
            "Mean daily breaks in sitting" = paste0(round(mean(sitBreaks_T1, na.rm = T), 1)," (", 
                                        round(sd(sitBreaks_T1, na.rm = T), 1), ")"),
            n = n())



# Transpose each table
outtable_track <- outtable_track %>% tidyr::gather(Variable, val, 2:ncol(.)) %>% tidyr::spread(track, val)

outtable_intervention <- outtable_intervention %>% tidyr::gather(Variable, val, 2:ncol(.)) %>% tidyr::spread(intervention, val)
names(outtable_intervention) <- c("Variable", "Control", "Intervention")

## In the last table, have a column for total before transposing
outtable_girl <- bind_rows(outtable_girl, outtable_total)
outtable_girl <- outtable_girl %>% tidyr::gather(Variable, val, 2:ncol(.)) %>% tidyr::spread(girl, val)
names(outtable_girl) <- c("Variable", "Boy", "Girl", "Full sample")

# Are all variables the same?
identical(outtable_track$Variable, outtable_girl$Variable)
identical(outtable_track$Variable, outtable_intervention$Variable)

# Create large table with all variables
outtable_mega <- bind_cols(outtable_track, outtable_intervention, outtable_girl) %>% 
  dplyr::select(-Variable1, -Variable2) 

# Move n to be the first row
out1 <- outtable_mega %>% dplyr::filter(Variable == "n")
out2 <- outtable_mega %>% dplyr::filter(Variable != "n")
outtable_mega <- bind_rows(out1, out2)

# Fix names: leave first blank, have the rest as they were
names(outtable_mega) <- c("", names(outtable_mega)[2:(length(names(outtable_mega)))])

papaja::apa_table(outtable_mega, caption = "Baseline demographics of educational tracks")


```


## Mediator table with CIs

```{r outcome-table2, results = 'asis'}

mediatortable_intervention <- ci_intervention %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agrbct_T1|PA_frqbct_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_inorm_T1|PA_dnorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_pbc_T1|PA_selfefficacy_T1|SB_dnorm_T1|SB_inorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_intervention$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1), "-", round(ciHi, 1)),
         mean = round(mean, 1))

mediatortable_intervention$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_agrbct_T1', 'PA agreement-BCTs', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_frqbct_T1', 'PA frequency-BCTs', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_inorm_T1', 'PA injunctive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_dnorm_T1', 'PA descriptive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_pbc_T1', 'PA perceived behavioural control', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_dnorm_T1', 'SB descriptive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_inorm_T1', 'SB injunctive norm', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_intervention$diamondlabels)
mediatortable_intervention$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_intervention$diamondlabels)

mediatortable_control <- ci_control %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agrbct_T1|PA_frqbct_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_inorm_T1|PA_dnorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_pbc_T1|PA_selfefficacy_T1|SB_dnorm_T1|SB_inorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_control$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1), "-", round(ciHi, 1)),
         mean = round(mean, 1))

mediatortable_control$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_agrbct_T1', 'PA agreement-BCTs', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_frqbct_T1', 'PA frequency-BCTs', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_inorm_T1', 'PA injunctive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_dnorm_T1', 'PA descriptive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_pbc_T1', 'PA perceived behavioural control', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_dnorm_T1', 'SB descriptive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_inorm_T1', 'SB injunctive norm', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_control$diamondlabels)
mediatortable_control$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_control$diamondlabels)

mediatortable_girls <- ci_girls %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agrbct_T1|PA_frqbct_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_inorm_T1|PA_dnorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_pbc_T1|PA_selfefficacy_T1|SB_dnorm_T1|SB_inorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_girls$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1), "-", round(ciHi, 1)),
         mean = round(mean, 1))

mediatortable_girls$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_agrbct_T1', 'PA agreement-BCTs', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_frqbct_T1', 'PA frequency-BCTs', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_inorm_T1', 'PA injunctive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_dnorm_T1', 'PA descriptive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_pbc_T1', 'PA perceived behavioural control', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_dnorm_T1', 'SB descriptive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_inorm_T1', 'SB injunctive norm', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_girls$diamondlabels)
mediatortable_girls$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_girls$diamondlabels)

mediatortable_boys <- ci_boys %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agrbct_T1|PA_frqbct_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_inorm_T1|PA_dnorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_pbc_T1|PA_selfefficacy_T1|SB_dnorm_T1|SB_inorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_boys$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1), "-", round(ciHi, 1)),
         mean = round(mean, 1))

mediatortable_boys$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_agrbct_T1', 'PA agreement-BCTs', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_frqbct_T1', 'PA frequency-BCTs', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_inorm_T1', 'PA injunctive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_dnorm_T1', 'PA descriptive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_pbc_T1', 'PA perceived behavioural control', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_dnorm_T1', 'SB descriptive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_inorm_T1', 'SB injunctive norm', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_boys$diamondlabels)
mediatortable_boys$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_boys$diamondlabels)

mediatortable_total <- ci_total %>%
  dplyr::filter(grepl('PA_actionplan_T1|PA_copingplan_T1|PA_agrbct_T1|PA_frqbct_T1|PA_amotivation_T1|PA_autonomous_T1|PA_controlled_T1|PA_goal_T1|PA_inorm_T1|PA_dnorm_T1|PA_intention_T1|PA_outcomeExpectations_T1|PA_opportunities_T1|PA_pbc_T1|PA_selfefficacy_T1|SB_dnorm_T1|SB_inorm_T1|SB_intention_T1|SB_outcomeExpectations_T1', ci_total$diamondlabels)) %>% 
  dplyr::filter(diamondlabels != "PA_goal_T1") %>% 
  dplyr::mutate("CI95" = paste(round(ciLo, 1), "-", round(ciHi, 1)),
         mean = round(mean, 1))

mediatortable_total$diamondlabels <- gsub('PA_actionplan_T1', 'PA action planning', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_copingplan_T1', 'PA coping planning', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_agrbct_T1', 'PA agreement-BCTs', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_frqbct_T1', 'PA frequency-BCTs', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_amotivation_T1', 'PA amotivation', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_autonomous_T1', 'PA autonomous regulation', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_controlled_T1', 'PA controlled regulation', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_inorm_T1', 'PA injunctive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_dnorm_T1', 'PA descriptive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_intention_T1', 'PA intention', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_outcomeExpectations_T1', 'PA outcome expectations', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_opportunities_T1', 'PA opportunities', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_pbc_T1', 'PA perceived behavioural control', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('PA_selfefficacy_T1', 'PA self-efficacy', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_dnorm_T1', 'SB descriptive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_inorm_T1', 'SB injunctive norm', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_intention_T1', 'SB intention', mediatortable_total$diamondlabels)
mediatortable_total$diamondlabels <- gsub('SB_outcomeExpectations_T1', 'SB outcome expectations', mediatortable_total$diamondlabels)

mega_mediatortable <- data.frame(Variable = mediatortable_girls$diamondlabels, 
                                 "Girls" = paste0(round(mediatortable_girls$mean, 2), " (", mediatortable_girls$CI95, ")"),
                                 "Boys" = paste0(round(mediatortable_boys$mean, 2), " (", mediatortable_boys$CI95, ")"),
                                 "Intervention" = paste0(round(mediatortable_intervention$mean, 2), " (", mediatortable_intervention$CI95, ")"),
                                 "Control" = paste0(round(mediatortable_control$mean, 2), " (", mediatortable_control$CI95, ")"),
                                 "Total" = paste0(round(mediatortable_total$mean, 2), " (", mediatortable_total$CI95, ")")) %>% 
  arrange(Variable)

papaja::apa_table(mega_mediatortable, caption = "Main mediating variables of PA and SB")


```


# Visualising random effects using full posterior

<!-- TODO: Delete this section? -->

## Using rstanarm

Plot below shows credible intervals deviations  

```{r randeff-plot-rstanarm}

# grep("PA_", names(df), value = TRUE)

# Centre the variable:
df_randeff_plot_rstanarm <- df %>% dplyr::mutate(paAccelerometer_T1_centred = paAccelerometer_T1 - mean(paAccelerometer_T1, na.rm = TRUE))

m_1 <- stan_glmer(paAccelerometer_T1_centred ~ (1 | group), data = df_randeff_plot_rstanarm, chains = 2, iter = 2000) 
pt <- ranef(m_1) 
posteriors <- data.frame(posterior_interval(m_1, prob = 0.90)) 
school_int <- posteriors[-c(1, nrow(posteriors)-1, nrow(posteriors)),] #remove intercept and sigma parameters, leaving only class intervals 

# This not needed any more:
# groupmeans <- df %>% dplyr::select(paAccelerometer_T1, group) %>% group_by(group) %>% 
#   summarise(mean = mean(paAccelerometer_T1, na.rm = T)) %>% dplyr::filter(complete.cases(.))

dat_plt <- data.frame(pt$group, school_int) 
colnames(dat_plt) <- c("pt", "low", "up") 
dat_plt <- dat_plt %>% arrange(pt) 
dat_plt$index <- 1:nrow(dat_plt) 
dat_plt %>% ggplot2::ggplot(aes(x = index, y = pt)) + geom_errorbar(aes(ymin = low, ymax = up)) + geom_point(size = 4, shape = 18) + geom_point(size = 2.5, shape = 18, color = "white") + theme_bw()

```

## Using brms and diamondPlot

Set Rtools folder, if not in C:/Rtools/:
```{r set-binpref}
# For some reason, having BINPREF in .Renviron doesn't work and I keep needing this:
Sys.setenv("BINPREF" = "C:/HYApp/Rtools3.4/mingw_$(WIN)/bin/")
```


```{r randeff-plot-brms-mvpa, fig.height = 4, fig.width = 12, eval = FALSE}

# Centre the variable:
df_randeff_plot_brms <- df %>% dplyr::mutate(paAccelerometer_T1_centred = 
                      paAccelerometer_T1 - mean(paAccelerometer_T1, na.rm = TRUE))

m_1 <- brms::bf(paAccelerometer_T1_centred ~ (1 | group)) 
get_prior(m_1, data = df_randeff_plot_brms)

fit_1 <- brms::brm(m_1, df_randeff_plot_brms)

pt <- brms::ranef(fit_1, robust = TRUE) %>% 
  data.frame %>% 
  dplyr::select(credintLow = group.2.5.ile.Intercept,
         intercept = group.Estimate.Intercept, 
         credintHigh = group.97.5.ile.Intercept) %>% 
  arrange(intercept)


plot1 <- userfriendlyscience::diamondPlot(pt, color = 'green', alpha=.3, yLabels = 1:58, fixedSize = 0.3, xlab = NULL) +
  ggplot2::coord_flip(expand = TRUE) +
  ggplot2::labs(x = "Deviance from average MVPA", y = "Group")


df %>% ggplot2::ggplot(aes(x = group, y = paAccelerometer_T1_centred)) +
  userfriendlyscience::diamondPlot(pt, color = 'green', alpha=.3, yLabels = 1:58, fixedSize = 0.3, xlab = NULL, returnLayerOnly = TRUE) +
  ggplot2::coord_flip(expand = TRUE) +
  ggplot2::labs(x = "Deviance from average MVPA", y = "Group")
   
# brmstools::forest(fit_1)
```

## Random effects in autonomous motivation

```{r randeff-plot-brms-autonomous, fig.height = 4, fig.width = 12}

# Centre the variable:
df_randeff_plot_brms_autonomous <- df %>% dplyr::mutate(PA_autonomous_T1_centred = PA_autonomous_T1 - mean(PA_autonomous_T1, na.rm = TRUE))

m_1 <- brms::bf(PA_autonomous_T1_centred ~ (1 | group)) 
get_prior(m_1, data = df_randeff_plot_brms_autonomous)

fit_1 <- brms::brm(m_1, df_randeff_plot_brms_autonomous)

pt <- brms::ranef(fit_1, robust = TRUE) %>% 
  data.frame %>% 
  dplyr::select(credintLow = group.2.5.ile.Intercept,
         intercept = group.Estimate.Intercept, 
         credintHigh = group.97.5.ile.Intercept) %>% 
  arrange(intercept)


plot1 <- userfriendlyscience::diamondPlot(pt, color = 'blue', alpha=.3, yLabels = 1:59, fixedSize = 0.3, xlab = NULL) +
  ggplot2::coord_flip(expand = TRUE) +
  labs(x = "Deviance from average motivation", y = "Group")


df_randeff_plot_brms_autonomous %>% ggplot2::ggplot(aes(x = group, y = PA_autonomous_T1_centred)) +
  userfriendlyscience::diamondPlot(pt, color = 'blue', alpha=.3, yLabels = 1:59, fixedSize = 0.3, xlab = NULL, returnLayerOnly = TRUE) +
  ggplot2::coord_flip(expand = TRUE) +
  labs(x = "Deviance from average motivation", y = "Group")
   

```

# Primary outcome variables

## Plot of self-reported and accelerometer-measured MVPA-variables

<!-- TODO: Change Red line for the decided cutoff -->

```{r mvpa-accelerometer-selfreport-scatterplot}

lmi %>% ggplot2::ggplot(aes(x = LiikuntaT1_ka, y = Kys0045.1)) + geom_point() + geom_smooth(method = "loess") +
  geom_vline(xintercept = 120, col = "red") +
  labs(x = "accelerometer-measured MVPA", y = "self-reported MVPA days last week")


```

This section reports the primary outcome variables.  

## Accelerometer-measured MVPA 

Get credibility intervals track:school

```{r lmer-numbers, eval = FALSE, include = FALSE}
# TODO: Try out if we can estimate the intercepts by gender and educational tracks:

testdf <- data.frame(PA = df$paAccelerometer_T1, track = df$track, intervention = df$intervention)

testdf <- testdf %>% dplyr::mutate(trackintervention = paste(track, intervention),
                                   trackintervention = ifelse(grepl("NA", trackintervention), NA, trackintervention))


m_test <- lme4::lmer(PA ~ (1 | trackintervention), data = testdf)

confint(m_test)
m_p <- profile(m_test, which = "beta_")
ci_low <- confint(m_p)[, 1]
ci_high <- confint(m_p)[, 2]

data.frame(ranef = ranef(m_test)) %>% dplyr::mutate(estimate = ranef.condval + fixef(m_test))
```

Contrary to some other findings, in our sample girls were more active than boys. 

```{r mvpa-difference-boygirl-numbers}

MVPAgirl_df <- df %>% group_by(girl) %>% dplyr::select(girl, paAccelerometer_T1) %>% summarise(`mean accelerometer-measured MVPA difference between girls and boys` = mean(paAccelerometer_T1, na.rm = TRUE), median = median(paAccelerometer_T1, na.rm = TRUE))
MVPAgirl_df[1, 2] - MVPAgirl_df[2, 2]
MVPAgirl_df[1, 3] - MVPAgirl_df[2, 3]

userfriendlyscience::meanDiff(df$girl, df$paAccelerometer_T1)

```

### Density plot intervention / gender

```{r MVPA-accelerometer-sm}

# Create data frame
densplot <- d
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(paAccelerometer_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.paAccelerometer_T1_2 <- sm.density.compare2(as.numeric(dens$paAccelerometer_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1,3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = (c(2,2)))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(paAccelerometer_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.paAccelerometer_T1_2 <- sm.density.compare2(as.numeric(dens$paAccelerometer_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3,1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = (c(2,2)))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))

# Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "MVPA minutes", pos = 1)
```


Prepare data

```{r MVPA-accelerometer-data}
m_paAccelerometer_trackgirl <- brms::bf(paAccelerometer_T1 ~ (1 | track:girl)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_paAccelerometer_trackgirl, data = df)

m_paAccelerometer_trackgirl

b_intercept <- brms::fixef(m_paAccelerometer_trackgirl)[1]

# This gives estimates only:
PA_trackgirl_estimates <- brms::ranef(m_paAccelerometer_trackgirl)[[1]][1:10]

# The 2.5%ile:
PA_trackgirl_CIL <- brms::ranef(m_paAccelerometer_trackgirl)[[1]][21:30]

# The 97.5%ile:
PA_trackgirl_CIH <- brms::ranef(m_paAccelerometer_trackgirl)[[1]][31:40]

PA_trackgirl_ci <- data.frame(PA_trackgirl_CIL, PA_trackgirl_estimates, PA_trackgirl_CIH, Variable = labels(brms::ranef(m_paAccelerometer_trackgirl))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(PA_trackgirl_CIL = PA_trackgirl_CIL + b_intercept,
         PA_trackgirl_estimates = PA_trackgirl_estimates + b_intercept,
         PA_trackgirl_CIH = PA_trackgirl_CIH + b_intercept,
         track = c('BA_boy',
                   'BA_girl',
                   'HRC_boy',
                   'HRC_girl',
                   'IT_boy',
                   'IT_girl',
                   'Nur_boy',
                   'Nur_girl',
                   'Other_boy',
                   'Other_girl'
))

PA_trackgirl_diamonds_girl <- rbind(
PA_trackgirl_ci %>% dplyr::filter(track == "Nur_girl"),
PA_trackgirl_ci %>% dplyr::filter(track == "HRC_girl"),
PA_trackgirl_ci %>% dplyr::filter(track == "BA_girl"),
PA_trackgirl_ci %>% dplyr::filter(track == "IT_girl")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

PA_trackgirl_diamonds_boy <- rbind(
PA_trackgirl_ci %>% dplyr::filter(track == "Nur_boy"),
PA_trackgirl_ci %>% dplyr::filter(track == "HRC_boy"),
PA_trackgirl_ci %>% dplyr::filter(track == "BA_boy"),
PA_trackgirl_ci %>% dplyr::filter(track == "IT_boy")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come


m_paAccelerometer_trackintervention <- brms::bf(paAccelerometer_T1 ~ (1 | track:intervention)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_paAccelerometer_trackintervention, data = df)

m_paAccelerometer_trackintervention

b_intercept <- brms::fixef(m_paAccelerometer_trackintervention)[1]

# This gives estimates only:
PA_trackintervention_estimates <- brms::ranef(m_paAccelerometer_trackintervention)[[1]][1:10]


# The 2.5%ile:
PA_trackintervention_CIL <- brms::ranef(m_paAccelerometer_trackintervention)[[1]][21:30]

# The 97.5%ile:
PA_trackintervention_CIH <- brms::ranef(m_paAccelerometer_trackintervention)[[1]][31:40]

PA_trackintervention_ci <- data.frame(PA_trackintervention_CIL, PA_trackintervention_estimates, PA_trackintervention_CIH, Variable = labels(brms::ranef(m_paAccelerometer_trackintervention))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(PA_trackintervention_CIL = PA_trackintervention_CIL + b_intercept,
         PA_trackintervention_estimates = PA_trackintervention_estimates + b_intercept,
         PA_trackintervention_CIH = PA_trackintervention_CIH + b_intercept,
         track = c('BA_control',
                   'BA_intervention',
                   'HRC_control',
                   'HRC_intervention',
                   'IT_control',
                   'IT_intervention',
                   'Nur_control',
                   'Nur_intervention',
                   'Other_control',
                   'Other_intervention'
))

PA_trackintervention_diamonds_intervention <- rbind(
PA_trackintervention_ci %>% dplyr::filter(track == "Nur_intervention"),
PA_trackintervention_ci %>% dplyr::filter(track == "HRC_intervention"),
PA_trackintervention_ci %>% dplyr::filter(track == "BA_intervention"),
PA_trackintervention_ci %>% dplyr::filter(track == "IT_intervention")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

PA_trackintervention_diamonds_control <- rbind(
PA_trackintervention_ci %>% dplyr::filter(track == "Nur_control"),
PA_trackintervention_ci %>% dplyr::filter(track == "HRC_control"),
PA_trackintervention_ci %>% dplyr::filter(track == "BA_control"),
PA_trackintervention_ci %>% dplyr::filter(track == "IT_control")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

PA_trackgirl_diamonds_girl
PA_trackgirl_diamonds_boy
PA_trackintervention_diamonds_intervention
PA_trackintervention_diamonds_control
```

### Accelerometer-measured MVPA density plot: 

```{r MVPA-accelerometer-plot}

plot1 <- df %>% dplyr::select(id,
                              track = track,
                              girl,
                              PA = paAccelerometer_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl),
                                  scale = .75, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.05, height = 0.15),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA boy' = "Boy", 'BA girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(24, 4),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(4, 24),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot1 <- plot1 + 
  userfriendlyscience::diamondPlot(PA_trackgirl_diamonds_girl, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   color=viridis::viridis(4, end = 0.8)[3],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) + # specify y-position; option to move the diamond 
  userfriendlyscience::diamondPlot(PA_trackgirl_diamonds_boy, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   linetype = "solid", 
                                   color=viridis::viridis(4, end = 0.8)[1],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

# Draw plot with intervention and control densities

plot2 <- df %>% dplyr::select(id,
                              track = track,
                              intervention,
                              PA = paAccelerometer_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention),
                                  scale = .75, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.05, height = 0.15),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA 0' = "Control", 'BA 1' = "Intervention"),
                                values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(21, 3),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(21, 3),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(PA_trackintervention_diamonds_intervention, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[4],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) +
  userfriendlyscience::diamondPlot(PA_trackintervention_diamonds_control, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[2],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plot1 + plot2


```

## Self-reported MVPA days, previous week 

Description

This section reports the question on how many days the participants did MVPA during the previous week.

Code chunk below prepares data.

```{r padaysLastweek-data}
m_padaysLastweek_trackgirl <- brms::bf(padaysLastweek_T1 ~ (1 | track:girl)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_padaysLastweek_trackgirl, data = df)

m_padaysLastweek_trackgirl

b_intercept <- brms::fixef(m_padaysLastweek_trackgirl)[1]

# This gives estimates only:
padaysLastweek_trackgirl_estimates <- brms::ranef(m_padaysLastweek_trackgirl)[[1]][1:10]

# The 2.5%ile:
padaysLastweek_trackgirl_CIL <- brms::ranef(m_padaysLastweek_trackgirl)[[1]][21:30]

# The 97.5%ile:
padaysLastweek_trackgirl_CIH <- brms::ranef(m_padaysLastweek_trackgirl)[[1]][31:40]

padaysLastweek_trackgirl_ci <- data.frame(padaysLastweek_trackgirl_CIL, padaysLastweek_trackgirl_estimates, padaysLastweek_trackgirl_CIH, Variable = labels(brms::ranef(m_padaysLastweek_trackgirl))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(padaysLastweek_trackgirl_CIL = padaysLastweek_trackgirl_CIL + b_intercept,
         padaysLastweek_trackgirl_estimates = padaysLastweek_trackgirl_estimates + b_intercept,
         padaysLastweek_trackgirl_CIH = padaysLastweek_trackgirl_CIH + b_intercept,
         track = c('BA_boy',
                   'BA_girl',
                   'HRC_boy',
                   'HRC_girl',
                   'IT_boy',
                   'IT_girl',
                   'Nur_boy',
                   'Nur_girl',
                   'Other_boy',
                   'Other_girl'
))

padaysLastweek_trackgirl_diamonds_girl <- rbind(
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "Nur_girl"),
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "HRC_girl"),
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "BA_girl"),
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "IT_girl")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

padaysLastweek_trackgirl_diamonds_boy <- rbind(
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "Nur_boy"),
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "HRC_boy"),
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "BA_boy"),
padaysLastweek_trackgirl_ci %>% dplyr::filter(track == "IT_boy")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come


m_padaysLastweek_trackintervention <- brms::bf(padaysLastweek_T1 ~ (1 | track:intervention)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_padaysLastweek_trackintervention, data = df)

m_padaysLastweek_trackintervention

b_intercept <- brms::fixef(m_padaysLastweek_trackintervention)[1]

# This gives estimates only:
padaysLastweek_trackintervention_estimates <- brms::ranef(m_padaysLastweek_trackintervention)[[1]][1:10]

# The 2.5%ile:
padaysLastweek_trackintervention_CIL <- brms::ranef(m_padaysLastweek_trackintervention)[[1]][21:30]

# The 97.5%ile:
padaysLastweek_trackintervention_CIH <- brms::ranef(m_padaysLastweek_trackintervention)[[1]][31:40]

padaysLastweek_trackintervention_ci <- data.frame(padaysLastweek_trackintervention_CIL, padaysLastweek_trackintervention_estimates, padaysLastweek_trackintervention_CIH, Variable = labels(brms::ranef(m_padaysLastweek_trackintervention))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(padaysLastweek_trackintervention_CIL = padaysLastweek_trackintervention_CIL + b_intercept,
         padaysLastweek_trackintervention_estimates = padaysLastweek_trackintervention_estimates + b_intercept,
         padaysLastweek_trackintervention_CIH = padaysLastweek_trackintervention_CIH + b_intercept,
         track = c('BA_control',
                   'BA_intervention',
                   'HRC_control',
                   'HRC_intervention',
                   'IT_control',
                   'IT_intervention',
                   'Nur_control',
                   'Nur_intervention',
                   'Other_control',
                   'Other_intervention'
))

padaysLastweek_trackintervention_diamonds_intervention <- rbind(
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "Nur_intervention"),
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "HRC_intervention"),
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "BA_intervention"),
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "IT_intervention")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

padaysLastweek_trackintervention_diamonds_control <- rbind(
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "Nur_control"),
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "HRC_control"),
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "BA_control"),
padaysLastweek_trackintervention_ci %>% dplyr::filter(track == "IT_control")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

```

```{r padaysLastweek-tables, results = "asis"}

padaysLastweek_trackgirl_diamonds_girl %>% papaja::apa_table()
padaysLastweek_trackgirl_diamonds_boy %>% papaja::apa_table()
padaysLastweek_trackintervention_diamonds_intervention %>% papaja::apa_table()
padaysLastweek_trackintervention_diamonds_control %>% papaja::apa_table()

```

### Density plot by intervention and gender

```{r padaysLastweek-sm}

# Create data frame
densplot <- d
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(padaysLastweek_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.padaysLastweek_T1_2 <- sm.density.compare2(as.numeric(dens$padaysLastweek_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1, 3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(0, 7))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(padaysLastweek_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.padaysLastweek_T1_2 <- sm.density.compare2(as.numeric(dens$padaysLastweek_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3, 1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(0, 7))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))

# Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "Self-reported number of MVPA days previous week", pos = 1)
```

### Density plot by track

```{r padaysLastweek-densityplot}

plot1 <- df %>% dplyr::select(id,
                              track = track,
                              girl,
                              PA = padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl),
                                  scale = .6, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.2, height = 0.4),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA boy' = "Boy", 'BA girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(24, 4),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(4, 24),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot1 <- plot1 + 
  userfriendlyscience::diamondPlot(padaysLastweek_trackgirl_diamonds_girl, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   color=viridis::viridis(4, end = 0.8)[3],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) + # specify y-position; option to move the diamond 
  userfriendlyscience::diamondPlot(padaysLastweek_trackgirl_diamonds_boy, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   linetype = "solid", 
                                   color=viridis::viridis(4, end = 0.8)[1],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

# Draw plot with intervention and control densities

plot2 <- df %>% dplyr::select(id,
                              track = track,
                              intervention,
                              PA = padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention),
                                  scale = .6, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.2, height = 0.4),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA 0' = "Control", 'BA 1' = "Intervention"),
                                values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(21, 3),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(21, 3),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(padaysLastweek_trackintervention_diamonds_intervention, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[4],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) +
  userfriendlyscience::diamondPlot(padaysLastweek_trackintervention_diamonds_control, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[2],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plot1 + plot2

```

### Histogram 1

```{r padaysLastweek-histogram1}
plotboys <- df %>% dplyr::select(id,
                                 track = track,
                                 girl,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other", girl == "boy") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = padaysLastweek_T1, fill = girl), stat = "binline", binwidth = 1, scale = 0.95, alpha = 0.6) +
  scale_x_continuous(breaks = c(0:7), expand = c(0, 0), name = NULL) +
  scale_y_discrete(expand = c(0.01, 0), name = "") +
  ggridges::scale_fill_cyclical(values = viridis::viridis(4, end = 0.8)[1]) +
  labs(title = "Boys") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(-0.5, 7.5))

plotboys <- plotboys + 
  userfriendlyscience::diamondPlot(padaysLastweek_trackgirl_diamonds_girl, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   color=viridis::viridis(4, end = 0.8)[3],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) + # specify y-position; option to move the diamond 
  userfriendlyscience::diamondPlot(padaysLastweek_trackgirl_diamonds_boy, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   linetype = "solid", 
                                   color=viridis::viridis(4, end = 0.8)[1],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plotgirls <- df %>% dplyr::select(id,
                                 track = track,
                                 girl,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other", girl == "girl") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = padaysLastweek_T1, fill = girl), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(0:7), expand = c(0, 0), name = NULL) +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = viridis::viridis(4, end = 0.8)[3]) +
  labs(title = "Girls") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(-0.5, 7.5))

plotgirls <- plotgirls + 
  userfriendlyscience::diamondPlot(padaysLastweek_trackgirl_diamonds_girl, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   color=viridis::viridis(4, end = 0.8)[3],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) + # specify y-position; option to move the diamond 
  userfriendlyscience::diamondPlot(padaysLastweek_trackgirl_diamonds_boy, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   linetype = "solid", 
                                   color=viridis::viridis(4, end = 0.8)[1],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))


plotcontrol <- df %>% dplyr::select(id,
                                 track = track,
                                 intervention,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other", intervention == "0") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = padaysLastweek_T1, fill = intervention), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(0:7), expand = c(0, 0), name = NULL) +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = viridis::viridis(4, end = 0.8)[2]) +
  labs(title = "Control") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(-0.5, 7.5))

plotcontrol <- plotcontrol + 
  userfriendlyscience::diamondPlot(padaysLastweek_trackintervention_diamonds_intervention, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[4],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) +
  userfriendlyscience::diamondPlot(padaysLastweek_trackintervention_diamonds_control, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[2],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plotintervention <- df %>% dplyr::select(id,
                                 track = track,
                                 intervention,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other", intervention == "1") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = padaysLastweek_T1, fill = intervention), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(0:7), expand = c(0, 0), name = NULL) +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = viridis::viridis(4, end = 0.8)[4]) +
  labs(title = "Intervention") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(-0.5, 7.5))

plotintervention <- plotintervention + 
  userfriendlyscience::diamondPlot(padaysLastweek_trackintervention_diamonds_intervention, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[4],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) +
  userfriendlyscience::diamondPlot(padaysLastweek_trackintervention_diamonds_control, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[2],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plotboys + plotgirls + plotcontrol + plotintervention + plot_layout(ncol = 4)

```

### Histogram 2

```{r padaysLastweek-histogram2}
hist_padaysLastweek_girl_count <- df %>% dplyr::select(id,
                                 track = track,
                                 girl,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur"),
                padaysLastweek_T1 = as.integer(padaysLastweek_T1)) %>% 
  ggplot(aes(x=padaysLastweek_T1, fill=girl)) +
  geom_histogram(binwidth=1, position="dodge", color = "black") +
  scale_x_continuous(breaks = 0:7) +
  labs(x = NULL) +   
  scale_fill_manual(values = viridis::viridis(4, end = 0.8)[c(3, 1)], 
                    name = NULL) +
  facet_wrap("track") + 
  theme(legend.position = "bottom")

hist_padaysLastweek_girl_density <- df %>% dplyr::select(id,
                                 track = track,
                                 girl,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur"),
                padaysLastweek_T1 = as.integer(padaysLastweek_T1)) %>% 
  ggplot(aes(x=padaysLastweek_T1, y = ..density.., fill=girl)) +
  geom_histogram(binwidth=1, position="dodge", color = "black") +
  scale_x_continuous(breaks = 0:7) +
  labs(x = NULL) + 
  scale_fill_manual(values = viridis::viridis(4, end = 0.8)[c(3, 1)], name = NULL,
                    guide = FALSE) +
  facet_wrap("track")

hist_padaysLastweek_girl_count + hist_padaysLastweek_girl_density

hist_padaysLastweek_intervention_count <- df %>% dplyr::select(id,
                                 track = track,
                                 intervention,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur"),
                padaysLastweek_T1 = as.integer(padaysLastweek_T1)) %>% 
  ggplot(aes(x=padaysLastweek_T1, fill=intervention)) +
  geom_histogram(binwidth = 1, position = "dodge", color = "black") +
  scale_x_continuous(breaks = 0:7) +
  labs(x = NULL) + 
  scale_fill_manual(values = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                    name = NULL, 
                    labels = c("0" = "control", "1" = "intervention")) +
  facet_wrap("track") + 
  theme(legend.position = "bottom")

hist_padaysLastweek_intervention_density <- df %>% dplyr::select(id,
                                 track = track,
                                 intervention,
                                 padaysLastweek_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur"),
                padaysLastweek_T1 = as.integer(padaysLastweek_T1)) %>% 
  ggplot(aes(x=padaysLastweek_T1, y = ..density.., fill=intervention)) +
  geom_histogram(binwidth = 1, position = "dodge", color = "black") +
  scale_x_continuous(breaks = 0:7) +
  labs(x = NULL) + 
  scale_fill_manual(values = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                    guide = FALSE) +
  facet_wrap("track")

hist_padaysLastweek_intervention_count + hist_padaysLastweek_intervention_density
```

## Number of average interruptions to sitting 

This section reports the accelerometer-measured number of breaks to sitting time.

Code chunk below prepares data.

```{r sitBreaks-data}
m_sitBreaks_trackgirl <- brms::bf(sitBreaks_T1 ~ (1 | track:girl)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_sitBreaks_trackgirl, data = df)

m_sitBreaks_trackgirl

b_intercept <- brms::fixef(m_sitBreaks_trackgirl)[1]

# This gives estimates only:
sitBreaks_trackgirl_estimates <- brms::ranef(m_sitBreaks_trackgirl)[[1]][1:10]

# The 2.5%ile:
sitBreaks_trackgirl_CIL <- brms::ranef(m_sitBreaks_trackgirl)[[1]][21:30]

# The 97.5%ile:
sitBreaks_trackgirl_CIH <- brms::ranef(m_sitBreaks_trackgirl)[[1]][31:40]

sitBreaks_trackgirl_ci <- data.frame(sitBreaks_trackgirl_CIL, sitBreaks_trackgirl_estimates, sitBreaks_trackgirl_CIH, Variable = labels(brms::ranef(m_sitBreaks_trackgirl))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(sitBreaks_trackgirl_CIL = sitBreaks_trackgirl_CIL + b_intercept,
         sitBreaks_trackgirl_estimates = sitBreaks_trackgirl_estimates + b_intercept,
         sitBreaks_trackgirl_CIH = sitBreaks_trackgirl_CIH + b_intercept,
         track = c('BA_boy',
                   'BA_girl',
                   'HRC_boy',
                   'HRC_girl',
                   'IT_boy',
                   'IT_girl',
                   'Nur_boy',
                   'Nur_girl',
                   'Other_boy',
                   'Other_girl'
))

sitBreaks_trackgirl_diamonds_girl <- rbind(
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "Nur_girl"),
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "HRC_girl"),
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "BA_girl"),
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "IT_girl")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

sitBreaks_trackgirl_diamonds_boy <- rbind(
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "Nur_boy"),
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "HRC_boy"),
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "BA_boy"),
sitBreaks_trackgirl_ci %>% dplyr::filter(track == "IT_boy")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come


m_sitBreaks_trackintervention <- brms::bf(sitBreaks_T1 ~ (1 | track:intervention)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_sitBreaks_trackintervention, data = df)

m_sitBreaks_trackintervention

b_intercept <- brms::fixef(m_sitBreaks_trackintervention)[1]

# This gives estimates only:
sitBreaks_trackintervention_estimates <- brms::ranef(m_sitBreaks_trackintervention)[[1]][1:10]

# The 2.5%ile:
sitBreaks_trackintervention_CIL <- brms::ranef(m_sitBreaks_trackintervention)[[1]][21:30]

# The 97.5%ile:
sitBreaks_trackintervention_CIH <- brms::ranef(m_sitBreaks_trackintervention)[[1]][31:40]

sitBreaks_trackintervention_ci <- data.frame(sitBreaks_trackintervention_CIL, sitBreaks_trackintervention_estimates, sitBreaks_trackintervention_CIH, Variable = labels(brms::ranef(m_sitBreaks_trackintervention))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(sitBreaks_trackintervention_CIL = sitBreaks_trackintervention_CIL + b_intercept,
         sitBreaks_trackintervention_estimates = sitBreaks_trackintervention_estimates + b_intercept,
         sitBreaks_trackintervention_CIH = sitBreaks_trackintervention_CIH + b_intercept,
         track = c('BA_control',
                   'BA_intervention',
                   'HRC_control',
                   'HRC_intervention',
                   'IT_control',
                   'IT_intervention',
                   'Nur_control',
                   'Nur_intervention',
                   'Other_control',
                   'Other_intervention'
))

sitBreaks_trackintervention_diamonds_intervention <- rbind(
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "Nur_intervention"),
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "HRC_intervention"),
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "BA_intervention"),
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "IT_intervention")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

sitBreaks_trackintervention_diamonds_control <- rbind(
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "Nur_control"),
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "HRC_control"),
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "BA_control"),
sitBreaks_trackintervention_ci %>% dplyr::filter(track == "IT_control")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

```

```{r sitBreaks-tables, results = "asis"}

sitBreaks_trackgirl_diamonds_girl %>% papaja::apa_table()
sitBreaks_trackgirl_diamonds_boy %>% papaja::apa_table()
sitBreaks_trackintervention_diamonds_intervention %>% papaja::apa_table()
sitBreaks_trackintervention_diamonds_control %>% papaja::apa_table()

```


```{r sitBreaks-sm}

# Create data frame
densplot <- d
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(sitBreaks_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.sitBreaks_T1_2 <- sm.density.compare2(as.numeric(dens$sitBreaks_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1, 3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(sitBreaks_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.sitBreaks_T1_2 <- sm.density.compare2(as.numeric(dens$sitBreaks_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3, 1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))

# Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "Average number of breaks in daily sitting", pos = 1)
```

### Density plot

```{r sitBreaks-densityplot}

plot1 <- df %>% dplyr::select(id,
                              track = track,
                              girl,
                              PA = sitBreaks_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl),
                                  scale = .6, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.2, height = 0.15),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA boy' = "Boy", 'BA girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(24, 4),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(4, 24),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot1 <- plot1 + 
  userfriendlyscience::diamondPlot(sitBreaks_trackgirl_diamonds_girl, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   color=viridis::viridis(4, end = 0.8)[3],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) + # specify y-position; option to move the diamond 
  userfriendlyscience::diamondPlot(sitBreaks_trackgirl_diamonds_boy, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   linetype = "solid", 
                                   color=viridis::viridis(4, end = 0.8)[1],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

# Draw plot with intervention and control densities

plot2 <- df %>% dplyr::select(id,
                              track = track,
                              intervention,
                              PA = sitBreaks_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention),
                                  scale = .6, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.2, height = 0.15),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA 0' = "Control", 'BA 1' = "Intervention"),
                                values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(21, 3),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(21, 3),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(sitBreaks_trackintervention_diamonds_intervention, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[4],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) +
  userfriendlyscience::diamondPlot(sitBreaks_trackintervention_diamonds_control, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[2],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plot1 + plot2

```

## SB, Accelerometer-measured

### Density plot by intervention and gender

```{r sitLieAccelerometer-sm}

# Create data frame
densplot <- d
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(sitLieAccelerometer_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.sitLieAccelerometer_T1_2 <- sm.density.compare2(as.numeric(dens$sitLieAccelerometer_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1, 3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(sitLieAccelerometer_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.sitLieAccelerometer_T1_2 <- sm.density.compare2(as.numeric(dens$sitLieAccelerometer_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3, 1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))

# Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "Average daily minutes spent sitting or lying down", pos = 1)
```

Prepare data: time spent sitting & lying down

Get credibility intervals track:school

```{r SB-accelerometer-data}
m_sitLieAccelerometer_trackgirl <- brms::bf(sitLieAccelerometer_T1 ~ (1 | track:girl)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_sitLieAccelerometer_trackgirl, data = df)

m_sitLieAccelerometer_trackgirl

b_intercept <- brms::fixef(m_sitLieAccelerometer_trackgirl)[1]

# This gives estimates only:
sitLie_trackgirl_estimates <- brms::ranef(m_sitLieAccelerometer_trackgirl)[[1]][1:10]

# The 2.5%ile:
sitLie_trackgirl_CIL <- brms::ranef(m_sitLieAccelerometer_trackgirl)[[1]][21:30]

# The 97.5%ile:
sitLie_trackgirl_CIH <- brms::ranef(m_sitLieAccelerometer_trackgirl)[[1]][31:40]

sitLie_trackgirl_ci <- data.frame(sitLie_trackgirl_CIL, sitLie_trackgirl_estimates, sitLie_trackgirl_CIH, Variable = labels(brms::ranef(m_sitLieAccelerometer_trackgirl))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(sitLie_trackgirl_CIL = sitLie_trackgirl_CIL + b_intercept,
         sitLie_trackgirl_estimates = sitLie_trackgirl_estimates + b_intercept,
         sitLie_trackgirl_CIH = sitLie_trackgirl_CIH + b_intercept,
         track = c('BA_boy',
                   'BA_girl',
                   'HRC_boy',
                   'HRC_girl',
                   'IT_boy',
                   'IT_girl',
                   'Nur_boy',
                   'Nur_girl',
                   'Other_boy',
                   'Other_girl'
))

sitLie_trackgirl_diamonds_girl <- rbind(
sitLie_trackgirl_ci %>% dplyr::filter(track == "Nur_girl"),
sitLie_trackgirl_ci %>% dplyr::filter(track == "HRC_girl"),
sitLie_trackgirl_ci %>% dplyr::filter(track == "BA_girl"),
sitLie_trackgirl_ci %>% dplyr::filter(track == "IT_girl")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

sitLie_trackgirl_diamonds_boy <- rbind(
sitLie_trackgirl_ci %>% dplyr::filter(track == "Nur_boy"),
sitLie_trackgirl_ci %>% dplyr::filter(track == "HRC_boy"),
sitLie_trackgirl_ci %>% dplyr::filter(track == "BA_boy"),
sitLie_trackgirl_ci %>% dplyr::filter(track == "IT_boy")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come


m_sitLieAccelerometer_trackintervention <- brms::bf(sitLieAccelerometer_T1 ~ (1 | track:intervention)) %>% 
  brms::brm(., data = df, chains = 4, iter = 4000, control = list(adapt_delta = 0.95))

brms::prior_summary(m_sitLieAccelerometer_trackintervention, data = df)

m_sitLieAccelerometer_trackintervention

b_intercept <- brms::fixef(m_sitLieAccelerometer_trackintervention)[1]

# This gives estimates only:
sitLie_trackintervention_estimates <- brms::ranef(m_sitLieAccelerometer_trackintervention)[[1]][1:10]


# The 2.5%ile:
sitLie_trackintervention_CIL <- brms::ranef(m_sitLieAccelerometer_trackintervention)[[1]][21:30]

# The 97.5%ile:
sitLie_trackintervention_CIH <- brms::ranef(m_sitLieAccelerometer_trackintervention)[[1]][31:40]

sitLie_trackintervention_ci <- data.frame(sitLie_trackintervention_CIL, sitLie_trackintervention_estimates, sitLie_trackintervention_CIH, Variable = labels(brms::ranef(m_sitLieAccelerometer_trackintervention))) %>% 
  dplyr::mutate(b_intercept = rep(b_intercept, 10)) %>% 
  dplyr::mutate(sitLie_trackintervention_CIL = sitLie_trackintervention_CIL + b_intercept,
         sitLie_trackintervention_estimates = sitLie_trackintervention_estimates + b_intercept,
         sitLie_trackintervention_CIH = sitLie_trackintervention_CIH + b_intercept,
         track = c('BA_control',
                   'BA_intervention',
                   'HRC_control',
                   'HRC_intervention',
                   'IT_control',
                   'IT_intervention',
                   'Nur_control',
                   'Nur_intervention',
                   'Other_control',
                   'Other_intervention'
))

sitLie_trackintervention_diamonds_intervention <- rbind(
sitLie_trackintervention_ci %>% dplyr::filter(track == "Nur_intervention"),
sitLie_trackintervention_ci %>% dplyr::filter(track == "HRC_intervention"),
sitLie_trackintervention_ci %>% dplyr::filter(track == "BA_intervention"),
sitLie_trackintervention_ci %>% dplyr::filter(track == "IT_intervention")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

sitLie_trackintervention_diamonds_control <- rbind(
sitLie_trackintervention_ci %>% dplyr::filter(track == "Nur_control"),
sitLie_trackintervention_ci %>% dplyr::filter(track == "HRC_control"),
sitLie_trackintervention_ci %>% dplyr::filter(track == "BA_control"),
sitLie_trackintervention_ci %>% dplyr::filter(track == "IT_control")) %>% 
  arrange(-row_number()) # reverse order of rows to make them right for the plot to come

```

```{r sitLie-tables, results = "asis"}

sitLie_trackgirl_diamonds_girl %>% papaja::apa_table()
sitLie_trackgirl_diamonds_boy %>% papaja::apa_table()
sitLie_trackintervention_diamonds_intervention %>% papaja::apa_table()
sitLie_trackintervention_diamonds_control %>% papaja::apa_table()

```

#### Basic observed characteristics

NOTE: These values do not account for clustering.

```{r uncorrected-means-cis, results = "asis"}

df %>% dplyr::select(sitLieAccelerometer_T1, girl, track) %>% 
  group_by(girl, track) %>% 
  summarise(mean = mean(sitLieAccelerometer_T1, na.rm = TRUE),
            median = median(sitLieAccelerometer_T1, na.rm = TRUE),
            max = max(sitLieAccelerometer_T1, na.rm = TRUE),
            min = min(sitLieAccelerometer_T1, na.rm = TRUE),
            sd = sd(sitLieAccelerometer_T1, na.rm = TRUE),
            n = n()) %>% 
  papaja::apa_table()
  

df %>% dplyr::select(sitLieAccelerometer_T1, girl, track) %>% 
  group_by(girl) %>% 
  summarise(mean = mean(sitLieAccelerometer_T1, na.rm = TRUE),
            median = median(sitLieAccelerometer_T1, na.rm = TRUE),
            max = max(sitLieAccelerometer_T1, na.rm = TRUE),
            min = min(sitLieAccelerometer_T1, na.rm = TRUE),
            sd = sd(sitLieAccelerometer_T1, na.rm = TRUE),
            n = n()) %>% 
  papaja::apa_table()

df %>% dplyr::select(sitLieAccelerometer_T1, intervention, track) %>% 
  group_by(intervention, track) %>% 
  summarise(mean = mean(sitLieAccelerometer_T1, na.rm = TRUE),
            median = median(sitLieAccelerometer_T1, na.rm = TRUE),
            max = max(sitLieAccelerometer_T1, na.rm = TRUE),
            min = min(sitLieAccelerometer_T1, na.rm = TRUE),
            sd = sd(sitLieAccelerometer_T1, na.rm = TRUE),
            n = n()) %>% 
  papaja::apa_table()

df %>% dplyr::select(sitLieAccelerometer_T1, intervention, track) %>% 
  group_by(intervention) %>% 
  summarise(mean = mean(sitLieAccelerometer_T1, na.rm = TRUE),
            median = median(sitLieAccelerometer_T1, na.rm = TRUE),
            max = max(sitLieAccelerometer_T1, na.rm = TRUE),
            min = min(sitLieAccelerometer_T1, na.rm = TRUE),
            sd = sd(sitLieAccelerometer_T1, na.rm = TRUE),
            n = n()) %>% 
  papaja::apa_table()
```


### Draw plot: time spent sitting or lying down

```{r sitLie-accelerometer-plot}

plot1 <- df %>% dplyr::select(id,
                              track = track,
                              girl,
                              PA = sitLieAccelerometer_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl),
                                  scale = .75, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.05, height = 0.15),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA boy' = "Boy", 'BA girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(24, 4),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(3, 1)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(4, 24),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot1 <- plot1 + 
  userfriendlyscience::diamondPlot(sitLie_trackgirl_diamonds_girl, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   color=viridis::viridis(4, end = 0.8)[3],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) + # specify y-position; option to move the diamond 
  userfriendlyscience::diamondPlot(sitLie_trackgirl_diamonds_boy, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black", 
                                   linetype = "solid", 
                                   color=viridis::viridis(4, end = 0.8)[1],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

# Draw plot with intervention and control densities

plot2 <- df %>% dplyr::select(id,
                              track = track,
                              intervention,
                              PA = sitLieAccelerometer_T1)  %>%
  dplyr::filter(!is.na(track), track != "Other") %>% # Drop category "Other"
  dplyr::mutate(track = factor(track, levels = c("IT", "BA", "HRC", "Nur")),
                track = recode_factor(track, "IT" = "IT", "BA" = "BA", 
                                      "HRC" = "HRC", "Nur" = "Nur")) %>% 
  ggplot2::ggplot(aes(y = track)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(track, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention),
                                  scale = .75, alpha = 0.6, size = 0.25,
                                  position = position_raincloud(width = 0.05, height = 0.15),
                                  # from = 0, to = 450,
                                  jittered_points = TRUE,
                                  point_size = 1) +
  labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.1, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA 0' = "Control", 'BA 1' = "Intervention"),
                                values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                name = "", 
                                guide = guide_legend(override.aes = list(alpha = 1, 
                                                                         point_shape = c(21, 3),
                                                                         point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  # ggplot2::scale_fill_manual(values = c("#A0FFA0", "#A0A0FF")) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(21, 3),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(sitLie_trackintervention_diamonds_intervention, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[4],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15)) +
  userfriendlyscience::diamondPlot(sitLie_trackintervention_diamonds_control, 
                                   returnLayerOnly = TRUE, 
                                   lineColor = "black",  
                                   color=viridis::viridis(4, end = 0.8)[2],
                                   alpha=.6, 
                                   fixedSize = 0.1, 
                                   otherAxisCol = (1:4 + .15))

plot1 + plot2

```

#### Check for plot correctness

Show gender and group allocation of maximum and minimum values for each track.

```{r sitLie-accelerometer-check, results = "asis"}

df %>% dplyr::select(sitLieAccelerometer_T1, girl, intervention, track) %>% 
  dplyr::group_by(track) %>% 
  dplyr::arrange((sitLieAccelerometer_T1), .by_group = TRUE) %>% 
  na.omit() %>% 
  dplyr::filter(track != "Other") %>% 
  dplyr::filter(sitLieAccelerometer_T1 == max(sitLieAccelerometer_T1) | sitLieAccelerometer_T1 == min(sitLieAccelerometer_T1)) %>% 
  papaja::apa_table()

```

### MVPA, girls and boys in different educational tracks and schools

```{r mvpa-trackschool-tables}

df %>% dplyr::select(paAccelerometer_T1, girl, trackSchool) %>% 
  group_by(girl, trackSchool) %>% 
  summarise(mean = mean(paAccelerometer_T1, na.rm = TRUE),
            median = median(paAccelerometer_T1, na.rm = TRUE),
            max = max(paAccelerometer_T1, na.rm = TRUE),
            min = min(paAccelerometer_T1, na.rm = TRUE),
            sd = sd(paAccelerometer_T1, na.rm = TRUE),
            n = n()) %>% 
  papaja::apa_table()

df %>% dplyr::select(paAccelerometer_T1, girl, trackSchool) %>% 
  group_by(girl) %>% 
  summarise(mean = mean(paAccelerometer_T1, na.rm = TRUE),
            median = median(paAccelerometer_T1, na.rm = TRUE),
            max = max(paAccelerometer_T1, na.rm = TRUE),
            min = min(paAccelerometer_T1, na.rm = TRUE),
            sd = sd(paAccelerometer_T1, na.rm = TRUE),
            n = n()) %>% 
  papaja::apa_table()

```

```{r mvpa-trackshool-density}

plot1 <- df %>% dplyr::select(id,
                              trackSchool = trackSchool,
                              girl,
                              PA = paAccelerometer_T1)  %>%
  dplyr::filter(!is.na(trackSchool), !grepl('Other|NANA|BA4|HRC2|Nur2', trackSchool)) %>% # Drop categories with just few participants
  ggplot2::ggplot(aes(y = trackSchool)) +
  ggridges::geom_density_ridges2(aes(x = PA, colour = "black", 
                                    fill = paste(trackSchool, girl)),
                                  scale = 1,
                                  alpha = 0.6, size = 0.25,
                                  from = 0, to = 450,
                                  jittered_points=TRUE, point_shape=21,
                                  point_fill="black") +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                                labels = c('BA1 boy' = "Boy", 'BA1 girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                name = "", guide = guide_legend(override.aes = list(alpha = 1))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom", axis.text=element_text(size=10))

plot1

```

# PA Determinants

This section reports various hypothesised determinants of physical activity.

## Simple diamond plots

```{r selfrep-determinants-simple-diamondplot}
PA_ci_girls <- ci_girls %>% dplyr::filter(diamondlabels %in% names(scales_T1) & grepl("PA_", diamondlabels) & !grepl("bct", diamondlabels))

PA_ci_boys <- ci_boys %>% dplyr::filter(diamondlabels %in% names(scales_T1) & grepl("PA_", diamondlabels) & !grepl("bct", diamondlabels))

PA_ci_intervention <- ci_intervention %>% dplyr::filter(diamondlabels %in% names(scales_T1) & grepl("PA_", diamondlabels) & !grepl("bct", diamondlabels))

PA_ci_control <- ci_control %>% dplyr::filter(diamondlabels %in% names(scales_T1) & grepl("PA_", diamondlabels) & !grepl("bct", diamondlabels))

ICClabels <- vardatatable_containing_edutrack %>% dplyr::filter(Variable %in% PA_ci_control$diamondlabels)

plot1 <- userfriendlyscience::diamondPlot(PA_ci_girls, color = 'green', alpha=.3, yLabels = PA_ci_girls$diamondlabels, fixedSize = 0.3, xlab = NULL) +
  userfriendlyscience::diamondPlot(PA_ci_boys, returnLayerOnly = TRUE, color='blue', alpha=.3, fixedSize = 0.3) +
  scale_x_continuous(limits = c(1, 7), breaks = 1:7)

plot2 <- userfriendlyscience::diamondPlot(PA_ci_intervention, color = 'red', alpha=.3, yLabels = c(rep("", length(PA_ci_girls$diamondlabels))), fixedSize = 0.3, xlab = NULL, ylab = NULL) +
  userfriendlyscience::diamondPlot(PA_ci_control, returnLayerOnly = TRUE, color='black', alpha=.3, fixedSize = 0.3) +
  scale_x_continuous(limits = c(1, 7), breaks = 1:7)

grid::grid.newpage()
grid::grid.draw(cbind(ggplot2::ggplotGrob(plot1), ggplot2::ggplotGrob(plot2), size = "first"))

# dat2 <- data.frame(ciLo = c(3, 2), mean = c(4, 2.5), ciHi = c(6, 3));
# userfriendlyscience::diamondPlot(dat1, color = 'blue', alpha=.3, yLabels = dat1$diamondlabels) +
# userfriendlyscience::diamondPlot(dat2, returnLayerOnly = TRUE, color='red', alpha=.3)
 
```

Note: action and coping planning on a scale from 1 to 4.

```{r ggscatterstats, include = FALSE, eval = FALSE}

ggstatsplot::ggscatterstats(
  data = na.omit(dplyr::select(lmi, LiikuntaT1_ka, Kys0045.1)),
  x = LiikuntaT1_ka,
  y = Kys0045.1,
  test = "robust",                               # type of test that needs to be run
  results.subtitle = FALSE,
  xlab = "Accelerometer-measured MVPA",              # label for x axis
  ylab = "Self-reported PA (previous week)",              # label for y axis 
  line.colour = "black",                     # changing regression line colour line
  title = "",       # title text for the plot
  # caption = expression(                          # caption text for the plot
  #  paste(italic("Note"), ": this is a demo")
  #  ),
  marginal.type = "histogram",                     # type of marginal distribution to be displayed
  xfill = "blue",                                # colour fill for x-axis marginal distribution 
  yfill = "red",                                 # colour fill for y-axis marginal distribution
  intercept = "median",                          # which type of intercept line is to be displayed  
  width.jitter = 0,                            # amount of horizontal jitter for data points
  height.jitter = 0                            # amount of vertical jitter for data points
) 

ggstatsplot::ggscatterstats(data = na.omit(dplyr::select(lmi, LiikuntaT1_ka, Kys0045.1)), 
                            x = LiikuntaT1_ka, 
                            y = Kys0045.1)
```


## PA motivation

```{r pa-determinants-motivation}

plot1 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  'PA autonomous\nmotivation' = PA_autonomous_T1,
'PA controlled\nmotivation' = PA_controlled_T1,
'PA amotivation' = PA_amotivation_T1)  %>%
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>%
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value,
                                    colour = "black",
                                    fill = paste(Variable, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl,
                                    point_size = girl,
                                    point_alpha = girl),
                                scale = 1.16, alpha = .6, size = 0.25,
                                from = 1, to = 5,
                                position = position_raincloud(width = 0.03, height = 0.2),
                                jittered_points = TRUE,
                                point_size = 1) + 
    labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                      labels = c('PA amotivation boy' = "Boy", 'PA amotivation girl' = "Girl"),
                      values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                      name = "", 
                      guide = guide_legend(override.aes = list(alpha = 1, 
                                                               point_shape = c(24, 25),
                                                               point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(24, 25),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_size", 
                                  values = c(.75, .75),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_alpha", 
                                  values = c(0.3, 0.3),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

target = c(
"PA_autonomous_T1",
"PA_controlled_T1",
"PA_amotivation_T1")

PA_ci_girls <- ci_girls %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_autonomous_T1", diamondlabels) | 
                                     grepl("PA_controlled_T1", diamondlabels) | 
                                     grepl("PA_amotivation_T1", diamondlabels))

PA_ci_girls <- PA_ci_girls[match(target, PA_ci_girls$diamondlabels), ]

PA_ci_boys <- ci_boys %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_autonomous_T1", diamondlabels) | 
                                     grepl("PA_controlled_T1", diamondlabels) | 
                                     grepl("PA_amotivation_T1", diamondlabels))

PA_ci_boys <- PA_ci_boys[match(target, PA_ci_boys$diamondlabels), ]

plot1 <- plot1 + userfriendlyscience::diamondPlot(PA_ci_girls, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[3], 
                alpha=.6, fixedSize = 0.05, otherAxisCol = (1:length(target) + .07)) +
  userfriendlyscience::diamondPlot(PA_ci_boys, returnLayerOnly = TRUE, lineColor = "black", linetype = "solid", color=viridis::viridis(4, end = 0.8)[1],  
                alpha=.6, fixedSize = 0.05, otherAxisCol = (1:length(target) + .07))

plot2 <- df %>% dplyr::select(id,
                              intervention,
                              group,
                              school,
                              girl,
                              'PA autonomous\nmotivation' = PA_autonomous_T1,
                              'PA controlled\nmotivation' = PA_controlled_T1,
                              'PA amotivation' = PA_amotivation_T1)  %>%
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>%
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value,
                                    colour = "black",
                                    fill = paste(Variable, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention,
                                    point_size = intervention,
                                    point_alpha = intervention),
                                scale = 1.16, alpha = .6, size = 0.25,
                                from = 1, to = 5,
                                position = position_raincloud(width = 0.03, height = 0.2),
                                jittered_points = TRUE,
                                point_size = 1) + 
    labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                      labels = c('PA amotivation 0' = "Control", 'PA amotivation 1' = "Intervention"),
                      values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                      name = "", 
                      guide = guide_legend(override.aes = list(alpha = 1, 
                                                               point_shape = c(22, 23),
                                                               point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(22, 23),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_size", 
                                  values = c(.75, .75),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_alpha", 
                                  values = c(0.3, 0.3),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

PA_ci_intervention <- ci_intervention %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_autonomous_T1", diamondlabels) | 
                                     grepl("PA_controlled_T1", diamondlabels) | 
                                     grepl("PA_amotivation_T1", diamondlabels))

PA_ci_intervention <- PA_ci_intervention[match(target, PA_ci_intervention$diamondlabels), ]

PA_ci_control <- ci_control %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_autonomous_T1", diamondlabels) | 
                                     grepl("PA_controlled_T1", diamondlabels) | 
                                     grepl("PA_amotivation_T1", diamondlabels))

PA_ci_control <- PA_ci_control[match(target, PA_ci_control$diamondlabels), ]

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(PA_ci_intervention, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[4],
              alpha=.6, fixedSize = 0.05, otherAxisCol = (1:length(target) + .07)) +
  userfriendlyscience::diamondPlot(PA_ci_control, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[2], 
              alpha=.6, fixedSize = 0.05, otherAxisCol = (1:length(target) + .07))

plot1 + plot2 

```

To check that the labels/colors in diamonds are right, here are means of the variables:

```{r motivationmeans_by_gender_intervention, results = "asis"}

df %>% dplyr::select(
  intervention,
  girl,
  'PA autonomous \nmotivation' = PA_autonomous_T1,
'PA controlled \nmotivation' = PA_controlled_T1,
'PA amotivation' = PA_amotivation_T1) %>% 
  group_by(girl) %>% 
  summarise_at(vars(contains("PA")), funs(mean(., na.rm = TRUE))) %>% 
  papaja::apa_table()

df %>% dplyr::select(
  intervention,
  girl,
  'PA autonomous \nmotivation' = PA_autonomous_T1,
'PA controlled \nmotivation' = PA_controlled_T1,
'PA amotivation' = PA_amotivation_T1) %>% 
  group_by(intervention) %>%
  summarise_at(vars(contains("PA")), funs(mean(., na.rm = TRUE))) %>% 
  papaja::apa_table()

```


## Big 5 personality traits

```{r big5}

plot1 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Agreeableness' = big5agreeableness_T1,
'Conscientiousness' = big5conscientiousness_T1,
'Extraversion' = big5extraversion_T1,
'Neuroticism' = big5neuroticism_T1,
'Openness' = big5openness_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, fill = paste(Variable, girl)), 
           alpha = .6, color = "black", from = 1, to = 7) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("Agreeableness boy", "Agreeableness girl"),
                      labels = c( 'Agreeableness boy' = "Boy", 'Agreeableness girl' = "Girl"),
                      values = c("#3bc600", "#0000ff", "#9cc68b", "#8080ff"),
                      name = "", guide = "legend") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom")

plot2 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Agreeableness' = big5agreeableness_T1,
'Conscientiousness' = big5conscientiousness_T1,
'Extraversion' = big5extraversion_T1,
'Neuroticism' = big5neuroticism_T1,
'Openness' = big5openness_T1) %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, fill = paste(Variable, intervention)), 
           alpha = .6, color = "black", from = 1, to = 7) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("Agreeableness 1", "Agreeableness 0"),
                      labels = c('Agreeableness 1' = "Intervention", 'Agreeableness 0' = "Control"),
                      values = c("#ff0000", "#0000ff", "#ff8080", "#8080ff"),
                      name = "", guide = "legend") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom")

plot1 + plot2

```

## BCT use

### Ridge plots for means

```{r bct-sumscore-density-plot}

plot1 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Frequency-\nrelated BCTs' = PA_frqbct_T1,
'Agreement-\nrelated BCTs' = PA_agrbct_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, fill = paste(Variable, girl)), 
           alpha = .6, color = "black", from = 1, to = 7) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("Agreement-\nrelated BCTs boy", "Agreement-\nrelated BCTs girl"),
                      labels = c( 'Agreement-\nrelated BCTs boy' = "Boy", 'Agreement-\nrelated BCTs girl' = "Girl"),
                      values = c("#3bc600", "#0000ff", "#9cc68b", "#8080ff"),
                      name = "", guide = "legend") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom")

plot2 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Frequency-\nrelated BCTs' = PA_frqbct_T1,
'Agreement-\nrelated BCTs' = PA_agrbct_T1) %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, fill = paste(Variable, intervention)), 
           alpha = .6, color = "black", from = 1, to = 7) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("Agreement-\nrelated BCTs 1", "Agreement-\nrelated BCTs 0"),
                      labels = c('Agreement-\nrelated BCTs 1' = "Intervention", 'Agreement-\nrelated BCTs 0' = "Control"),
                      values = c("#ff0000", "#0000ff", "#ff8080", "#8080ff"),
                      name = "", guide = "legend") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom")

plot1 + plot2

```



### sm kernel density plots for means

#### Frequency-measured BCTs

```{r sm-frqbct}

# Create data frame
densplot <- df
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(PA_frqbct_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.PA_frqbct_T1_2 <- sm.density.compare2(as.numeric(dens$PA_frqbct_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1, 3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(1, 6))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(PA_frqbct_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.PA_frqbct_T1_2 <- sm.density.compare2(as.numeric(dens$PA_frqbct_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3, 1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(1, 6))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))

# Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "Frequency-based BCT sumscore mean", pos = 1)
```

#### Agreement-measured BCTs

```{r sm-agrbct}

# Create data frame
densplot <- df
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(PA_agrbct_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.PA_agrbct_T1_2 <- sm.density.compare2(as.numeric(dens$PA_agrbct_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1, 3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(1, 6))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(PA_agrbct_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.PA_agrbct_T1_2 <- sm.density.compare2(as.numeric(dens$PA_agrbct_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3, 1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(1, 6))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "Agreement-based BCT sumscore mean", pos = 1) # Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r


```

### Histograms for individual items

#### Frequency-measured BCTs

These questions were asked with the lead "Have you done the following during the last three weeks?". 

The answer scale was as follows:

0 = not once
1 = once
2 = twice
3 = weekly
4 = about every second day
5 = daily

Items are as follows: 

1. I have reminded myself even in my spare time, what kind of positive consequences frequent PA would have in my life.
2. I have monitored my PA by marking the PA occasions on an exercise log on paper.
3. I have monitored my PA by using a smart phone, e.g. the Moves-app.
4. I use mnemonic cues with which I remember to implement my PA intention.
5. I have compared my actualized PA with the PA goal I have set.
6. I have thought about which reasons to do PA are important to me personally.
7. I have made changes in my home (e.g. my room or my computer), so that starting PA would be easier.
8. I have asked my friends or family for support to reach my PA goals.
9. If I haven't reached my PA goal, I have evaluated, what went wrong.

```{r histogram-frqbcts}
genderInterventionColors <- viridis::viridis(11, end = 0.8)

bctGirls <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Reminded self of positive consequences' = PA_frqbct_01_T1,
'Has logged PA on paper' = PA_frqbct_02_T1,
'Has monitored PA on smartphone' = PA_frqbct_03_T1,
'Uses mnemonic cues' = PA_frqbct_04_T1,
'Has compared actual with goal' = PA_frqbct_05_T1,
'Has thought of relevance of PA' = PA_frqbct_06_T1,
'Has made changes at home' = PA_frqbct_07_T1,
'Has sought social support' = PA_frqbct_08_T1,
'Has evaluated why goal not reached' = PA_frqbct_09_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(girl == "girl") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = viridis::viridis(11, end = 0.8)[7:8]) +
  labs(title = "Girls") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctBoys <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Reminded self of positive consequences' = PA_frqbct_01_T1,
'Has logged PA on paper' = PA_frqbct_02_T1,
'Has monitored PA on smartphone' = PA_frqbct_03_T1,
'Uses mnemonic cues' = PA_frqbct_04_T1,
'Has compared actual with goal' = PA_frqbct_05_T1,
'Has thought of relevance of PA' = PA_frqbct_06_T1,
'Has made changes at home' = PA_frqbct_07_T1,
'Has sought social support' = PA_frqbct_08_T1,
'Has evaluated why goal not reached' = PA_frqbct_09_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(girl == "boy") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "") +
  ggridges::scale_fill_cyclical(values = viridis::viridis(11, end = 0.8)[1:2]) +
  labs(title = "Boys") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctInt <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Reminded self of positive consequences' = PA_frqbct_01_T1,
'Has logged PA on paper' = PA_frqbct_02_T1,
'Has monitored PA on smartphone' = PA_frqbct_03_T1,
'Uses mnemonic cues' = PA_frqbct_04_T1,
'Has compared actual with goal' = PA_frqbct_05_T1,
'Has thought of relevance of PA' = PA_frqbct_06_T1,
'Has made changes at home' = PA_frqbct_07_T1,
'Has sought social support' = PA_frqbct_08_T1,
'Has evaluated why goal not reached' = PA_frqbct_09_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(intervention == "1") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = viridis::viridis(11, end = 0.8)[10:11]) +
  labs(title = "Intervention") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctCont <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'Reminded self of positive consequences' = PA_frqbct_01_T1,
'Has logged PA on paper' = PA_frqbct_02_T1,
'Has monitored PA on smartphone' = PA_frqbct_03_T1,
'Uses mnemonic cues' = PA_frqbct_04_T1,
'Has compared actual with goal' = PA_frqbct_05_T1,
'Has thought of relevance of PA' = PA_frqbct_06_T1,
'Has made changes at home' = PA_frqbct_07_T1,
'Has sought social support' = PA_frqbct_08_T1,
'Has evaluated why goal not reached' = PA_frqbct_09_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(intervention == "0") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = viridis::viridis(11, end = 0.8)[4:5]) +
  labs(title = "Control") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctBoys + bctGirls + bctInt + bctCont + plot_layout(nrow = 1) 
```

#### Agreement-measured BCTs

These questions were asked with the lead "Have you done the following during the last three weeks?". 

The answer scale was as follows:

0 = not at all true
1 ... 4 [unlabeled]
5 = completely true

Items are as follows: 

1. I have set PA goals for myself.
2. I have personally made a specific plan ("what, where, how") to implement my PA.
3. I have a PA plan, which has been made by someone else, e.g. my sports club (e.g. a workout schedule).
4. I have a way by which I remind myself of my PA plan, e.g. I write it down in the calendar.
5. I have cut larger PA goals to smaller subgoals.
6. I have tried out new ways for me to be physically active.
7. I have pondered, what kind of difficult situations or barriers prevent me from implementing my PA plan.
8. I have planned for ways to overcome barriers to doing PA.
9. I have thought about how PA fits my identity (self concept).
10. I have attempted to find ways to exercise so, that it won't obstruct but instead helps actualise my other life values.


```{r histogram-agrbcts}

bctGirls <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  'Has set goals' = PA_agrbct_01_T1,
  'Has made plan' = PA_agrbct_02_T1,
  'Plan made by other' = PA_agrbct_03_T1,
  'Has reminder of plan' = PA_agrbct_04_T1,
  'Has cut goals to subgoals' = PA_agrbct_05_T1,
  'Has tried new PA options' = PA_agrbct_06_T1,
  'Has thought of barriers' = PA_agrbct_07_T1,
  'Has planned for barriers' = PA_agrbct_08_T1,
  'Has thought of PA identity' = PA_agrbct_09_T1,
  'Has fitted PA to life values' = PA_agrbct_10_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(girl == "girl") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c("darkolivegreen2", "darkolivegreen4")) +
  labs(title = "Girls") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctBoys <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  'Has set goals' = PA_agrbct_01_T1,
  'Has made plan' = PA_agrbct_02_T1,
  'Plan made by other' = PA_agrbct_03_T1,
  'Has reminder of plan' = PA_agrbct_04_T1,
  'Has cut goals to subgoals' = PA_agrbct_05_T1,
  'Has tried new PA options' = PA_agrbct_06_T1,
  'Has thought of barriers' = PA_agrbct_07_T1,
  'Has planned for barriers' = PA_agrbct_08_T1,
  'Has thought of PA identity' = PA_agrbct_09_T1,
  'Has fitted PA to life values' = PA_agrbct_10_T1) %>%
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(girl == "boy") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c("darkolivegreen2", "darkolivegreen4")) +
  labs(title = "Boys") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctInt <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  'Has set goals' = PA_agrbct_01_T1,
  'Has made plan' = PA_agrbct_02_T1,
  'Plan made by other' = PA_agrbct_03_T1,
  'Has reminder of plan' = PA_agrbct_04_T1,
  'Has cut goals to subgoals' = PA_agrbct_05_T1,
  'Has tried new PA options' = PA_agrbct_06_T1,
  'Has thought of barriers' = PA_agrbct_07_T1,
  'Has planned for barriers' = PA_agrbct_08_T1,
  'Has thought of PA identity' = PA_agrbct_09_T1,
  'Has fitted PA to life values' = PA_agrbct_10_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(intervention == "1") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "") +
  ggridges::scale_fill_cyclical(values = c("deepskyblue", "deepskyblue4")) +
  labs(title = "Intervention") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctCont <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  'Has set goals' = PA_agrbct_01_T1,
  'Has made plan' = PA_agrbct_02_T1,
  'Plan made by other' = PA_agrbct_03_T1,
  'Has reminder of plan' = PA_agrbct_04_T1,
  'Has cut goals to subgoals' = PA_agrbct_05_T1,
  'Has tried new PA options' = PA_agrbct_06_T1,
  'Has thought of barriers' = PA_agrbct_07_T1,
  'Has planned for barriers' = PA_agrbct_08_T1,
  'Has thought of PA identity' = PA_agrbct_09_T1,
  'Has fitted PA to life values' = PA_agrbct_10_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(intervention == "0") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:6), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c("deepskyblue", "deepskyblue4")) +
  labs(title = "Control") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 6.5)) +
  theme(plot.title = element_text(size=12))

bctInt + bctCont + bctGirls + bctBoys + plot_layout(nrow = 1) 

```


### BCT Plot without fill

```{r bct-determinants-nofill}
plot1 <- df %>% dplyr::select(id,
                              intervention,
                              group,
                              school,
                              girl,
                              'PA intention' = PA_intention_T1,
                              'PA outcome\nexpectations' = PA_outcomeExpectations_T1,
                              'PA perceived\nbehavioural control' = PA_pbc_T1,
                              'PA self efficacy' = PA_selfefficacy_T1,
                              'PA perceived\nopportunities' = PA_opportunities_T1,
                              'PA descriptive\nnorm' = PA_dnorm_T1,
                              'PA injunctive\nnorm' = PA_inorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>%
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, colour = paste(Variable, girl), 
                                    fill = paste(Variable, girl)), 
                                    alpha = 0, size = 0.75, from = 1, to = 7) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("PA injunctive\nnorm boy", "PA injunctive\nnorm girl"),
                                labels = c( 'PA injunctive\nnorm boy' = "Boy", 'PA injunctive\nnorm girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)], #c("#3bc600", "#0000ff", "#9cc68b", "#8080ff"),
                                name = "", guide = guide_legend(override.aes = list(alpha = 1))) +
  ggridges::scale_colour_cyclical(values = viridis::viridis(4, end = 0.8, alpha = 0.9)[c(1, 3)]) +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom", axis.text=element_text(size=10)) +
  geom_hline(yintercept = 1:7)

target = c(
"PA_intention_T1",
"PA_outcomeExpectations_T1",
"PA_pbc_T1",
"PA_selfefficacy_T1",
"PA_opportunities_T1",
"PA_dnorm_T1",
"PA_inorm_T1")

PA_ci_girls <- ci_girls %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_girls <- PA_ci_girls[match(target, PA_ci_girls$diamondlabels), ]

PA_ci_boys <- ci_boys %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_boys <- PA_ci_boys[match(target, PA_ci_boys$diamondlabels), ]

plot1 <- plot1 + userfriendlyscience::diamondPlot(PA_ci_girls, returnLayerOnly = TRUE, color=viridis::viridis(4, end = 0.8)[c(3)], 
                alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2)) +
  userfriendlyscience::diamondPlot(PA_ci_boys, returnLayerOnly = TRUE, color=viridis::viridis(4, end = 0.8)[c(1)],  
                alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2))

plot2 <- df %>% dplyr::select(id,
                              intervention,
                              group,
                              school,
                              girl,
                              'PA intention' = PA_intention_T1,
                              'PA outcome\nexpectations' = PA_outcomeExpectations_T1,
                              'PA perceived\nbehavioural control' = PA_pbc_T1,
                              'PA self efficacy' = PA_selfefficacy_T1,
                              'PA perceived\nopportunities' = PA_opportunities_T1,
                              'PA descriptive\nnorm' = PA_dnorm_T1,
                              'PA injunctive\nnorm' = PA_inorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>%
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, colour = paste(Variable, intervention), 
                                    fill = paste(Variable, intervention)), 
                                    alpha = 0, size = 0.75, from = 1, to = 7) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("PA injunctive\nnorm 0", "PA injunctive\nnorm 1"),
                                labels = c( 'PA injunctive\nnorm 0' = "Control", 'PA injunctive\nnorm 1' = "Intervention"),
                                values = c(viridis::viridis(4, end = 0.8)[c(2, 4)], viridis::viridis(8, end = 0.8)[c(4, 8)]), # get 2 x 2 colors, close to each other
                                name = "", guide = guide_legend(override.aes = list(alpha = 1))) +
  ggridges::scale_colour_cyclical(values = viridis::viridis(4, end = 0.8, alpha = 0.9)[c(2, 4)]) +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom", axis.text=element_text(size=10)) +
  geom_hline(yintercept = 1:7)

PA_ci_intervention <- ci_intervention %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_intervention <- PA_ci_intervention[match(target, PA_ci_intervention$diamondlabels), ]

PA_ci_control <- ci_control %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_control <- PA_ci_control[match(target, PA_ci_control$diamondlabels), ]

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(PA_ci_intervention, returnLayerOnly = TRUE, color=viridis::viridis(4, end = 0.8)[c(4)],
              alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2)) +
  userfriendlyscience::diamondPlot(PA_ci_control, returnLayerOnly = TRUE, color=viridis::viridis(4, end = 0.8)[c(2)], 
              alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2))

plot1 + plot2
```

## PA psychosocial mediators

```{r densityplot-intention-oexp-pbc-se-opp-norms}

plot1 <- df %>% dplyr::select(id,
                              intervention,
                              group,
                              school,
                              girl,
                              'PA intention' = PA_intention_T1,
                              'PA outcome\nexpectations' = PA_outcomeExpectations_T1,
                              'PA perceived\nbehavioural control' = PA_pbc_T1,
                              'PA self efficacy' = PA_selfefficacy_T1,
                              'PA perceived\nopportunities' = PA_opportunities_T1,
                              'PA descriptive\nnorm' = PA_dnorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>%
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, colour = "black", 
                                    fill = paste(Variable, girl)), 
                                    alpha = 0.6, size = 0.25, 
                                    from = 1, to = 7, scale = 1) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("PA descriptive\nnorm boy", "PA descriptive\nnorm girl"),
                                labels = c( 'PA descriptive\nnorm boy' = "Boy", 'PA descriptive\nnorm girl' = "Girl"),
                                values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                name = "", guide = guide_legend(override.aes = list(alpha = 1))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom", axis.text=element_text(size=10))

target = c(
"PA_intention_T1",
"PA_outcomeExpectations_T1",
"PA_pbc_T1",
"PA_selfefficacy_T1",
"PA_opportunities_T1",
"PA_dnorm_T1")

PA_ci_girls <- ci_girls %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels))

PA_ci_girls <- PA_ci_girls[match(target, PA_ci_girls$diamondlabels), ]

PA_ci_boys <- ci_boys %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels))

PA_ci_boys <- PA_ci_boys[match(target, PA_ci_boys$diamondlabels), ]

plot1 <- plot1 + userfriendlyscience::diamondPlot(PA_ci_girls, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[3], 
                alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2)) +
  userfriendlyscience::diamondPlot(PA_ci_boys, returnLayerOnly = TRUE, lineColor = "black", linetype = "solid", color=viridis::viridis(4, end = 0.8)[1],  
                alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2))

plot2 <- df %>% dplyr::select(id,
                              intervention,
                              group,
                              school,
                              girl,
                              'PA intention' = PA_intention_T1,
                              'PA outcome\nexpectations' = PA_outcomeExpectations_T1,
                              'PA perceived\nbehavioural control' = PA_pbc_T1,
                              'PA self efficacy' = PA_selfefficacy_T1,
                              'PA perceived\nopportunities' = PA_opportunities_T1,
                              'PA descriptive\nnorm' = PA_dnorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>%
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value, colour = "black", 
                                    fill = paste(Variable, intervention)), 
                                    alpha = 0.75, size = 0.25, from = 1, to = 7, scale = 1) +
  labs(x = "",
       y = "") +
  scale_y_discrete(expand = c(0.01, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(breaks = c("PA descriptive\nnorm 0", "PA descriptive\nnorm 1"),
                                labels = c( 'PA descriptive\nnorm 0' = "Control", 'PA descriptive\nnorm 1' = "Intervention"),
                                values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                name = "", guide = guide_legend(override.aes = list(alpha = 1))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(legend.position="bottom", axis.text=element_text(size=10))

PA_ci_intervention <- ci_intervention %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels))

PA_ci_intervention <- PA_ci_intervention[match(target, PA_ci_intervention$diamondlabels), ]

PA_ci_control <- ci_control %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels))

PA_ci_control <- PA_ci_control[match(target, PA_ci_control$diamondlabels), ]

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(PA_ci_intervention, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[4],
              alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2)) +
  userfriendlyscience::diamondPlot(PA_ci_control, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[2], 
              alpha=.6, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2))

plot1 + plot2 

# Test that the legend is right; descriptive norms are smaller for girls
df %>% group_by(girl) %>% summarise(mean = mean(PA_dnorm_T1, na.rm = T)) %>% dplyr::filter(girl == "girl") %>% dplyr::select(mean) < df %>% group_by(girl) %>% summarise(mean = mean(PA_dnorm_T1, na.rm = T)) %>% dplyr::filter(girl == "boy") %>% dplyr::select(mean)

df %>% group_by(intervention) %>% summarise(mean = mean(PA_dnorm_T1, na.rm = TRUE)) %>% dplyr::filter(intervention == "1") %>% dplyr::select(mean) < df %>% group_by(intervention) %>% summarise(mean = mean(PA_dnorm_T1, na.rm = T)) %>% dplyr::filter(intervention == "0") %>% dplyr::select(mean)
```

```{r bct-determinants-showdata}

plot1 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'PA action and\ncoping planning' = PA_actCop_T1,
'PA intention' = PA_intention_T1,
'PA outcome\nexpectations' = PA_outcomeExpectations_T1,
'PA perceived\nbehavioural control' = PA_pbc_T1,
'PA self efficacy' = PA_selfefficacy_T1,
'PA perceived\nopportunities' = PA_opportunities_T1,
'PA descriptive\nnorm' = PA_dnorm_T1,
'PA injunctive\nnorm' = PA_inorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value,
                                    colour = "black",
                                    fill = paste(Variable, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl,
                                    point_size = girl,
                                    point_alpha = girl),
                                scale = .5, alpha = .6, size = 0.25,
                                from = 1, to = 7,
                                position = position_raincloud(width = 0.03, height = 0.5),
                                jittered_points = TRUE,
                                point_size = 1) + 
    labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                      labels = c('PA action and\ncoping planning boy' = "Boy", 'PA action and\ncoping planning girl' = "Girl"),
                      values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                      name = "", 
                      guide = guide_legend(override.aes = list(alpha = 1, 
                                                               point_shape = c(24, 25),
                                                               point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(24, 25),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_size", 
                                  values = c(.75, .75),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_alpha", 
                                  values = c(0.1, 0.1),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot2 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'PA action and\ncoping planning' = PA_actCop_T1,
'PA intention' = PA_intention_T1,
'PA outcome\nexpectations' = PA_outcomeExpectations_T1,
'PA perceived\nbehavioural control' = PA_pbc_T1,
'PA self efficacy' = PA_selfefficacy_T1,
'PA perceived\nopportunities' = PA_opportunities_T1,
'PA descriptive\nnorm' = PA_dnorm_T1,
'PA injunctive\nnorm' = PA_inorm_T1) %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.), factor_key = TRUE) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value,
                                    colour = "black",
                                    fill = paste(Variable, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention,
                                    point_size = intervention,
                                    point_alpha = intervention),
                                scale = .5, alpha = .6, size = 0.25,
                                from = 1, to = 7,
                                position = position_raincloud(width = 0.03, height = 0.5),
                                jittered_points = TRUE,
                                point_size = 1) + 
    labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.01, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                      labels = c('PA action and\ncoping planning 0' = "Control", 'PA action and\ncoping planning 1' = "intervention"),
                      values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                      name = "", 
                      guide = guide_legend(override.aes = list(alpha = 1, 
                                                               point_shape = c(21, 22),
                                                               point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(21, 22),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_size", 
                                  values = c(.75, .75),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_alpha", 
                                  values = c(0.1, 0.1),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

target = c("PA_actCop_T1",
"PA_intention_T1",
"PA_outcomeExpectations_T1",
"PA_pbc_T1",
"PA_selfefficacy_T1",
"PA_opportunities_T1",
"PA_dnorm_T1",
"PA_inorm_T1")

PA_ci_girls <- ci_girls %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_actCop_T1", diamondlabels) | 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_girls <- PA_ci_girls[match(target, PA_ci_girls$diamondlabels), ]

PA_ci_boys <- ci_boys %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_actCop_T1", diamondlabels) | 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_boys <- PA_ci_boys[match(target, PA_ci_boys$diamondlabels), ]

plot1 <- plot1 + 
  userfriendlyscience::diamondPlot(PA_ci_girls, returnLayerOnly = TRUE, linecolor = "black", color=viridis::viridis(4, end = 0.8)[1],# 'blue', 
                alpha=.95, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2)) +
  userfriendlyscience::diamondPlot(PA_ci_boys, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[3], #'green', 
                alpha=.95, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2))

PA_ci_intervention <- ci_intervention %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_actCop_T1", diamondlabels) | 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_intervention <- PA_ci_intervention[match(target, PA_ci_intervention$diamondlabels), ]

PA_ci_control <- ci_control %>% dplyr::filter(diamondlabels %in% names(scales_T1) & 
                                     grepl("PA_actCop_T1", diamondlabels) | 
                                     grepl("PA_intention_T1", diamondlabels) | 
                                     grepl("PA_outcomeExpectations_T1", diamondlabels) | 
                                     grepl("PA_pbc_T1", diamondlabels) | 
                                     grepl("PA_selfefficacy_T1", diamondlabels) | 
                                     grepl("PA_opportunities_T1", diamondlabels) | 
                                     grepl("PA_dnorm_T1", diamondlabels) | 
                                     grepl("PA_inorm_T1", diamondlabels))

PA_ci_control <- PA_ci_control[match(target, PA_ci_control$diamondlabels), ]

plot2 <- plot2 + 
  userfriendlyscience::diamondPlot(PA_ci_intervention, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[4],# 'blue',
              alpha=.95, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2)) +
  userfriendlyscience::diamondPlot(PA_ci_control, returnLayerOnly = TRUE, lineColor = "black", color=viridis::viridis(4, end = 0.8)[2], #'red', 
              alpha=.95, fixedSize = 0.15, otherAxisCol = (1:length(target) + .2))

plot1 + plot2
```

## SB determinants

```{r sb-determinants}

# Draw plot with gender densities

plot1 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'SB intention' = SB_intention_T1,
'SB outcome\nexpectations' = SB_outcomeExpectations_T1,
'SB self-efficacy\nand perceived\nbehavioural control' = SB_sePbc_T1,
'SB descriptive\nnorm' = SB_dnorm_T1,
'SB injunctive\nnorm' = SB_inorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value,
                                    colour = "black",
                                    fill = paste(Variable, girl),
                                    point_color = girl,
                                    point_fill = girl,
                                    point_shape = girl,
                                    point_size = girl,
                                    point_alpha = girl),
                                scale = .5, alpha = .6, size = 0.25,
                                from = 1, to = 7,
                                position = position_raincloud(width = 0.03, height = 0.5),
                                jittered_points = TRUE,
                                point_size = 1) + 
    labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                      labels = c('SB descriptive\nnorm boy' = "Boy", 'SB descriptive\nnorm girl' = "Girl"),
                      values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                      name = "", 
                      guide = guide_legend(override.aes = list(alpha = 1, 
                                                               point_shape = c(24, 25),
                                                               point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(1, 3)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(24, 25),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_size", 
                                  values = c(.75, .75),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_alpha", 
                                  values = c(0.1, 0.1),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot2 <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
'SB intention' = SB_intention_T1,
'SB outcome\nexpectations' = SB_outcomeExpectations_T1,
'SB self-efficacy\nand perceived\nbehavioural control' = SB_sePbc_T1,
'SB descriptive\nnorm' = SB_dnorm_T1,
'SB injunctive\nnorm' = SB_inorm_T1)  %>%
  # dplyr::select(noquote(order(colnames(.)))) %>% # Orders columns alphabetically
  tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>% 
  ggplot2::ggplot(aes(y = Variable)) +
  ggridges::geom_density_ridges(aes(x = Value,
                                    colour = "black",
                                    fill = paste(Variable, intervention),
                                    point_color = intervention,
                                    point_fill = intervention,
                                    point_shape = intervention,
                                    point_size = intervention,
                                    point_alpha = intervention),
                                scale = .5, alpha = .6, size = 0.25,
                                from = 1, to = 7,
                                position = position_raincloud(width = 0.03, height = 0.5),
                                jittered_points = TRUE,
                                point_size = 1) + 
    labs(x = NULL,
       y = NULL) +
  scale_y_discrete(expand = c(0.01, 0), labels = NULL) +
  scale_x_continuous(expand = c(0.01, 0)) +
  ggridges::scale_fill_cyclical(
                      labels = c('SB descriptive\nnorm 0' = "Control", 'SB descriptive\nnorm 1' = "intervention"),
                      values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                      name = "", 
                      guide = guide_legend(override.aes = list(alpha = 1, 
                                                               point_shape = c(21, 22),
                                                               point_size = 2))) +
  ggridges::scale_colour_cyclical(values = "black") +
  ggridges::theme_ridges(grid = FALSE) +
  ggridges::scale_discrete_manual(aesthetics = "point_color", 
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_fill",
                                  values = viridis::viridis(4, end = 0.8)[c(2, 4)],
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_shape", 
                                  values = c(21, 22),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_size", 
                                  values = c(.75, .75),
                                  guide = "none") +
  ggridges::scale_discrete_manual(aesthetics = "point_alpha", 
                                  values = c(0.1, 0.1),
                                  guide = "none") +
  papaja::theme_apa() +
  theme(legend.position = "bottom")

plot1 + plot2
```

# Informativeness of averages

```{r average-coverage}

# total_n <- df %>% select(paAccelerometer_T1, sitLieAccelerometer_T1, padaysLastweek_T1, sitBreaks_T1) %>% 
#   na.omit(.) %>% 
#   summarise(n = n())
                     
middle_x_percentile <- function(middle_percentile) {
  df %>%
  dplyr::filter((df$paAccelerometer_T1 > quantile(df$paAccelerometer_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[1]]) &
                  (df$paAccelerometer_T1 < quantile(df$paAccelerometer_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[2]]) &
                (df$sitLieAccelerometer_T1 > quantile(df$sitLieAccelerometer_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[1]]) &
                 (df$sitLieAccelerometer_T1 < quantile(df$sitLieAccelerometer_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[2]]) & 
                (df$padaysLastweek_T1 > quantile(df$padaysLastweek_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[1]]) &
                  (df$padaysLastweek_T1 < quantile(df$padaysLastweek_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[2]]) &
                (df$sitBreaks_T1 > quantile(df$sitBreaks_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[1]]) &
                  (df$sitBreaks_T1 < quantile(df$sitBreaks_T1, probs = c(0.5 - middle_percentile/2, 0.5 + middle_percentile/2), na.rm = TRUE)[[2]])) %>% 
    nrow(.)
}
  

getmiddle <- function(middlePerc) {                                       
df %>% dplyr::select(paAccelerometer_T1, padaysLastweek_T1, sitLieAccelerometer_T1, sitBreaks_T1) %>% 
  na.omit(.) %>% 
  dplyr::summarise(n = n(), 
                   middle = sum((paAccelerometer_T1 > 
                                       (quantile(paAccelerometer_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[1]])) & 
                                      (paAccelerometer_T1 < 
                                       (quantile(paAccelerometer_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[2]])) &
                                      (padaysLastweek_T1 > 
                                       (quantile(padaysLastweek_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[1]])) & 
                                      (padaysLastweek_T1 < 
                                       (quantile(padaysLastweek_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[2]])) &
                                      (sitLieAccelerometer_T1 > 
                                       (quantile(sitLieAccelerometer_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[1]])) & 
                                      (sitLieAccelerometer_T1 < 
                                       (quantile(sitLieAccelerometer_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[2]])) &
                                      (sitBreaks_T1 > 
                                       (quantile(sitBreaks_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[1]])) & 
                                      (sitBreaks_T1 < 
                                       (quantile(sitBreaks_T1, probs = c(0.5 - middlePerc/2, 0.5 + middlePerc/2))[[2]]))
                                     )) %>% 
    mutate(perc = middle/n)
}


middleprobs <- function(prob1, prob2) {
sum(df$paAccelerometer_T1 >= quantile(df$paAccelerometer_T1, probs = c(prob1, prob2), na.rm = TRUE)[[1]] &
      df$paAccelerometer_T1 <= quantile(df$paAccelerometer_T1, probs = c(prob1, prob2), na.rm = TRUE)[[2]] &
    df$padaysLastweek_T1 >= quantile(df$padaysLastweek_T1, probs = c(prob1, prob2), na.rm = TRUE)[[1]] &
      df$padaysLastweek_T1 <= quantile(df$padaysLastweek_T1, probs = c(prob1, prob2), na.rm = TRUE)[[2]] &
    df$sitLieAccelerometer_T1 >= quantile(df$sitLieAccelerometer_T1, probs = c(prob1, prob2), na.rm = TRUE)[[1]] &
      df$sitLieAccelerometer_T1 <= quantile(df$sitLieAccelerometer_T1, probs = c(prob1, prob2), na.rm = TRUE)[[2]] &
    df$sitBreaks_T1 >= quantile(df$sitBreaks_T1, probs = c(prob1, prob2), na.rm = TRUE)[[1]] &
      df$sitBreaks_T1 <= quantile(df$sitBreaks_T1, probs = c(prob1, prob2), na.rm = TRUE)[[2]],
    na.rm= TRUE) 
}    

# # How to use these functions:
# middleprobs(1/3, 2/3) 
# middle_x_percentile(1/3)
# getmiddle(1/3)

# # the gettmiddle function doesn't work like the others. Because it omits na from the start?

# # middle_x_percentile(1) gives a number != total, because it's exclusive of the ends. See difference between

# sum(df$paAccelerometer_T1 >= min(df$paAccelerometer_T1, na.rm = TRUE) &
#       df$paAccelerometer_T1 <= max(df$paAccelerometer_T1, na.rm = TRUE) &
#     df$padaysLastweek_T1 >= min(df$padaysLastweek_T1, na.rm = TRUE) &
#       df$padaysLastweek_T1 <= max(df$padaysLastweek_T1, na.rm = TRUE) &
#     df$sitLieAccelerometer_T1 >= min(df$sitLieAccelerometer_T1, na.rm = TRUE) &
#       df$sitLieAccelerometer_T1 <= max(df$sitLieAccelerometer_T1, na.rm = TRUE) &
#     df$sitBreaks_T1 >= min(df$sitBreaks_T1, na.rm = TRUE) &
#       df$sitBreaks_T1 <= max(df$sitBreaks_T1, na.rm = TRUE),
#     na.rm= TRUE) 

# # and

# sum(df$paAccelerometer_T1 > min(df$paAccelerometer_T1, na.rm = TRUE) &
#       df$paAccelerometer_T1 < max(df$paAccelerometer_T1, na.rm = TRUE) &
#     df$padaysLastweek_T1 > min(df$padaysLastweek_T1, na.rm = TRUE) &
#       df$padaysLastweek_T1 < max(df$padaysLastweek_T1, na.rm = TRUE) &
#     df$sitLieAccelerometer_T1 > min(df$sitLieAccelerometer_T1, na.rm = TRUE) &
#       df$sitLieAccelerometer_T1 < max(df$sitLieAccelerometer_T1, na.rm = TRUE) &
#     df$sitBreaks_T1 > min(df$sitBreaks_T1, na.rm = TRUE) &
#       df$sitBreaks_T1 < max(df$sitBreaks_T1, na.rm = TRUE),
#     na.rm= TRUE) 

middle_df <- NA
  
for(i in 1:100) {
middle_df[i] <- middleprobs(0.5 - i/2/100, 0.5 + i/2/100) / 706   
}

meansplot_df <- data.frame(middle_band_width_perc = 1:100, perc_of_participants_included = middle_df)

meansplot_df %>% 
  ggplot(aes(y = 100 * perc_of_participants_included, x = middle_band_width_perc)) +
  geom_line() +
  labs(title = "The Stereotypical Participant?", 
       y = "% of participants included", 
       x = "Middle x percent (width of band around the median on all primary outcome variables)") +
  scale_y_continuous(breaks = seq(0, 100, by = 10)) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  geom_ribbon(aes(ymin = 0, ymax = 100 * perc_of_participants_included), fill="blue", alpha="0.5") +
  theme_light()

# # This makes an inferior plot:
#
# middle_df2 <- NA
# 
# for(i in 1:100) {
# middle_df2[i] <- middleprobs(0.5 - i/2/100, 0.5 + i/2/100) / 706   
# }
# 
# meansplot_df2 <- data.frame(middle_band_width_perc = c(1:100), hi = 0.5 + middle_df2/2, lo = 0.5 - middle_df2/2)
# 
# meansplot_df <- data.frame(middle_band_width_perc = 1:100, perc_of_participants_included = middle_df)
#
# meansplot_df2 %>% 
#   ggplot(aes(y = 100 * hi, x = middle_band_width_perc)) +
#   geom_line() +
#   # geom_line(aes(y = 100 * lo, x = middle_band_width_perc)) +
#   labs(title = "The Stereotypical Participant?", 
#        y = "% of participants covered", 
#        x = "Definition of average (\"middle x percent\", or \"width of band around the median on all the variables\")") +
#   # geom_ribbon(aes(ymin = 0, ymax = 100 * hi), fill="blue", alpha="0.5") +
#   scale_y_continuous(breaks = seq(0, 100, by = 10)) +
#   scale_x_continuous(breaks = seq(0, 100, by = 10)) +
#   theme_light()
```

`r ((middleprobs(0.35, 0.65) / 706) %>% round(., 3) * 100)` percent of participants fell in the middle 30% of all four outcome variables. 

# Types of self-reported exercise

This section describes the proportions of participants reporting they did a certain type of activity during the last month.

```{r exerciseTypes, results = "asis"}

exerciseTypes_df <- lmi %>% select(Kys0051.1:Kys0064.1) %>% 
  dplyr::select(contains(".1"))
exerciseTypes_df$track <- df$track
exerciseTypes_df$girl <- df$girl

names(exerciseTypes_df) <- c("Team ball games", 
                             "Other ball games",
                             "Gym training",
                             "Combat sports",
                             "Fitness classes",
                             "Home workout",
                             "Cycling",
                             "Swimming",
                             "Walking",
                             "Running",
                             "Skiing",
                             "Roller skating",
                             "Horseback riding",
                             "Other",
                             "track",
                             "girl"
                             )

# For educational tracks

exerciseTypes_proportions <- exerciseTypes_df %>%
  dplyr::filter(!is.na(track), track != "Other") %>% 
  dplyr::mutate_at(vars(`Team ball games`:`Other`), funs(replace_na(., 0))) %>% # replace NA's with 0
  dplyr::group_by(track) %>% 
  dplyr::summarise_at(vars(`Team ball games`:`Other`), funs(mean(., na.rm = TRUE)))

exerciseTypes_cases <- exerciseTypes_df %>%
  dplyr::filter(!is.na(track), track != "Other") %>% 
  dplyr::mutate_at(vars(`Team ball games`:`Other`), funs(replace_na(., 0))) %>% # replace NA's with 0
  dplyr::group_by(track) %>% 
  dplyr::summarise_at(vars(`Team ball games`:`Other`), sum) 

exerciseTypes_totals <- exerciseTypes_df %>%
  dplyr::filter(!is.na(track), track != "Other") %>% 
  dplyr::mutate_at(vars(`Team ball games`:`Other`), funs(replace_na(., 0))) %>% # replace NA's with 0
  dplyr::group_by(track) %>% 
  dplyr::summarise_at(vars(`Team ball games`:`Other`), funs(sum(!is.na(.))))

exerciseTypes_pvals <- NA # Empty vector to be filled

for (i in (2:15)) {
exerciseTypes_test <- data.frame(exerciseTypes_cases[ , i], exerciseTypes_totals[ , i])
exerciseTypes_pvals[i-1] <- prop.test(exerciseTypes_test[, 1], exerciseTypes_test[, 2])$p.value %>% round(., 5)
}

data.frame("Exercise type" = names(exerciseTypes_df)[1:14], "p-values: educational tracks" = exerciseTypes_pvals) %>% 
  papaja::apa_table()

exerciseTypes_proportions %>% 
  papaja::apa_table()

# For girls and boys

exerciseTypes_girlboy_proportions <- exerciseTypes_df %>%
  dplyr::filter(!is.na(girl)) %>% 
  dplyr::mutate_at(vars(`Team ball games`:`Other`), funs(replace_na(., 0))) %>% # replace NA's with 0
  dplyr::group_by(girl) %>% 
  dplyr::summarise_at(vars(`Team ball games`:`Other`), funs(mean(., na.rm = TRUE))) 

exerciseTypes_girlboy_cases <- exerciseTypes_df %>%
  dplyr::filter(!is.na(girl)) %>% 
  dplyr::mutate_at(vars(`Team ball games`:`Other`), funs(replace_na(., 0))) %>% # replace NA's with 0
  dplyr::group_by(girl) %>% 
  dplyr::summarise_at(vars(`Team ball games`:`Other`), sum)

exerciseTypes_girlboy_totals <- exerciseTypes_df %>%
  dplyr::filter(!is.na(girl)) %>% 
  dplyr::mutate_at(vars(`Team ball games`:`Other`), funs(replace_na(., 0))) %>% # replace NA's with 0
  dplyr::group_by(girl) %>% 
  dplyr::summarise_at(vars(`Team ball games`:`Other`), funs(sum(!is.na(.))))

exerciseTypes_girlboy_pvals <- NA # Empty vector to be filled

for (i in (2:15)) {
exerciseTypes_girlboy_test <- data.frame(exerciseTypes_girlboy_cases[ , i], exerciseTypes_girlboy_totals[ , i])
exerciseTypes_girlboy_pvals[i-1] <- prop.test(exerciseTypes_girlboy_test[, 1], exerciseTypes_girlboy_test[, 2])$p.value %>% round(., 5)
}

data.frame("Exercise type" = names(exerciseTypes_girlboy_cases)[2:15], "p-values: boys vs. girls" = exerciseTypes_girlboy_pvals)  %>% 
  papaja::apa_table()

exerciseTypes_girlboy_proportions %>% 
  papaja::apa_table()

```


CIBER (not included for now)

```{r, eval = FALSE}
#p_install("userfriendlyscience")

# cat(names(df), sep = "\",\n\"")

# Make variables numeric, and d as data frame
d_num <- df %>% dplyr::mutate_all(as.numeric) 
d_num <- as.data.frame(d_num)

userfriendlyscience::CIBER(data = d_num,
      determinants = c(
        "actCop_T1",
        "agrbct_T1",
        "amotivation_T1",
        "autonomous_T1",
        "big5_agreeableness_T1.1",
        "big5_conscientiousness_T1.1",
        "big5_extraversion_T1.1",
        "big5_neuroticism_T1.1",
        "big5_openness_T1.1",
        "controlled_T1",
        "dnorm_T1",
        "frqbct_T1",
        "goal_T1",
        "inorm_T1",
        "intention_T1",
        "outcomeExpectations_T1",
        "opportunities_T1",
        "pbc_T1",
        "selfefficacy_T1"),
      targets = c("paT1", "fatpct_T1"),
      conf.level = list(means = 0.9999,
                        associations = 0.99)
      )

userfriendlyscience::CIBER(data = d_num,
      determinants = c(
        "actCop_T1",
        "agrbct_T1",
        "frqbct_T1",
        "amotivation_T1",
        "autonomous_T1",
        "controlled_T1",
        "dnorm_T1",
        "intention_T1",
        "outcomeExpectations_T1",
        "opportunities_T1",
        "sePbc_T1"),
      targets = c("paT1", "fatpct_T1"),
      conf.level = list(means = 0.9999,
                        associations = 0.99)
      )

# to create variable list for CIBER:
# cat(names(d), sep = "\",\n\"")

userfriendlyscience::CIBER(data = d_num,
  determinants = c(
  "agrbct_01_T1",
  "agrbct_02_T1",
  "agrbct_03_T1",
  "agrbct_04_T1",
  "agrbct_05_T1",
  "agrbct_06_T1",
  "agrbct_07_T1",
  "agrbct_08_T1",
  "agrbct_09_T1",
  "agrbct_10_T1",
  "frqbct_01_T1",
  "frqbct_02_T1",
  "frqbct_03_T1",
  "frqbct_04_T1",
  "frqbct_05_T1",
  "frqbct_06_T1",
  "frqbct_07_T1",
  "frqbct_08_T1",
  "frqbct_09_T1"),
   targets = c("MVPA", "SB"),
  leftAnchors = rep("", 19),
  rightAnchors = rep("", 19))

userfriendlyscience::CIBER(data = d_num,
  determinants = c(
  "autonomous_01_T1",
  "autonomous_02_T1",
  "autonomous_03_T1",
  "autonomous_04_T1",
  "autonomous_05_T1",
  "autonomous_06_T1",
  "autonomous_07_T1",
  "autonomous_08_T1",
  "autonomous_09_T1"),
   targets = c("MVPA", "SB"),
  leftAnchors = rep("", 9),
  rightAnchors = rep("", 9))

userfriendlyscience::CIBER(data = d_num,
  determinants = c(
  "intention_01_T1",
  "intention_02_T1",
  "selfefficacy_01_T1",
  "selfefficacy_02_T1",
  "pbc_01_T1",
  "pbc_02_T1",
  "pbc_03_T1",
  "norm_01_T1",
  "norm_02_T1",
  "outcomeExpectations_01_T1",
  "outcomeExpectations_02_T1",
  "outcomeExpectations_03_T1",
  "outcomeExpectations_04_T1",
  "outcomeExpectations_05_T1",
  "outcomeExpectations_06_T1",
  "outcomeExpectations_07_T1",
  "outcomeExpectations_08_T1",
  "outcomeExpectations_09_T1",
  "outcomeExpectations_10_T1",
  "outcomeExpectations_11_T1",
  "outcomeExpectations_12_T1"),
   targets = c("MVPA", "SB"),
  leftAnchors = rep("", 21),
  rightAnchors = rep("", 21))
```


# Symptoms

```{r sm-symptoms}


# Create data frame
densplot <- df
levels(densplot$intervention) <- c("Control", "Intervention")
levels(densplot$girl) <- recode(densplot$girl, "boy" = "Boys", "girl" = "Girls")

# This gives side-by-side plots. There's a third plot below the two, which is fake to include x-axis text.
layout(matrix(c(1, 2, 3, 3), nrow = 2, ncol = 2, byrow = TRUE),
       widths = c(0.5, 0.5),heights = c(0.45,0.05))

# Minimise whitespace; see https://stackoverflow.com/questions/15848942/how-to-reduce-space-gap-between-multiple-graphs-in-r
par(mai = c(0.3, 0.3, 0.1, 0.0)) 

## Girls vs. boys
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(symptom_T1, girl) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)

# Make plot
sm.symptom_T1_2 <- sm.density.compare2(as.numeric(dens$symptom_T1), 
                                               as.factor(dens$girl), 
                                               model = "equal",
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end  =  0.8)[c(3, 1)], 
                                               lty = c(1, 3), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(1, 4))
legend("topright", levels(dens$girl), col = viridis::viridis(4, end = 0.8)[c(1, 3)], lty = c(3,1), lwd = (c(2,2)))
mtext(side = 2, "Density", line = 0.5)

## Intervention vs. control
# Choose only the variables needed and drop NA
dens <- densplot %>% dplyr::select(symptom_T1, intervention) %>% 
  dplyr::filter(complete.cases(.))

# Set random number generator for reproducibility of bootstrap test of equal densities
set.seed(10)
# Make plot
sm.symptom_T1_2 <- sm.density.compare2(as.numeric(dens$symptom_T1), 
                                               as.factor(dens$intervention), 
                                               model = "equal", 
                                               xlab = "", ylab = "",
                                               col = viridis::viridis(4, end = 0.8)[c(2, 4)], 
                                               lty = c(3, 1), yaxt = "n",
                                               bandcol = 'LightGray', 
                                               lwd = c(2, 2),
                                               xlim = c(1, 4))
legend("topright", levels(dens$intervention), col = viridis::viridis(4, end = 0.8)[c(2, 4)], lty=c(3,1), lwd=(c(2,2)))

# Create x-axis label. See https://stackoverflow.com/questions/11198767/how-to-annotate-across-or-between-plots-in-multi-plot-panels-in-r
par(mar = c(0,0,0,0)) 
plot(1, 1, type = "n", frame.plot = FALSE,axes = FALSE) # Fake plot
text(x = 1.02, y = 1.3, labels = "Symptom sumscore mean", pos = 1)


```

## Symptom histograms

### intervention / gender

```{r symptom-histogram-ivgender}

sympGirls <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(girl == "girl") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c("darkolivegreen2", "darkolivegreen4")) +
  labs(title = "Girls") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10, face="bold")) +
coord_cartesian(xlim = c(0.5, 4.5))

sympBoys <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(girl == "boy") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c("darkolivegreen2", "darkolivegreen4")) +
  labs(title = "Boys") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10, face="bold")) +
coord_cartesian(xlim = c(0.5, 4.5))

sympInt <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(intervention == "1") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "") +
  ggridges::scale_fill_cyclical(values = c("deepskyblue", "deepskyblue4")) +
  labs(title = "Intervention") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
coord_cartesian(xlim = c(0.5, 4.5))

sympCont <- df %>% dplyr::select(id,
  intervention,
  group,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(intervention == "0") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c("deepskyblue", "deepskyblue4")) +
  labs(title = "Control") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10, face="bold")) +
coord_cartesian(xlim = c(0.5, 4.5))

#grid.arrange(sympInt, sympGirls, sympCont, sympBoys, ncol = 2)

# ("Seldom or never", "About once a month", "About once a week", "Almost daily")

# This draws all histograms next to each other:
grid::grid.newpage()
grid::grid.draw(cbind(ggplot2::ggplotGrob(sympInt), ggplot2::ggplotGrob(sympCont), ggplot2::ggplotGrob(sympGirls), ggplot2::ggplotGrob(sympBoys), size = "last"))

# This draws 2 histograms per row:
#grid.newpage()
#grid.draw(rbind(cbind(ggplot2::ggplotGrob(sympInt), ggplot2::ggplotGrob(sympCont), size = "last"), cbind(ggplot2::ggplotGrob(sympGirls), ggplot2::ggplotGrob(sympBoys), size = "last")))


```

### educational track

```{r symptom-histogram-edutracks}
trackColors <- viridis::viridis(13)

sympHRC <- df %>% dplyr::select(id,
  intervention,
  track,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(track == "HRC") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = trackColors[4:5]) +
  labs(title = "HRC") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 4.5))

sympNur <- df %>% dplyr::select(id,
  intervention,
  track,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(track == "Nur") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "") +
  ggridges::scale_fill_cyclical(values = c(values = trackColors[1:2])) +
  labs(title = "Nur") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 4.5))

sympIT <- df %>% dplyr::select(id,
  intervention,
  track,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(track == "IT") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c(values = trackColors[12:13])) +
  labs(title = "IT") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 4.5))

sympBA <- df %>% dplyr::select(id,
  intervention,
  track,
  school,
  girl,
  "Neck and shoulder pain" = symptom_neckShoulderPain_T1,
  "Lower back pain" = symptom_lowerBackPain_T1,
  "Stomach ache" = symptom_stomachAche_T1,
  "Tension or nervousness" = symptom_tensionNervousness_T1,
  "Irritability or anger bursts" = symptom_irritabilityAngerbursts_T1,
  "Difficulty with sleep" = symptom_sleepDifficulty_T1,
  "Headache" = symptom_headAche_T1,
  "Tiredness or faintness" = symptom_tirednessFaintness_T1) %>%
 tidyr::gather(key = Variable, value = Value, 6:ncol(.)) %>%
  dplyr::filter(track == "BA") %>% 
 ggplot2::ggplot(aes(x = Value, y = Variable, group = Variable)) +
  ggridges::geom_density_ridges2(aes(fill = Variable), stat = "binline", binwidth = 1, scale = 0.95) +
  scale_x_continuous(breaks = c(1:4), expand = c(0, 0),
                     name = "") +
  scale_y_discrete(expand = c(0.01, 0), name = "", labels = NULL) +
  ggridges::scale_fill_cyclical(values = c(values = trackColors[8:9])) +
  labs(title = "BA") +
  guides(y = "none") +
  ggridges::theme_ridges(grid = FALSE) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 10),
        axis.text=element_text(size=10)) +
  coord_cartesian(xlim = c(0.5, 4.5))

#grid.arrange(sympIT, sympHRC, sympBA, sympNur, ncol = 2)

# ("Seldom or never", "About once a month", "About once a week", "Almost daily")

# This draws all histograms next to each other:
# grid::grid.newpage()
# grid::grid.draw(cbind(ggplot2::ggplotGrob(sympIT), ggplot2::ggplotGrob(sympBA), ggplot2::ggplotGrob(sympHRC), ggplot2::ggplotGrob(sympNur), size = "last"))

# This draws 2 histograms per row:
#grid.newpage()
#grid.draw(rbind(cbind(ggplot2::ggplotGrob(sympIT), ggplot2::ggplotGrob(sympBA), size = "last"), cbind(ggplot2::ggplotGrob(sympHRC), ggplot2::ggplotGrob(sympNur), size = "last")))

(sympNur | sympHRC | sympBA | sympIT)

```

